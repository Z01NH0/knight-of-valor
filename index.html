<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knight of Valor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'MedievalSharp', cursive, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #f8c555;
            text-shadow: 0 0 10px rgba(248, 197, 85, 0.5);
            letter-spacing: 3px;
            font-weight: bold;
        }
        
        .game-board {
            position: relative;
            width: 100%;
            height: 700px;
            border: 4px solid #f8c555;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background: #0f3460;
        }
        
        canvas {
            display: block;
        }
        
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid #f8c555;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            width: 60px;
            font-weight: bold;
            color: #f8c555;
        }
        
        .bar-container {
            flex: 1;
            height: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(248, 197, 85, 0.3);
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .health-bar {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }
        
        .mana-bar {
            background: linear-gradient(90deg, #3498db, #9b59b6);
        }
        
        .stamina-bar {
            background: linear-gradient(90deg, #2ecc71, #f1c40f);
        }
        
        .exp-bar {
            background: linear-gradient(90deg, #9b59b6, #e74c3c);
        }
        
        .money-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .inventory-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid #f8c555;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .inventory-btn:hover {
            background: rgba(248, 197, 85, 0.2);
            transform: scale(1.1);
        }
        
        .battle-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        
        .battle-container {
            width: 95%;
            height: 95%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .battle-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(248, 197, 85, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(52, 152, 219, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .battle-scene {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
            position: relative;
            margin: 20px 0;
        }
        
        .battle-character {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .character-canvas {
            width: 250px;
            height: 250px;
            margin-bottom: 10px;
        }
        
        .battle-stats {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .player-stats, .enemy-stats {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 200px;
            border: 2px solid #f8c555;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .player-stats h3, .enemy-stats h3 {
            color: #f8c555;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 5px;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 0.9rem;
        }
        
        .round-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #f8c555;
            font-weight: bold;
        }
        
        .battle-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-btn:hover {
            background: linear-gradient(to bottom, #bdc3c7, #95a5a6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .battle-btn {
            background: linear-gradient(to bottom, #f8c555, #d4a017);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .battle-btn:hover {
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        
        .battle-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .battle-log {
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            overflow-y: auto;
            font-size: 0.9rem;
            border: 2px solid rgba(248, 197, 85, 0.3);
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .attack-options, .magic-options, .items-options, .act-options {
            display: none;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            position: relative;
        }
        
        .inventory-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(5px);
        }
        
        .inventory-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .close-btn {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: linear-gradient(to bottom, #ff6b6b, #e74c3c);
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .upgrade-points {
            margin: 10px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .upgrade-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upgrade-btn:hover {
            background: linear-gradient(to bottom, #58d68d, #2ecc71);
            transform: scale(1.1);
        }
        
        .upgrade-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .crafting-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .crafting-title {
            text-align: center;
            margin-bottom: 15px;
            color: #f8c555;
        }
        
        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 150px;
            margin: 0 auto 15px;
        }
        
        .crafting-slot {
            width: 40px;
            height: 40px;
            border: 2px solid #f8c555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .crafting-result {
            width: 60px;
            height: 60px;
            border: 3px solid #f8c555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            font-size: 1.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .crafting-ready {
            border-color: #e74c3c;
            box-shadow: 0 0 15px #e74c3c;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px #e74c3c; }
            50% { box-shadow: 0 0 20px #e74c3c; }
            100% { box-shadow: 0 0 5px #e74c3c; }
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-slot {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
            text-align: center;
        }
        
        .item-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .instructions {
            margin-top: 15px;
            text-align: center;
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .status-effects {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .status-effect {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .burn { background: rgba(231, 76, 60, 0.7); }
        .slow { background: rgba(52, 152, 219, 0.7); }
        .stun { background: rgba(155, 89, 182, 0.7); }
        .strength-potion { background: rgba(230, 126, 34, 0.7); }
        .heavy-armor { background: rgba(149, 165, 166, 0.7); }
        .luck-potion { background: rgba(241, 196, 15, 0.7); }
        
        .shop-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            backdrop-filter: blur(5px);
        }
        
        .shop-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .shop-categories {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .shop-category {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .shop-category.active {
            background: rgba(248, 197, 85, 0.2);
            border-color: #f8c555;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .shop-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .shop-item-price {
            color: #f8c555;
            margin-bottom: 10px;
        }
        
        .shop-buy-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .shop-buy-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #58d68d, #2ecc71);
        }
        
        .shop-buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .equipment-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 25;
            backdrop-filter: blur(5px);
        }
        
        .equipment-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .equipment-slot {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
            min-height: 150px;
        }
        
        .equipment-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .equipment-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .equipment-stats {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .equipment-btn {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .equipment-btn:hover {
            background: linear-gradient(to bottom, #5dade2, #3498db);
        }
        
        .inventory-btn-equipment {
            background: linear-gradient(to bottom, #f8c555, #d4a017);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 2px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            margin-top: 10px;
        }
        
        .inventory-btn-equipment:hover {
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        
        .equipment-collection {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .collection-title {
            text-align: center;
            margin-bottom: 15px;
            color: #f8c555;
        }
        
        .collection-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .collection-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .collection-item:hover {
            background: rgba(248, 197, 85, 0.1);
        }
        
        .collection-item.equipped {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }
        
        .collection-item-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .game-board {
                height: 500px;
            }
            
            .battle-container {
                width: 95%;
                height: 95%;
            }
            
            .battle-stats {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .player-stats, .enemy-stats {
                min-width: 90%;
            }
            
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .shop-items {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .collection-items {
                grid-template-columns: 1fr;
            }
        }
        
        .battle-effect {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        .damage-text {
            position: absolute;
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        .status-text {
            position: absolute;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        
        .burn-text { color: #ff6b6b; }
        .slow-text { color: #74b9ff; }
        .stun-text { color: #a29bfe; }
        .strength-text { color: #f39c12; }
        .heavy-armor-text { color: #bdc3c7; }
        .luck-text { color: #f1c40f; }
        
        .death-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: #e74c3c;
            font-size: 3rem;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        .recipe-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .recipe-item:hover {
            background: rgba(248, 197, 85, 0.1);
        }
        
        .recipe-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .recipe-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .recipe-description {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            right: 70px;
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid #f8c555;
            border-radius: 8px;
            padding: 5px 10px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .notification-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(5px);
        }
        
        .notification-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 30px;
            width: 60%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .notification-title {
            color: #f8c555;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .notification-message {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dark-shop-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 35;
            backdrop-filter: blur(5px);
        }
        
        .dark-shop-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230f0f23"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23e74c3c" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #e74c3c;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.3);
        }
        
        .dark-shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(231, 76, 60, 0.3);
            padding-bottom: 10px;
        }
        
        .dark-shop-categories {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .dark-shop-category {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .dark-shop-category.active {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
        }
        
        .dark-shop-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .dark-shop-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .dark-shop-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .dark-shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .dark-shop-item-price {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .dark-shop-buy-btn {
            background: linear-gradient(to bottom, #8e44ad, #6c3483);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .dark-shop-buy-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
        }
        
        .dark-shop-buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .battle-effects-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .effect {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        .sword-slash {
            width: 100px;
            height: 20px;
            background: linear-gradient(90deg, transparent, #f8c555, transparent);
            transform-origin: 0 50%;
            animation: slash 0.3s forwards;
        }
        
        @keyframes slash {
            0% { transform: scaleX(0) rotate(0deg); opacity: 1; }
            100% { transform: scaleX(1) rotate(45deg); opacity: 0; }
        }
        
        .fireball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff6b6b, #e74c3c);
            animation: fireballMove 0.5s forwards;
        }
        
        @keyframes fireballMove {
            0% { transform: translateX(0) scale(0.5); opacity: 1; }
            100% { transform: translateX(200px) scale(1.5); opacity: 0; }
        }
        
        .freeze {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #74b9ff, #3498db);
            animation: freezeExpand 0.7s forwards;
        }
        
        @keyframes freezeExpand {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .possession {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #a29bfe, #6c5ce7);
            animation: possessionPulse 0.8s forwards;
        }
        
        @keyframes possessionPulse {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .charge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #f39c12, #d35400);
            animation: chargeMove 0.6s forwards;
        }
        
        @keyframes chargeMove {
            0% { transform: translateX(0) scale(0.8); opacity: 1; }
            100% { transform: translateX(150px) scale(1.2); opacity: 0; }
        }
        
        .dark-magic {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, #8e44ad, #6c3483);
            animation: darkMagicMove 0.5s forwards;
        }
        
        @keyframes darkMagicMove {
            0% { transform: translateX(0) scale(0.7); opacity: 1; }
            100% { transform: translateX(-200px) scale(1.3); opacity: 0; }
        }
        
        .dark-heal {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #9b59b6, #8e44ad);
            animation: darkHealPulse 0.7s forwards;
        }
        
        @keyframes darkHealPulse {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .dragon-fire {
            width: 120px;
            height: 60px;
            background: linear-gradient(90deg, #ff6b6b, #f39c12, #ff6b6b);
            border-radius: 30px;
            animation: dragonFire 0.8s forwards;
        }
        
        @keyframes dragonFire {
            0% { transform: scaleX(0); opacity: 1; }
            100% { transform: scaleX(1.5); opacity: 0; }
        }
        
        /* Novos estilos para melhorias */
        .level-up-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f8c555, #d4a017);
            color: #1a1a2e;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.7);
            animation: levelUpPulse 2s ease-out;
        }
        
        @keyframes levelUpPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .victory-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 25px 50px;
            border-radius: 20px;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 40px rgba(46, 204, 113, 0.7);
            animation: victoryPulse 3s ease-out;
        }
        
        @keyframes victoryPulse {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .battle-ui-pokemon {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .battle-top {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .battle-bottom {
            height: 180px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .battle-dialog {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .battle-actions-pokemon {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            height: 80px;
        }
        
        .battle-action-btn {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'MedievalSharp', cursive;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .battle-action-btn:hover {
            background: linear-gradient(to bottom, #5dade2, #3498db);
            transform: translateY(-2px);
        }
        
        .battle-action-btn:active {
            transform: translateY(0);
        }
        
        .battle-submenu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            height: 80px;
        }
        
        .recipe-visual {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 150px;
            margin: 10px auto;
        }
        
        .recipe-slot {
            width: 40px;
            height: 40px;
            border: 2px solid #f8c555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
        }
        
        .equipment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .weapons-column, .armors-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .equipment-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(248, 197, 85, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .equipment-item:hover {
            background: rgba(248, 197, 85, 0.1);
        }
        
        .equipment-item.equipped {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }
        
        .equipment-item-icon {
            font-size: 2.5rem;
        }
        
        .equipment-item-info {
            flex: 1;
        }
        
        .equipment-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .equipment-item-stats {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .start-title {
            font-size: 4rem;
            color: #f8c555;
            text-shadow: 0 0 10px rgba(248, 197, 85, 0.5);
            margin-bottom: 30px;
            animation: titleGlow 2s infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 10px rgba(248, 197, 85, 0.5); }
            100% { text-shadow: 0 0 20px rgba(248, 197, 85, 0.8), 0 0 30px rgba(248, 197, 85, 0.6); }
        }
        
        .start-message {
            font-size: 1.5rem;
            color: #ecf0f1;
            text-align: center;
            max-width: 600px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .loading-bar {
            width: 300px;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #f8c555, #d4a017);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .start-btn {
            background: linear-gradient(to bottom, #f8c555, #d4a017);
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .start-btn:hover {
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        
        .soon-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #f8c555;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 20px rgba(248, 197, 85, 0.5);
            animation: soonPulse 2s infinite;
        }
        
        @keyframes soonPulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .item-animation {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        .log-player {
            color: #3498db;
            font-weight: bold;
        }
        
        .log-enemy {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .log-skill {
            color: #f39c12;
            font-weight: bold;
        }
        
        .log-item {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .log-effect {
            color: #9b59b6;
            font-weight: bold;
        }
        
        /* Novos estilos para o Pântano Abissal */
        .level-required-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #e74c3c;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }
        
        .dialogue-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 40;
            backdrop-filter: blur(5px);
        }
        
        .dialogue-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a1a2e"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23e74c3c" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #e74c3c;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.3);
            position: relative;
        }
        
        .dialogue-character {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dialogue-character-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            border: 3px solid #e74c3c;
            margin-right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #e74c3c;
        }
        
        .dialogue-character-info {
            flex: 1;
        }
        
        .dialogue-character-name {
            font-size: 1.5rem;
            color: #e74c3c;
            margin-bottom: 5px;
        }
        
        .dialogue-text {
            font-size: 1.2rem;
            line-height: 1.5;
            margin-bottom: 20px;
            min-height: 80px;
        }
        
        .dialogue-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialogue-option {
            background: linear-gradient(to bottom, #2c3e50, #34495e);
            color: white;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .dialogue-option:hover {
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .boss-battle-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #2c3e50 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 45;
        }
        
        .boss-battle-container {
            width: 95%;
            height: 95%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a1a2e"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23e74c3c" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #e74c3c;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .boss-battle-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(231, 76, 60, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(142, 68, 173, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .boss-battle-scene {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
            position: relative;
            margin: 20px 0;
        }
        
        .boss-battle-character {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .boss-character-canvas {
            width: 300px;
            height: 300px;
            margin-bottom: 10px;
        }
        
        .boss-battle-stats {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .boss-player-stats, .boss-enemy-stats {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 250px;
            border: 2px solid #e74c3c;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .boss-player-stats h3, .boss-enemy-stats h3 {
            color: #e74c3c;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(231, 76, 60, 0.3);
            padding-bottom: 5px;
        }
        
        .boss-round-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #e74c3c;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .boss-battle-dialog {
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            overflow-y: auto;
            font-size: 0.9rem;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }
        
        .boss-battle-actions-pokemon {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            height: 80px;
            margin-top: 20px;
        }
        
        .boss-battle-action-btn {
    background: linear-gradient(to bottom, #e74c3c, #c0392b);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'MedievalSharp', cursive;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.boss-battle-action-btn:hover {
    background: linear-gradient(to bottom, #ff6b6b, #e74c3c);
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(231, 76, 60, 0.4);
}

.boss-battle-action-btn:active {
    transform: translateY(0);
}

.boss-battle-action-btn:disabled {
    background: #666;
    color: #999;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Submenus do Boss */
.boss-attack-options, .boss-magic-options, .boss-items-options, .boss-act-options {
    display: none;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    height: 80px;
}

/* Container de itens da batalha do boss */
.boss-items-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 10px;
}
        
        .boss-transformation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(231, 76, 60, 0.8) 0%, rgba(142, 68, 173, 0.8) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: transformationPulse 2s infinite;
        }
        
        @keyframes transformationPulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .transformation-text {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .boss-final-dialog {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 180px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 4px solid #e74c3c;
            display: none;
            flex-direction: column;
            padding: 15px;
            z-index: 55;
        }
        
        .boss-final-dialog-text {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.4;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            
        </div>
        
        <div class="game-board">
            <canvas id="gameCanvas" width="1200" height="700"></canvas>
            
            <div class="ui-overlay">
                <div class="stat-bar">
                    <div class="stat-label">HP:</div>
                    <div class="bar-container">
                        <div id="healthBar" class="bar-fill health-bar" style="width: 100%"></div>
                    </div>
                    <span id="healthText">100/100</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">MANA:</div>
                    <div class="bar-container">
                        <div id="manaBar" class="bar-fill mana-bar" style="width: 100%"></div>
                    </div>
                    <span id="manaText">50/50</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">STAMINA:</div>
                    <div class="bar-container">
                        <div id="staminaBar" class="bar-fill stamina-bar" style="width: 100%"></div>
                    </div>
                    <span id="staminaText">30/30</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">EXP:</div>
                    <div class="bar-container">
                        <div id="expBar" class="bar-fill exp-bar" style="width: 0%"></div>
                    </div>
                    <span id="expText">0/40</span>
                </div>
                
                <div class="money-display">
                    <span>💰</span>
                    <span id="moneyText">100</span>
                </div>
            </div>
            
            <div class="level-indicator">
                Nível: <span id="levelText">1</span>
            </div>
            
            <div class="inventory-btn" id="inventoryBtn">
                🎒
            </div>
            
            <div class="battle-screen" id="battleScreen">
                <div class="battle-container">
                    <div class="battle-ui-pokemon">
                        <div class="battle-top">
                            <div class="battle-stats">
                                <div class="player-stats">
                                    <h3>Cavaleiro</h3>
                                    <div class="stat-line">
                                        <span>Nível:</span>
                                        <span id="battlePlayerLevel">1</span>
                                    </div>
                                    <div class="stat-line">
                                        <span>HP:</span>
                                        <span id="battlePlayerHealth">100</span>/<span id="battlePlayerMaxHealth">100</span>
                                    </div>
                                    <div class="stat-line">
                                        <span>MANA:</span>
                                        <span id="battlePlayerMana">50</span>/<span id="battlePlayerMaxMana">50</span>
                                    </div>
                                    <div class="stat-line">
                                        <span>STAMINA:</span>
                                        <span id="battlePlayerStamina">30</span>/<span id="battlePlayerMaxStamina">30</span>
                                    </div>
                                    <div id="playerStatusEffects" class="status-effects"></div>
                                </div>
                                <div class="enemy-stats">
                                    <h3 id="enemyName">Monstro</h3>
                                    <div class="stat-line">
                                        <span>Nível:</span>
                                        <span id="battleEnemyLevel">1</span>
                                    </div>
                                    <div class="stat-line">
                                        <span>HP:</span>
                                        <span id="battleEnemyHealth">20</span>/<span id="battleEnemyMaxHealth">20</span>
                                    </div>
                                    <div class="stat-line">
                                        <span>Agilidade:</span>
                                        <span id="battleEnemyAgility">5</span>
                                    </div>
                                    <div id="enemyStatusEffects" class="status-effects"></div>
                                </div>
                            </div>
                            
                            <div class="battle-scene">
                                <div class="battle-character">
                                    <canvas id="playerBattleCanvas" class="character-canvas" width="250" height="250"></canvas>
                                    <div>Cavaleiro</div>
                                </div>
                                <div class="battle-character">
                                    <canvas id="enemyBattleCanvas" class="character-canvas" width="250" height="250"></canvas>
                                    <div id="enemyBattleName">Monstro</div>
                                </div>
                            </div>
                            
                            <div class="round-indicator" id="roundIndicator">Round 1</div>
                        </div>
                        
                        <div class="battle-bottom">
                            <div class="battle-dialog" id="battleDialog">
                                <div class="log-entry">Uma batalha começou!</div>
                            </div>
                            
                            <div class="battle-actions-pokemon" id="battleActionsPokemon">
                                <button class="battle-action-btn" id="attackBtnPokemon">ATACAR</button>
                                <button class="battle-action-btn" id="magicBtnPokemon">PODER MÁGICO</button>
                                <button class="battle-action-btn" id="itemsBtnPokemon">ITENS</button>
                                <button class="battle-action-btn" id="actBtnPokemon">AGIR</button>
                            </div>
                            
                            <div class="battle-submenu" id="attackOptionsPokemon" style="display: none;">
                                <button class="battle-action-btn" id="swordAttackBtnPokemon">ESPADADA</button>
                                <button class="battle-action-btn" id="chargeBtnPokemon" disabled>INVESTIDA (Bloqueada)</button>
                                <button class="battle-action-btn" id="heavyArmorBtnPokemon" disabled>ARMADURA PESADA (Bloqueada)</button>
                                <button class="battle-action-btn" id="backFromAttackBtnPokemon">VOLTAR</button>
                            </div>
                            
                            <div class="battle-submenu" id="magicOptionsPokemon" style="display: none;">
                                <button class="battle-action-btn" id="fireballBtnPokemon" disabled>BOLA DE FOGO (Bloqueada)</button>
                                <button class="battle-action-btn" id="freezeBtnPokemon" disabled>BRISA CONGELANTE (Bloqueada)</button>
                                <button class="battle-action-btn" id="possessionBtnPokemon" disabled>POSSEÇÃO (Bloqueada)</button>
                                <button class="battle-action-btn" id="backFromMagicBtnPokemon">VOLTAR</button>
                            </div>
                            
                            <div class="battle-submenu" id="itemsOptionsPokemon" style="display: none;">
                                <div class="items-grid" id="battleItemsGridPokemon">
                                </div>
                                <button class="battle-action-btn" id="backFromItemsBtnPokemon">VOLTAR</button>
                            </div>
                            
                            <div class="battle-submenu" id="actOptionsPokemon" style="display: none;">
                                <button class="battle-action-btn" id="meditateBtnPokemon">MEDITAR</button>
                                <button class="battle-action-btn" id="restBtnPokemon" disabled>DESCANSAR (Bloqueada)</button>
                                <button class="battle-action-btn" id="fleeBtnPokemon">TENTAR FUGIR</button>
                                <button class="battle-action-btn" id="backFromActBtnPokemon">VOLTAR</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="inventory-screen" id="inventoryScreen">
                <div class="inventory-container">
                    <div class="inventory-header">
                        <h2>Inventário e Status</h2>
                        <button class="close-btn" id="closeInventoryBtn">Fechar</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span>Nível:</span>
                            <span id="inventoryLevel">1</span>
                        </div>
                        <div class="stat-item">
                            <span>Experiência:</span>
                            <span id="inventoryExp">0/100</span>
                        </div>
                        <div class="stat-item">
                            <span>Dinheiro:</span>
                            <span id="inventoryMoney">100</span>
                        </div>
                        <div class="stat-item">
                            <span>Pontos de Upgrade:</span>
                            <span id="upgradePoints">0</span>
                        </div>
                    </div>
                    
                    <div class="upgrade-points" id="upgradeSection">
                        <h3>Atributos</h3>
                        <div class="stat-item">
                            <span>HP: <span id="statHp">10</span></span>
                            <button class="upgrade-btn" data-stat="hp">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Força: <span id="statStr">10</span></span>
                            <button class="upgrade-btn" data-stat="str">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Agilidade: <span id="statAgi">10</span></span>
                            <button class="upgrade-btn" data-stat="agi">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Defesa: <span id="statDef">10</span></span>
                            <button class="upgrade-btn" data-stat="def">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Magia: <span id="statMag">10</span></span>
                            <button class="upgrade-btn" data-stat="mag">+</button>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Habilidades de Força</h3>
                        <div id="unlockedStrengthSkills">
                            <div>Investida: <span id="chargeStatus">Bloqueada</span></div>
                            <div>Armadura Pesada: <span id="heavyArmorStatus">Bloqueada</span></div>
                            <div>Descansar: <span id="restStatus">Bloqueada</span></div>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Habilidades de Magia</h3>
                        <div id="unlockedMagicSkills">
                            <div>Bola de Fogo: <span id="fireballStatus">Bloqueada</span></div>
                            <div>Brisa Congelante: <span id="freezeStatus">Bloqueada</span></div>
                            <div>Posseção: <span id="possessionStatus">Bloqueada</span></div>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Itens</h3>
                        <div class="items-grid">
                            <div class="item-slot">
                                <div class="item-icon">🍎</div>
                                <div>Maçã: <span id="inventoryMaceCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🍗</div>
                                <div>Pernil: <span id="inventoryHamCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🥩</div>
                                <div>Bife: <span id="inventorySteakCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🧪</div>
                                <div>Poção de Força: <span id="inventoryStrengthPotionCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🍀</div>
                                <div>Poção da Sorte: <span id="inventoryLuckPotionCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🐉</div>
                                <div>Escamas de Dragão: <span id="inventoryDragonScalesCount">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Receitas de Crafting</h3>
                        <div class="items-grid" id="recipesGrid">
                        </div>
                    </div>
                    
                    <div class="crafting-section">
                        <h3 class="crafting-title">Crafting</h3>
                        <div class="crafting-grid">
                            <div class="crafting-slot" id="craftSlot1"></div>
                            <div class="crafting-slot" id="craftSlot2"></div>
                            <div class="crafting-slot" id="craftSlot3"></div>
                            <div class="crafting-slot" id="craftSlot4"></div>
                            <div class="crafting-slot" id="craftSlot5"></div>
                            <div class="crafting-slot" id="craftSlot6"></div>
                            <div class="crafting-slot" id="craftSlot7"></div>
                            <div class="crafting-slot" id="craftSlot8"></div>
                            <div class="crafting-slot" id="craftSlot9"></div>
                        </div>
                        <div class="crafting-result" id="craftingResult">
                            <span>⚔️</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="battle-btn" id="equipmentBtn">Ver Equipamentos</button>
                    </div>
                </div>
            </div>
            
            <div class="equipment-screen" id="equipmentScreen">
                <div class="equipment-container">
                    <div class="equipment-header">
                        <h2>Equipamentos</h2>
                        <button class="close-btn" id="closeEquipmentBtn">Fechar</button>
                    </div>
                    
                    <div class="equipment-grid">
                        <div class="weapons-column">
                            <h3>Armas</h3>
                            <div id="weaponsList">
                            </div>
                        </div>
                        
                        <div class="armors-column">
                            <h3>Armaduras</h3>
                            <div id="armorsList">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="shop-screen" id="shopScreen">
                <div class="shop-container">
                    <div class="shop-header">
                        <h2>Loja do Mercador</h2>
                        <button class="close-btn" id="closeShopBtn">Fechar</button>
                    </div>
                    
                    <div class="shop-categories">
                        <div class="shop-category active" data-category="food">Comidas</div>
                        <div class="shop-category" data-category="weapons">Armamentos</div>
                        <div class="shop-category" data-category="potions">Poções</div>
                    </div>
                    
                    <div class="shop-items" id="shopItems">
                    </div>
                </div>
            </div>
            
            <div class="dark-shop-screen" id="darkShopScreen">
                <div class="dark-shop-container">
                    <div class="dark-shop-header">
                        <h2>Loja Negra</h2>
                        <button class="close-btn" id="closeDarkShopBtn">Fechar</button>
                    </div>
                    
                    <div class="dark-shop-categories">
                        <div class="dark-shop-category active" data-category="food">Comidas</div>
                        <div class="dark-shop-category" data-category="weapons">Armamentos</div>
                        <div class="dark-shop-category" data-category="orbs">Orbes de Invocação</div>
                    </div>
                    
                    <div class="dark-shop-items" id="darkShopItems">
                    </div>
                </div>
            </div>
            
            <div class="death-screen" id="deathScreen">
                <h2>Você Morreu</h2>
                <p>Seus itens e Sua Experiência Talvez Foram Junto Com Você...</p>
            </div>
            
            <div class="notification-screen" id="notificationScreen">
                <div class="notification-container">
                    <h2 class="notification-title" id="notificationTitle">Notificação</h2>
                    <p class="notification-message" id="notificationMessage"></p>
                    <button class="battle-btn" id="closeNotificationBtn">Fechar</button>
                </div>
            </div>
            
            <div class="start-screen" id="startScreen">
                <h1 class="start-title">Knight of Valor</h1>
                <p class="start-message">Embarque em uma jornada épica como um cavaleiro destinado a restaurar a paz no reino. Enfrente monstros terríveis, descubra tesouros lendários e torne-se uma lenda!</p>
                <div class="loading-bar">
                    <div class="loading-progress" id="loadingProgress"></div>
                </div>
                <button class="start-btn" id="startBtn">Iniciar Jornada</button>
            </div>
            
            <!-- Novas telas para o Pântano Abissal -->
            <div class="level-required-message" id="levelRequiredMessage" style="display: none;">
                Level 15 necessário para acessar o Pântano Abissal
            </div>
            
            <div class="dialogue-screen" id="dialogueScreen">
                <div class="dialogue-container">
                    <div class="dialogue-character">
                        <div class="dialogue-character-image">👤</div>
                        <div class="dialogue-character-info">
                            <div class="dialogue-character-name" id="dialogueCharacterName">???</div>
                            <div class="dialogue-text" id="dialogueText"></div>
                        </div>
                    </div>
                    <div class="dialogue-options" id="dialogueOptions">
                        <!-- Opções de diálogo serão inseridas aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <div class="boss-battle-screen" id="bossBattleScreen">
                <div class="boss-battle-container">
                    <div class="boss-battle-stats">
                        <div class="boss-player-stats">
                            <h3>Cavaleiro</h3>
                            <div class="stat-line">
                                <span>Nível:</span>
                                <span id="bossBattlePlayerLevel">1</span>
                            </div>
                            <div class="stat-line">
                                <span>HP:</span>
                                <span id="bossBattlePlayerHealth">100</span>/<span id="bossBattlePlayerMaxHealth">100</span>
                            </div>
                            <div class="stat-line">
                                <span>MANA:</span>
                                <span id="bossBattlePlayerMana">50</span>/<span id="bossBattlePlayerMaxMana">50</span>
                            </div>
                            <div class="stat-line">
                                <span>STAMINA:</span>
                                <span id="bossBattlePlayerStamina">30</span>/<span id="bossBattlePlayerMaxStamina">30</span>
                            </div>
                            <div id="bossPlayerStatusEffects" class="status-effects"></div>
                        </div>
                        <div class="boss-enemy-stats">
                            <h3 id="bossEnemyName">???</h3>
                            <div class="stat-line">
                                <span>Nível:</span>
                                <span id="bossBattleEnemyLevel">??</span>
                            </div>
                            <div class="stat-line">
                                <span>HP:</span>
                                <span id="bossBattleEnemyHealth">50</span>/<span id="bossBattleEnemyMaxHealth">50</span>
                            </div>
                            <div class="stat-line">
                                <span>Agilidade:</span>
                                <span id="bossBattleEnemyAgility">??</span>
                            </div>
                            <div id="bossEnemyStatusEffects" class="status-effects"></div>
                        </div>
                    </div>
                    
                    <div class="boss-battle-scene">
                        <div class="boss-battle-character">
                            <canvas id="bossPlayerBattleCanvas" class="boss-character-canvas" width="300" height="300"></canvas>
                            <div>Cavaleiro</div>
                        </div>
                        <div class="boss-battle-character">
                            <canvas id="bossEnemyBattleCanvas" class="boss-character-canvas" width="300" height="300"></canvas>
                            <div id="bossEnemyBattleName">???</div>
                        </div>
                    </div>
                    
                    <div class="boss-round-indicator" id="bossRoundIndicator">Round 1</div>
                    
                    <div class="boss-battle-dialog" id="bossBattleDialog">
                        <div class="log-entry">Uma batalha épica começou!</div>
                    </div>
                    
                    <div class="boss-battle-actions-pokemon" id="bossBattleActionsPokemon">
    <button class="boss-battle-action-btn" id="bossAttackBtnPokemon">ATACAR</button>
    <button class="boss-battle-action-btn" id="bossMagicBtnPokemon">PODER MÁGICO</button>
    <button class="boss-battle-action-btn" id="bossItemsBtnPokemon">ITENS</button>
    <button class="boss-battle-action-btn" id="bossActBtnPokemon">AGIR</button>
</div>

<div class="boss-attack-options" id="bossAttackOptionsPokemon" style="display: none;">
    <button class="boss-battle-action-btn" id="bossSwordAttackBtnPokemon">ESPADADA</button>
    <button class="boss-battle-action-btn" id="bossChargeBtnPokemon">INVESTIDA</button>
    <button class="boss-battle-action-btn" id="bossHeavyArmorBtnPokemon">ARMADURA PESADA</button>
    <button class="boss-battle-action-btn" id="bossBackFromAttackBtnPokemon">VOLTAR</button>
</div>

<div class="boss-magic-options" id="bossMagicOptionsPokemon" style="display: none;">
    <button class="boss-battle-action-btn" id="bossFireballBtnPokemon">BOLA DE FOGO</button>
    <button class="boss-battle-action-btn" id="bossFreezeBtnPokemon">BRISA CONGELANTE</button>
    <button class="boss-battle-action-btn" id="bossPossessionBtnPokemon">POSSEÇÃO</button>
    <button class="boss-battle-action-btn" id="bossBackFromMagicBtnPokemon">VOLTAR</button>
</div>

<div class="boss-items-options" id="bossItemsOptionsPokemon" style="display: none;">
    <div class="boss-items-grid" id="bossBattleItemsGridPokemon">
    </div>
    <button class="boss-battle-action-btn" id="bossBackFromItemsBtnPokemon">VOLTAR</button>
</div>

<div class="boss-act-options" id="bossActOptionsPokemon" style="display: none;">
    <button class="boss-battle-action-btn" id="bossMeditateBtnPokemon">MEDITAR</button>
    <button class="boss-battle-action-btn" id="bossRestBtnPokemon">DESCANSAR</button>
    <button class="boss-battle-action-btn" id="bossFleeBtnPokemon">TENTAR FUGIR</button>
    <button class="boss-battle-action-btn" id="bossBackFromActBtnPokemon">VOLTAR</button>
</div>
                    
                    <div class="boss-transformation" id="bossTransformation">
                        <div class="transformation-text">TRANSFORMAÇÃO DO REI CORROMPIDO!</div>
                    </div>
                    
                    <div class="boss-final-dialog" id="bossFinalDialog">
                        <div class="boss-final-dialog-text" id="bossFinalDialogText"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            
        </div>
    </div>

    <script>
        // Constantes do jogo
        const TILE_SIZE = 64;
        const MAP_WIDTH = 18;
        const MAP_HEIGHT = 11;
        const WORLD_SIZE = 120;
        const MOVE_COOLDOWN = 120;
        const MONSTER_SPAWN_CHANCE = 0.1;
        const GOLDEN_MONSTER_CHANCE = 0.0001;

        // Seleção de elementos do DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const playerCanvas = document.getElementById('playerBattleCanvas');
        const playerCtx = playerCanvas.getContext('2d');
        const enemyCanvas = document.getElementById('enemyBattleCanvas');
        const enemyCtx = enemyCanvas.getContext('2d');
        const bossPlayerCanvas = document.getElementById('bossPlayerBattleCanvas');
        const bossPlayerCtx = bossPlayerCanvas.getContext('2d');
        const bossEnemyCanvas = document.getElementById('bossEnemyBattleCanvas');
        const bossEnemyCtx = bossEnemyCanvas.getContext('2d');

        // Elementos de UI
        const healthBar = document.getElementById('healthBar');
        const healthText = document.getElementById('healthText');
        const manaBar = document.getElementById('manaBar');
        const manaText = document.getElementById('manaText');
        const staminaBar = document.getElementById('staminaBar');
        const staminaText = document.getElementById('staminaText');
        const expBar = document.getElementById('expBar');
        const expText = document.getElementById('expText');
        const moneyText = document.getElementById('moneyText');
        const levelText = document.getElementById('levelText');

        // Elementos de batalha
        const battleScreen = document.getElementById('battleScreen');
        const battleDialog = document.getElementById('battleDialog');
        const battleActionsPokemon = document.getElementById('battleActionsPokemon');
        const attackOptionsPokemon = document.getElementById('attackOptionsPokemon');
        const magicOptionsPokemon = document.getElementById('magicOptionsPokemon');
        const itemsOptionsPokemon = document.getElementById('itemsOptionsPokemon');
        const actOptionsPokemon = document.getElementById('actOptionsPokemon');
        const battleEnemyLevel = document.getElementById('battleEnemyLevel');
        const battleEnemyHealth = document.getElementById('battleEnemyHealth');
        const battleEnemyMaxHealth = document.getElementById('battleEnemyMaxHealth');
        const battleEnemyAgility = document.getElementById('battleEnemyAgility');
        const enemyName = document.getElementById('enemyName');
        const roundIndicator = document.getElementById('roundIndicator');
        const playerStatusEffects = document.getElementById('playerStatusEffects');
        const enemyStatusEffects = document.getElementById('enemyStatusEffects');

        // Botões de batalha
        const attackBtnPokemon = document.getElementById('attackBtnPokemon');
        const magicBtnPokemon = document.getElementById('magicBtnPokemon');
        const itemsBtnPokemon = document.getElementById('itemsBtnPokemon');
        const actBtnPokemon = document.getElementById('actBtnPokemon');
        const swordAttackBtnPokemon = document.getElementById('swordAttackBtnPokemon');
        const chargeBtnPokemon = document.getElementById('chargeBtnPokemon');
        const heavyArmorBtnPokemon = document.getElementById('heavyArmorBtnPokemon');
        const fireballBtnPokemon = document.getElementById('fireballBtnPokemon');
        const freezeBtnPokemon = document.getElementById('freezeBtnPokemon');
        const possessionBtnPokemon = document.getElementById('possessionBtnPokemon');
        const meditateBtnPokemon = document.getElementById('meditateBtnPokemon');
        const restBtnPokemon = document.getElementById('restBtnPokemon');
        const fleeBtnPokemon = document.getElementById('fleeBtnPokemon');
        const backFromAttackBtnPokemon = document.getElementById('backFromAttackBtnPokemon');
        const backFromMagicBtnPokemon = document.getElementById('backFromMagicBtnPokemon');
        const backFromItemsBtnPokemon = document.getElementById('backFromItemsBtnPokemon');
        const backFromActBtnPokemon = document.getElementById('backFromActBtnPokemon');
        const battleItemsGridPokemon = document.getElementById('battleItemsGridPokemon');

        // Elementos de inventário
        const inventoryScreen = document.getElementById('inventoryScreen');
        const inventoryBtn = document.getElementById('inventoryBtn');
        const closeInventoryBtn = document.getElementById('closeInventoryBtn');
        const inventoryLevel = document.getElementById('inventoryLevel');
        const inventoryExp = document.getElementById('inventoryExp');
        const inventoryMoney = document.getElementById('inventoryMoney');
        const upgradePoints = document.getElementById('upgradePoints');
        const statHp = document.getElementById('statHp');
        const statStr = document.getElementById('statStr');
        const statAgi = document.getElementById('statAgi');
        const statDef = document.getElementById('statDef');
        const statMag = document.getElementById('statMag');
        const chargeStatus = document.getElementById('chargeStatus');
        const heavyArmorStatus = document.getElementById('heavyArmorStatus');
        const fireballStatus = document.getElementById('fireballStatus');
        const freezeStatus = document.getElementById('freezeStatus');
        const possessionStatus = document.getElementById('possessionStatus');
        const restStatus = document.getElementById('restStatus');
        const inventoryMaceCount = document.getElementById('inventoryMaceCount');
        const inventoryHamCount = document.getElementById('inventoryHamCount');
        const inventorySteakCount = document.getElementById('inventorySteakCount');
        const inventoryStrengthPotionCount = document.getElementById('inventoryStrengthPotionCount');
        const inventoryLuckPotionCount = document.getElementById('inventoryLuckPotionCount');
        const inventoryDragonScalesCount = document.getElementById('inventoryDragonScalesCount');

        // Elementos de crafting
        const craftingSlots = [
            document.getElementById('craftSlot1'),
            document.getElementById('craftSlot2'),
            document.getElementById('craftSlot3'),
            document.getElementById('craftSlot4'),
            document.getElementById('craftSlot5'),
            document.getElementById('craftSlot6'),
            document.getElementById('craftSlot7'),
            document.getElementById('craftSlot8'),
            document.getElementById('craftSlot9')
        ];
        const craftingResult = document.getElementById('craftingResult');
        const recipesGrid = document.getElementById('recipesGrid');

        // Elementos de equipamento
        const equipmentScreen = document.getElementById('equipmentScreen');
        const equipmentBtn = document.getElementById('equipmentBtn');
        const closeEquipmentBtn = document.getElementById('closeEquipmentBtn');
        const weaponsList = document.getElementById('weaponsList');
        const armorsList = document.getElementById('armorsList');

        // Elementos de loja
        const shopScreen = document.getElementById('shopScreen');
        const closeShopBtn = document.getElementById('closeShopBtn');
        const shopCategories = document.querySelectorAll('.shop-category');
        const shopItems = document.getElementById('shopItems');
        const darkShopScreen = document.getElementById('darkShopScreen');
        const closeDarkShopBtn = document.getElementById('closeDarkShopBtn');
        const darkShopCategories = document.querySelectorAll('.dark-shop-category');
        const darkShopItems = document.getElementById('darkShopItems');

        // Outros elementos
        const deathScreen = document.getElementById('deathScreen');
        const notificationScreen = document.getElementById('notificationScreen');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const loadingProgress = document.getElementById('loadingProgress');

        // Novos elementos para o Pântano Abissal
        const levelRequiredMessage = document.getElementById('levelRequiredMessage');
        const dialogueScreen = document.getElementById('dialogueScreen');
        const dialogueCharacterName = document.getElementById('dialogueCharacterName');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueOptions = document.getElementById('dialogueOptions');
        const bossBattleScreen = document.getElementById('bossBattleScreen');
        const bossBattlePlayerLevel = document.getElementById('bossBattlePlayerLevel');
        const bossBattlePlayerHealth = document.getElementById('bossBattlePlayerHealth');
        const bossBattlePlayerMaxHealth = document.getElementById('bossBattlePlayerMaxHealth');
        const bossBattlePlayerMana = document.getElementById('bossBattlePlayerMana');
        const bossBattlePlayerMaxMana = document.getElementById('bossBattlePlayerMaxMana');
        const bossBattlePlayerStamina = document.getElementById('bossBattlePlayerStamina');
        const bossBattlePlayerMaxStamina = document.getElementById('bossBattlePlayerMaxStamina');
        const bossEnemyName = document.getElementById('bossEnemyName');
        const bossBattleEnemyLevel = document.getElementById('bossBattleEnemyLevel');
        const bossBattleEnemyHealth = document.getElementById('bossBattleEnemyHealth');
        const bossBattleEnemyMaxHealth = document.getElementById('bossBattleEnemyMaxHealth');
        const bossBattleEnemyAgility = document.getElementById('bossBattleEnemyAgility');
        const bossRoundIndicator = document.getElementById('bossRoundIndicator');
        const bossBattleDialog = document.getElementById('bossBattleDialog');
        const bossBattleActionsPokemon = document.getElementById('bossBattleActionsPokemon');
        const bossAttackBtnPokemon = document.getElementById('bossAttackBtnPokemon');
        const bossMagicBtnPokemon = document.getElementById('bossMagicBtnPokemon');
        const bossItemsBtnPokemon = document.getElementById('bossItemsBtnPokemon');
        const bossActBtnPokemon = document.getElementById('bossActBtnPokemon');
        const bossTransformation = document.getElementById('bossTransformation');
        const bossFinalDialog = document.getElementById('bossFinalDialog');
        const bossFinalDialogText = document.getElementById('bossFinalDialogText');

        // Cores para o mapa
        const COLORS = {
            GRASS: '#2ecc71',
            GRASS_DARK: '#27ae60',
            WATER: '#3498db',
            WATER_DARK: '#2980b9',
            FOREST: '#27ae60',
            FOREST_DARK: '#229954',
            MOUNTAIN: '#95a5a6',
            MOUNTAIN_DARK: '#7f8c8d',
            PATH: '#d35400',
            PATH_DARK: '#ba4a00',
            FLOWER1: '#e74c3c',
            FLOWER2: '#9b59b6',
            FLOWER3: '#f1c40f',
            SAND: '#f1c40f',
            SAND_DARK: '#d4ac0d',
            SHOP: '#8B4513',
            SHOP_DARK: '#654321',
            VOLCANIC: '#8B0000',
            VOLCANIC_DARK: '#660000',
            LAVA: '#FF4500',
            LAVA_DARK: '#CC3700',
            DARK_FOREST: '#1b5e20',
            DARK_FOREST_DARK: '#0d3b0d',
            DARK_SHOP: '#4a235a',
            DARK_SHOP_DARK: '#2e1a47',
            SWAMP: '#2d5016',
            SWAMP_DARK: '#1e3310'
        };

        // Classe do Jogador
        class Player {
            constructor() {
                this.level = 1;
                this.x = 15;
                this.y = 15;
                this.money = 0;
                this.exp = 0;
                this.expToNextLevel = 40;
                this.upgradePoints = 0;
                
                this.baseHp = 10;
                this.baseStr = 10;
                this.baseAgi = 10;
                this.baseDef = 10;
                this.baseMag = 10;
                
                this.maxHealth = Math.floor(this.baseHp * 10);
                this.health = this.maxHealth;
                this.maxMana = Math.floor(50 * Math.pow(1.05, this.baseMag - 10));
                this.mana = this.maxMana;
                this.maxStamina = 30 + (this.baseAgi - 10) * 2;
                this.stamina = this.maxStamina;
                this.strength = this.baseStr;
                this.agility = this.baseAgi;
                this.defense = this.baseDef;
                this.magic = this.baseMag;
                
                this.dodgeChance = 0.04 + (this.baseAgi - 10) * 0.03;
                this.moveCooldown = 0;
                this.stepsTaken = 0;
                
                this.statusEffects = [];
                
                this.items = {
                    mace: 2,
                    ham: 0,
                    steak: 0,
                    strengthPotion: 0,
                    luckPotion: 0,
                    dragonScales: 0
                };
                
                this.recipes = {
                    dragonSlayer: false,
                    blackWolfArmor: false
                };
                
                this.craftingSlots = Array(9).fill(null);
                this.hasDragonSlayer = false;
                this.dragonSlayerMultiplier = 1;
                this.hasBlackWolfArmor = false;
                this.blackWolfArmorMultiplier = 1;
                
                this.weapon = {
                    name: "Espada Básica",
                    damageMultiplier: 1.0,
                    description: "Sua espada inicial",
                    icon: "⚔️",
                    type: "weapon"
                };
                
                this.armor = {
                    name: "Armadura Básica",
                    defenseMultiplier: 1.0,
                    agilityPenalty: 0,
                    description: "Sua armadura inicial",
                    icon: "🛡️",
                    type: "armor"
                };
                
                this.equipmentCollection = [
                    {
                        name: "Espada Básica",
                        damageMultiplier: 1.0,
                        description: "Sua espada inicial",
                        icon: "⚔️",
                        type: "weapon",
                        equipped: true
                    },
                    {
                        name: "Armadura Básica",
                        defenseMultiplier: 1.0,
                        agilityPenalty: 0,
                        description: "Sua armadura inicial",
                        icon: "🛡️",
                        type: "armor",
                        equipped: true
                    }
                ];
                
                this.purchasedItems = {
                    stoneSword: false,
                    goldSword: false,
                    diamondSword: false,
                    chainMail: false,
                    goldArmor: false,
                    diamondArmor: false,
                    doomSword: false,
                    soulArmor: false
                };
                
                this.luckMultiplier = 1.0;
                
                // Novos equipamentos do boss
                this.hasImperialArmor = false;
                this.hasDarkLongsword = false;
            }
            
            draw() {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                this.drawKnightWithEquipment(centerX, centerY);
}
            
            
            
            drawKnightWithEquipment(x, y) {
    ctx.save();
    
    // Determinar cores baseadas no equipamento
    let armorColor = '#34495e';
    let armorDetailColor = '#2c3e50';
    let helmetColor = '#ecf0f1';
    let shieldColor = '#2c3e50';
    let weaponColor = '#bdc3c7';
    
    // Verificar equipamentos e ajustar cores
    if (this.armor.name.includes("Ouro")) {
        armorColor = '#f39c12';
        armorDetailColor = '#d35400';
        helmetColor = '#f1c40f';
        shieldColor = '#f39c12';
    } else if (this.armor.name.includes("Diamante")) {
        armorColor = '#3498db';
        armorDetailColor = '#2980b9';
        helmetColor = '#85c1e9';
        shieldColor = '#3498db';
    } else if (this.armor.name.includes("Malha")) {
        armorColor = '#7f8c8d';
        armorDetailColor = '#95a5a6';
        helmetColor = '#bdc3c7';
        shieldColor = '#7f8c8d';
    } else if (this.armor.name.includes("Lobo Negro")) {
        armorColor = '#2c3e50';
        armorDetailColor = '#34495e';
        helmetColor = '#e74c3c';
        shieldColor = '#2c3e50';
    } else if (this.armor.name.includes("Imperial")) {
        armorColor = '#e74c3c';
        armorDetailColor = '#c0392b';
        helmetColor = '#f1c40f';
        shieldColor = '#e74c3c';
    } else if (this.armor.name.includes("Almas")) {
        armorColor = '#8e44ad';
        armorDetailColor = '#9b59b6';
        helmetColor = '#d7bde2';
        shieldColor = '#8e44ad';
    }
    
    // Ajustar cor da arma
    if (this.weapon.name.includes("Ouro")) {
        weaponColor = '#f1c40f';
    } else if (this.weapon.name.includes("Diamante")) {
        weaponColor = '#3498db';
    } else if (this.weapon.name.includes("Pedra")) {
        weaponColor = '#95a5a6';
    } else if (this.weapon.name.includes("Dragon")) {
        weaponColor = '#e74c3c';
    } else if (this.weapon.name.includes("Perdição")) {
        weaponColor = '#8e44ad';
    } else if (this.weapon.name.includes("Longsword")) {
        weaponColor = '#2c3e50';
    }
    
    // Corpo com equipamento
    ctx.fillStyle = armorColor;
    ctx.fillRect(x - 20, y - 15, 40, 30);
    
    // Detalhes da armadura
    ctx.fillStyle = armorDetailColor;
    ctx.fillRect(x - 18, y - 13, 36, 26);
    
    // Capacete
    ctx.fillStyle = helmetColor;
    ctx.fillRect(x - 10, y - 25, 20, 10);
    
    // Visor do capacete
    ctx.fillStyle = '#3498db';
    ctx.fillRect(x - 8, y - 24, 16, 4);
    
    // Escudo
    ctx.fillStyle = shieldColor;
    ctx.fillRect(x - 25, y - 10, 8, 20);
    
    // Detalhe do escudo
    ctx.fillStyle = '#f8c555';
    ctx.fillRect(x - 23, y - 5, 4, 10);
    
    this.drawWeaponWithEquipment(x, y, weaponColor);
    
    ctx.restore();
}

drawWeaponWithEquipment(x, y, weaponColor) {
    ctx.fillStyle = weaponColor;
    ctx.fillRect(x + 15, y - 12, 3, 24);
    ctx.fillRect(x + 10, y - 15, 13, 6);
    
    // Adicionar detalhes especiais para armas lendárias
    if (this.weapon.name.includes("Dragon")) {
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(x + 18, y, 8, 0, Math.PI * 2);
        ctx.fill();
    } else if (this.weapon.name.includes("Perdição")) {
        ctx.fillStyle = '#8e44ad';
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.arc(x + 17, y - 8 + i * 8, 3, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

// Atualizar também os métodos de batalha
drawBattle(ctx, isAttacking = false, attackType = null) {
    ctx.clearRect(0, 0, 250, 250);
    
    ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
    ctx.fillRect(0, 0, 250, 250);
    
    const centerX = 125;
    const centerY = 125;
    
    // Determinar cores baseadas no equipamento (mesma lógica do método anterior)
    let armorColor = '#2c3e50';
    let armorDetailColor = '#34495e';
    let helmetColor = '#ecf0f1';
    let shieldColor = '#34495e';
    let weaponColor = '#bdc3c7';
    
    // Aplicar mesma lógica de cores do método drawKnightWithEquipment
    if (this.armor.name.includes("Ouro")) {
        armorColor = '#f39c12';
        armorDetailColor = '#d35400';
        helmetColor = '#f1c40f';
        shieldColor = '#f39c12';
    }
    // ... (repetir a mesma lógica para todos os equipamentos)
    
    // Corpo
    ctx.fillStyle = armorColor;
    ctx.fillRect(centerX - 40, centerY - 20, 80, 60);
    
    // Detalhes da armadura
    ctx.fillStyle = armorDetailColor;
    ctx.fillRect(centerX - 38, centerY - 18, 76, 56);
    
    // Capacete
    ctx.fillStyle = helmetColor;
    ctx.fillRect(centerX - 25, centerY - 45, 50, 25);
    
    // Visor do capacete
    ctx.fillStyle = '#3498db';
    ctx.fillRect(centerX - 20, centerY - 43, 40, 12);
    
    // Escudo
    ctx.fillStyle = shieldColor;
    ctx.fillRect(centerX - 60, centerY - 15, 25, 45);
    
    // Detalhe do escudo
    ctx.fillStyle = '#f8c555';
    ctx.fillRect(centerX - 58, centerY - 5, 21, 35);
    
    this.drawBattleWeaponWithEquipment(ctx, centerX, centerY, isAttacking, weaponColor);
    
    ctx.strokeStyle = '#1c2833';
    ctx.lineWidth = 2;
    ctx.strokeRect(centerX - 40, centerY - 20, 80, 60);
}

drawBattleWeaponWithEquipment(ctx, x, y, isAttacking, weaponColor) {
    ctx.fillStyle = weaponColor;
    ctx.fillRect(x + 30, y - 25, 7, 60);
    ctx.fillRect(x + 25, y - 30, 20, 15);
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(x + 30, y + 35, 7, 25);
    
    // Efeitos especiais para armas lendárias
    if (this.weapon.name.includes("Dragon") && isAttacking) {
        ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
        ctx.beginPath();
        ctx.arc(x + 35, y, 15, 0, Math.PI * 2);
        ctx.fill();
    }
}
            drawBattle(ctx, isAttacking = false, attackType = null) {
                ctx.clearRect(0, 0, 250, 250);
                
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 250, 250);
                
                const centerX = 125;
                const centerY = 125;
                
                // Corpo
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(centerX - 40, centerY - 20, 80, 60);
                
                // Detalhes da armadura
                ctx.fillStyle = '#34495e';
                ctx.fillRect(centerX - 38, centerY - 18, 76, 56);
                
                // Capacete
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(centerX - 25, centerY - 45, 50, 25);
                
                // Visor do capacete
                ctx.fillStyle = '#3498db';
                ctx.fillRect(centerX - 20, centerY - 43, 40, 12);
                
                // Escudo
                ctx.fillStyle = '#34495e';
                ctx.fillRect(centerX - 60, centerY - 15, 25, 45);
                
                // Detalhe do escudo
                ctx.fillStyle = '#f8c555';
                ctx.fillRect(centerX - 58, centerY - 5, 21, 35);
                
                this.drawBattleWeapon(ctx, centerX, centerY, isAttacking);
                
                ctx.strokeStyle = '#1c2833';
                ctx.lineWidth = 2;
                ctx.strokeRect(centerX - 40, centerY - 20, 80, 60);
            }
            
            drawBattleWeapon(ctx, x, y, isAttacking) {
                ctx.fillStyle = '#bdc3c7';
                ctx.fillRect(x + 30, y - 25, 7, 60);
                ctx.fillRect(x + 25, y - 30, 20, 15);
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(x + 30, y + 35, 7, 25);
            }
            
            drawBossBattle(ctx, isAttacking = false) {
                ctx.clearRect(0, 0, 300, 300);
                
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 300, 300);
                
                const centerX = 150;
                const centerY = 150;
                
                // Corpo
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(centerX - 50, centerY - 25, 100, 75);
                
                // Detalhes da armadura
                ctx.fillStyle = '#34495e';
                ctx.fillRect(centerX - 48, centerY - 23, 96, 71);
                
                // Capacete
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(centerX - 30, centerY - 55, 60, 30);
                
                // Visor do capacete
                ctx.fillStyle = '#3498db';
                ctx.fillRect(centerX - 25, centerY - 53, 50, 15);
                
                // Escudo
                ctx.fillStyle = '#34495e';
                ctx.fillRect(centerX - 75, centerY - 20, 30, 55);
                
                // Detalhe do escudo
                ctx.fillStyle = '#f8c555';
                ctx.fillRect(centerX - 73, centerY - 10, 26, 45);
                
                this.drawBossBattleWeapon(ctx, centerX, centerY, isAttacking);
                
                ctx.strokeStyle = '#1c2833';
                ctx.lineWidth = 2;
                ctx.strokeRect(centerX - 50, centerY - 25, 100, 75);
            }
            
            drawBossBattleWeapon(ctx, x, y, isAttacking) {
                ctx.fillStyle = '#bdc3c7';
                ctx.fillRect(x + 35, y - 30, 9, 70);
                ctx.fillRect(x + 30, y - 35, 25, 18);
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(x + 35, y + 40, 9, 30);
            }
            
            move(dx, dy, worldMap) {
    if (this.moveCooldown > 0) return false;
    
    const newX = this.x + dx;
    const newY = this.y + dy;
    
    // Verificar se está tentando sair dos limites do mapa
    if (newX < 0 || newX >= WORLD_SIZE || newY < 0 || newY >= WORLD_SIZE) {
        return false; // Não permitir movimento fora dos limites
    }
    
    // Verificar se está tentando entrar no pântano
    if (worldMap[Math.floor(newY)][Math.floor(newX)] === 10) {
        if (this.level < 15) {
            showLevelRequiredMessage();
            return false;
        }
    }
    
    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
        if (worldMap[Math.floor(newY)][Math.floor(newX)] !== 1) {
            this.x = newX;
            this.y = newY;
            this.moveCooldown = MOVE_COOLDOWN;
            this.stepsTaken++;
            
            // Verificar se está no pântano para spawnar monstros especiais
            const currentTile = worldMap[Math.floor(this.y)][Math.floor(this.x)];
            if (currentTile === 10 && this.stepsTaken % 3 === 0) {
                let spawnChance = MONSTER_SPAWN_CHANCE * 1.5;
                
                if (Math.random() < spawnChance) {
                    return 'swampMonster';
                }
            } else if (this.stepsTaken % 3 === 0) {
                let spawnChance = MONSTER_SPAWN_CHANCE;
                
                if (currentTile === 2) {
                    spawnChance *= 1.3;
                } else if (currentTile === 3) {
                    spawnChance *= 1.3;
                } else if (currentTile === 7) {
                    spawnChance *= 1.5;
                } else if (currentTile === 9) {
                    spawnChance *= 1.4;
                }
                
                if (Math.random() < spawnChance) {
                    return 'monster';
                }
            }
            
            return true;
        }
    }
    return false;
}
            
            update(deltaTime) {
                if (this.moveCooldown > 0) {
                    this.moveCooldown -= deltaTime;
                    if (this.moveCooldown < 0) this.moveCooldown = 0;
                }
                
                this.updateStatusEffects();
            }
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                        this.recalculateStats();
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
                this.recalculateStats();
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            clearStatusEffects() {
                this.statusEffects = [];
                this.recalculateStats();
            }
            
            updateUI() {
                healthBar.style.width = `${(this.health / this.maxHealth) * 100}%`;
                healthText.textContent = `${this.health}/${this.maxHealth}`;
                manaBar.style.width = `${(this.mana / this.maxMana) * 100}%`;
                manaText.textContent = `${this.mana}/${this.maxMana}`;
                staminaBar.style.width = `${(this.stamina / this.maxStamina) * 100}%`;
                staminaText.textContent = `${this.stamina}/${this.maxStamina}`;
                expBar.style.width = `${(this.exp / this.expToNextLevel) * 100}%`;
                expText.textContent = `${this.exp}/${this.expToNextLevel}`;
                moneyText.textContent = this.money;
                levelText.textContent = this.level;
                
                inventoryLevel.textContent = this.level;
                inventoryExp.textContent = `${this.exp}/${this.expToNextLevel}`;
                inventoryMoney.textContent = this.money;
                upgradePoints.textContent = this.upgradePoints;
                
                statHp.textContent = this.baseHp;
                statStr.textContent = this.baseStr;
                statAgi.textContent = this.baseAgi;
                statDef.textContent = this.baseDef;
                statMag.textContent = this.baseMag;
                
                if (this.baseStr >= 13) {
                    chargeStatus.textContent = "Desbloqueada";
                    chargeBtnPokemon.disabled = false;
                    chargeBtnPokemon.textContent = "INVESTIDA";
                }
                if (this.baseStr >= 20) {
                    heavyArmorStatus.textContent = "Desbloqueada";
                    heavyArmorBtnPokemon.disabled = false;
                    heavyArmorBtnPokemon.textContent = "ARMADURA PESADA";
                }
                if (this.baseMag >= 12) {
                    fireballStatus.textContent = "Desbloqueada";
                    fireballBtnPokemon.disabled = false;
                    fireballBtnPokemon.textContent = "BOLA DE FOGO";
                }
                if (this.baseMag >= 15) {
                    freezeStatus.textContent = "Desbloqueada";
                    freezeBtnPokemon.disabled = false;
                    freezeBtnPokemon.textContent = "BRISA CONGELANTE";
                }
                if (this.baseMag >= 20) {
                    possessionStatus.textContent = "Desbloqueada";
                    possessionBtnPokemon.disabled = false;
                    possessionBtnPokemon.textContent = "POSSEÇÃO";
                }
                if (this.baseStr >= 16) {
                    restStatus.textContent = "Desbloqueada";
                    restBtnPokemon.disabled = false;
                    restBtnPokemon.textContent = "DESCANSAR";
                }
                
                inventoryMaceCount.textContent = this.items.mace;
                inventoryHamCount.textContent = this.items.ham;
                inventorySteakCount.textContent = this.items.steak;
                inventoryStrengthPotionCount.textContent = this.items.strengthPotion;
                inventoryLuckPotionCount.textContent = this.items.luckPotion;
                inventoryDragonScalesCount.textContent = this.items.dragonScales;
                
                document.getElementById('battlePlayerLevel').textContent = this.level;
                document.getElementById('battlePlayerHealth').textContent = this.health;
                document.getElementById('battlePlayerMaxHealth').textContent = this.maxHealth;
                document.getElementById('battlePlayerMana').textContent = this.mana;
                document.getElementById('battlePlayerMaxMana').textContent = this.maxMana;
                document.getElementById('battlePlayerStamina').textContent = this.stamina;
                document.getElementById('battlePlayerMaxStamina').textContent = this.maxStamina;
                
                this.updateBattleStatusEffects();
                this.updateCraftingUI();
                this.updateBattleItems();
                this.updateEquipmentUI();
                this.updateRecipesUI();
            }
            
            updateBattleStatusEffects() {
                playerStatusEffects.innerHTML = '';
                this.statusEffects.forEach(effect => {
                    const effectElement = document.createElement('div');
                    effectElement.className = `status-effect ${effect.type}`;
                    effectElement.textContent = effect.type.toUpperCase() + ` (${effect.duration})`;
                    playerStatusEffects.appendChild(effectElement);
                });
            }
            
            takeDamage(damage) {
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                return actualDamage;
            }
            
            addExp(amount) {
                this.exp += amount;
                if (this.exp >= this.expToNextLevel) {
                    this.levelUp();
                }
            }
            
            levelUp() {
                this.level++;
                this.exp -= this.expToNextLevel;
                this.expToNextLevel = Math.floor(this.expToNextLevel * 1.5);
                this.upgradePoints += 1;
                
                this.baseHp += 1;
                this.baseStr += 1;
                this.baseAgi += 1;
                this.baseDef += 1;
                this.baseMag += 1;
                
                this.recalculateStats();
                
                // Mostrar notificação de level up
                showLevelUpNotification();
            }
            
            upgradeStat(stat) {
                if (this.upgradePoints > 0) {
                    this.upgradePoints--;
                    
                    switch(stat) {
                        case 'hp':
                            this.baseHp += 1;
                            break;
                        case 'str':
                            this.baseStr += 1;
                            break;
                        case 'agi':
                            this.baseAgi += 1;
                            this.maxStamina = 30 + (this.baseAgi - 10) * 2;
                            break;
                        case 'def':
                            this.baseDef += 1;
                            break;
                        case 'mag':
                            this.baseMag += 1;
                            break;
                    }
                    
                    this.recalculateStats();
                }
            }
            
            recalculateStats() {
                this.maxHealth = Math.floor(this.baseHp * 10);
                this.maxMana = Math.floor(50 * Math.pow(1.05, this.baseMag - 10));
                this.maxStamina = 30 + (this.baseAgi - 10) * 2;
                this.strength = this.baseStr;
                this.agility = this.baseAgi - this.armor.agilityPenalty;
                this.defense = this.baseDef;
                this.magic = this.baseMag;
                
                if (this.hasDragonSlayer) {
                    this.strength = Math.floor(this.strength * 11);
                }
                
                if (this.hasDarkLongsword) {
                    this.strength = Math.floor(this.strength * 25);
                }
                
                if (this.weapon.name === "Espada da Perdição") {
                    this.strength = Math.floor(this.strength * 15);
                    this.maxHealth = Math.floor(this.maxHealth * 0.65);
                    if (this.health > this.maxHealth) {
                        this.health = this.maxHealth;
                    }
                } else {
                    this.strength = Math.floor(this.strength * this.weapon.damageMultiplier);
                }
                
                if (this.hasImperialArmor) {
                    this.defense = Math.floor(this.defense * 10);
                }
                
                if (this.armor.name === "Armadura de Almas") {
                    this.defense = Math.floor(this.defense * 3.4);
                    this.agility = Math.floor(this.agility * 3.4);
                    this.maxHealth = Math.floor(this.maxHealth * 0.8);
                    if (this.health > this.maxHealth) {
                        this.health = this.maxHealth;
                    }
                } else {
                    this.defense = Math.floor(this.defense * this.armor.defenseMultiplier);
                }
                
                if (this.hasBlackWolfArmor) {
                    this.defense = Math.floor(this.defense * 2.5);
                }
                
                this.dodgeChance = 0.04 + (this.agility - 10) * 0.03;
                
                if (this.hasStatusEffect('slow')) {
                    this.dodgeChance += 0.7;
                }
                
                if (this.stamina > this.maxStamina) {
                    this.stamina = this.maxStamina;
                }
            }
            
            swordAttack() {
                let baseDamage = 5 + Math.floor(this.strength * 0.5);
                const isCritical = Math.random() < 0.05;
                
                if (this.hasStatusEffect('strength-potion')) {
                    baseDamage = Math.floor(baseDamage * 1.4);
                }
                
                if (isCritical) {
                    return Math.floor(baseDamage * 2);
                }
                
                return baseDamage;
            }
            
            chargeAttack() {
                if (this.stamina < 30) {
                    return { success: false, message: "Stamina insuficiente para usar Investida!" };
                }
                
                this.stamina -= 30;
                let baseDamage = 11 + Math.floor(this.strength * 0.3);
                const isCritical = Math.random() < 0.15;
                
                if (this.hasStatusEffect('strength-potion')) {
                    baseDamage = Math.floor(baseDamage * 1.4);
                }
                
                if (isCritical) {
                    return { success: true, damage: Math.floor(baseDamage * 4), isCritical: true };
                }
                
                return { success: true, damage: baseDamage, isCritical: false };
            }
            
            activateHeavyArmor() {
                if (this.stamina < 50) {
                    return { success: false, message: "Stamina insuficiente para usar Armadura Pesada!" };
                }
                
                this.stamina -= 50;
                this.addStatusEffect({ type: 'heavy-armor', duration: 5, defenseMultiplier: 1.8 });
                return { success: true, message: "Armadura Pesada ativada! Defesa aumentada por 5 turnos!" };
            }
            
            useMana(amount) {
                if (this.mana >= amount) {
                    this.mana -= amount;
                    return true;
                }
                return false;
            }
            
            useStamina(amount) {
                if (this.stamina >= amount) {
                    this.stamina -= amount;
                    return true;
                }
                return false;
            }
            
            recoverStamina(amount) {
                this.stamina = Math.min(this.maxStamina, this.stamina + amount);
            }
            
            meditate() {
                this.mana = Math.min(this.maxMana, this.mana + 20);
                return "O cavaleiro medita e recupera 20 de mana!";
            }
            
            rest() {
                this.stamina = Math.min(this.maxStamina, this.stamina + 10);
                return "O cavaleiro descansa e recupera 10 de stamina!";
            }
            
            addItem(item, quantity = 1) {
                this.items[item] += quantity;
                this.updateUI();
            }
            
            useItem(item) {
                if (this.items[item] <= 0) return { success: false, message: "Você não tem este item!" };
                
                this.items[item]--;
                
                switch(item) {
                    case 'mace':
                        this.health = Math.min(this.maxHealth, this.health + 10);
                        return { success: true, message: "Usou a maçã e recuperou 10 de HP!" };
                    case 'ham':
                        this.health = Math.min(this.maxHealth, this.health + 25);
                        return { success: true, message: "Usou o pernil e recuperou 25 de HP!" };
                    case 'steak':
                        this.health = Math.min(this.maxHealth, this.health + 50);
                        return { success: true, message: "Usou o bife e recuperou 50 de HP!" };
                    case 'strengthPotion':
                        this.addStatusEffect({ type: 'strength-potion', duration: 5, damageMultiplier: 1.4 });
                        return { success: true, message: "Usou a poção de força! Seu ataque aumentou 40% por 5 turnos!" };
                    case 'luckPotion':
                        this.luckMultiplier = 2.5;
                        this.addStatusEffect({ type: 'luck-potion', duration: 999, luckMultiplier: 2.5 });
                        return { success: true, message: "Usou a poção da sorte! Sua sorte aumentou 2.5x!" };
                }
                
                this.updateUI();
                return { success: false, message: "Item não pode ser usado agora." };
            }
            
            addRecipe(recipe) {
                this.recipes[recipe] = true;
                this.updateRecipesUI();
            }
            
            updateRecipesUI() {
                recipesGrid.innerHTML = '';
                
                if (this.recipes.dragonSlayer) {
                    const recipeElement = document.createElement('div');
                    recipeElement.className = 'recipe-item';
                    recipeElement.innerHTML = `
                        <div class="recipe-icon">🐉⚔️</div>
                        <div class="recipe-name">Dragon Slayer</div>
                        <div class="recipe-description">Espada lendária forjada com escamas de dragão</div>
                        <div class="recipe-visual">
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot"></div>
                            <div class="recipe-slot"></div>
                            <div class="recipe-slot">🍗</div>
                            <div class="recipe-slot"></div>
                        </div>
                    `;
                    recipeElement.addEventListener('click', () => {
                        this.showRecipe('dragonSlayer');
                    });
                    recipesGrid.appendChild(recipeElement);
                }
                
                if (this.recipes.blackWolfArmor) {
                    const recipeElement = document.createElement('div');
                    recipeElement.className = 'recipe-item';
                    recipeElement.innerHTML = `
                        <div class="recipe-icon">🐺🛡️</div>
                        <div class="recipe-name">Armadura do Lobo Negro</div>
                        <div class="recipe-description">Armadura lendária do lobo negro</div>
                        <div class="recipe-visual">
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🧪</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                            <div class="recipe-slot">🐉</div>
                        </div>
                    `;
                    recipeElement.addEventListener('click', () => {
                        this.showRecipe('blackWolfArmor');
                    });
                    recipesGrid.appendChild(recipeElement);
                }
            }
            
            showRecipe(recipeType) {
                let message = "";
                if (recipeType === 'dragonSlayer') {
                    message = "Receita da Dragon Slayer:\n\nColoque 5 escamas de dragão e 1 pernil no padrão mostrado acima";
                } else if (recipeType === 'blackWolfArmor') {
                    message = "Receita da Armadura do Lobo Negro:\n\nColoque 8 escamas de dragão e 1 poção de força no padrão mostrado acima";
                }
                showNotification("Receita", message);
            }
            
            updateCraftingUI() {
                for (let i = 0; i < 9; i++) {
                    craftingSlots[i].textContent = this.craftingSlots[i] ? 
                        (this.craftingSlots[i] === 'ham' ? '🍗' : 
                         this.craftingSlots[i] === 'strengthPotion' ? '🧪' : 
                         this.craftingSlots[i] === 'steak' ? '🥩' : '🐉') : '';
                }
                
                const dragonSlayerRecipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'dragonScales', null,
                    null, 'ham', null
                ];
                
                const blackWolfArmorRecipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'strengthPotion', 'dragonScales',
                    'dragonScales', 'dragonScales', 'dragonScales'
                ];
                
                let dragonSlayerCorrect = true;
                let blackWolfArmorCorrect = true;
                
                for (let i = 0; i < 9; i++) {
                    if (this.craftingSlots[i] !== dragonSlayerRecipe[i]) {
                        dragonSlayerCorrect = false;
                    }
                    if (this.craftingSlots[i] !== blackWolfArmorRecipe[i]) {
                        blackWolfArmorCorrect = false;
                    }
                }
                
                if ((dragonSlayerCorrect && !this.hasDragonSlayer) || (blackWolfArmorCorrect && !this.hasBlackWolfArmor)) {
                    craftingResult.classList.add('crafting-ready');
                    craftingResult.title = "Clique para criar o item!";
                } else {
                    craftingResult.classList.remove('crafting-ready');
                    craftingResult.title = this.hasDragonSlayer && this.hasBlackWolfArmor ? 
                        "Você já possui todos os itens lendários!" : "Receita incompleta";
                }
            }
            
            craftItem() {
                const dragonSlayerRecipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'dragonScales', null,
                    null, 'ham', null
                ];
                
                const blackWolfArmorRecipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'strengthPotion', 'dragonScales',
                    'dragonScales', 'dragonScales', 'dragonScales'
                ];
                
                let dragonSlayerCorrect = true;
                let blackWolfArmorCorrect = true;
                
                for (let i = 0; i < 9; i++) {
                    if (this.craftingSlots[i] !== dragonSlayerRecipe[i]) {
                        dragonSlayerCorrect = false;
                    }
                    if (this.craftingSlots[i] !== blackWolfArmorRecipe[i]) {
                        blackWolfArmorCorrect = false;
                    }
                }
                
                if (dragonSlayerCorrect && !this.hasDragonSlayer) {
                    if (this.items.ham >= 1 && this.items.dragonScales >= 5) {
                        this.items.ham -= 1;
                        this.items.dragonScales -= 5;
                        this.hasDragonSlayer = true;
                        
                        this.addToEquipmentCollection({
                            name: "Dragon Slayer",
                            damageMultiplier: 11.0,
                            description: "A lendária espada forjada com escamas de dragão",
                            icon: "🐉⚔️",
                            type: "weapon",
                            equipped: false
                        });
                        
                        this.recalculateStats();
                        this.craftingSlots = Array(9).fill(null);
                        this.updateUI();
                        showNotification("Sucesso", "Você criou a Dragon Slayer! Seu dano aumentou 11x!");
                        return;
                    } else {
                        showNotification("Erro", "Você não tem itens suficientes para criar a Dragon Slayer!");
                        return;
                    }
                }
                
                if (blackWolfArmorCorrect && !this.hasBlackWolfArmor) {
                    if (this.items.strengthPotion >= 1 && this.items.dragonScales >= 8) {
                        this.items.strengthPotion -= 1;
                        this.items.dragonScales -= 8;
                        this.hasBlackWolfArmor = true;
                        
                        this.addToEquipmentCollection({
                            name: "Armadura do Lobo Negro",
                            defenseMultiplier: 2.5,
                            agilityPenalty: 0,
                            description: "A lendária armadura do lobo negro",
                            icon: "🐺🛡️",
                            type: "armor",
                            equipped: false
                        });
                        
                        this.recalculateStats();
                        this.craftingSlots = Array(9).fill(null);
                        this.updateUI();
                        showNotification("Sucesso", "Você criou a Armadura do Lobo Negro! Sua defesa aumentou 2.5x!");
                        return;
                    } else {
                        showNotification("Erro", "Você não tem itens suficientes para criar a Armadura do Lobo Negro!");
                        return;
                    }
                }
                
                showNotification("Aviso", "Receita incorreta ou você já possui o item!");
            }
            
            addToCraftingSlot(slotIndex, item) {
                if (this.craftingSlots[slotIndex] === null) {
                    if ((item === 'ham' && this.items.ham > 0) || 
                        (item === 'dragonScales' && this.items.dragonScales > 0) ||
                        (item === 'strengthPotion' && this.items.strengthPotion > 0) ||
                        (item === 'steak' && this.items.steak > 0)) {
                        
                        this.craftingSlots[slotIndex] = item;
                        
                        if (item === 'ham') {
                            this.items.ham--;
                        } else if (item === 'dragonScales') {
                            this.items.dragonScales--;
                        } else if (item === 'strengthPotion') {
                            this.items.strengthPotion--;
                        } else if (item === 'steak') {
                            this.items.steak--;
                        }
                        
                        this.updateUI();
                        return true;
                    }
                }
                return false;
            }
            
            clearCraftingSlot(slotIndex) {
                if (this.craftingSlots[slotIndex] === 'ham') {
                    this.items.ham++;
                } else if (this.craftingSlots[slotIndex] === 'dragonScales') {
                    this.items.dragonScales++;
                } else if (this.craftingSlots[slotIndex] === 'strengthPotion') {
                    this.items.strengthPotion++;
                } else if (this.craftingSlots[slotIndex] === 'steak') {
                    this.items.steak++;
                }
                
                this.craftingSlots[slotIndex] = null;
                this.updateUI();
            }
            
            clearAllCraftingSlots() {
                for (let i = 0; i < 9; i++) {
                    this.clearCraftingSlot(i);
                }
            }
            
            updateEquipmentUI() {
                this.updateEquipmentCollection();
            }
            
            updateEquipmentCollection() {
                weaponsList.innerHTML = '';
                armorsList.innerHTML = '';
                
                // Ordenar equipamentos por poder
                const weapons = this.equipmentCollection.filter(item => item.type === 'weapon')
                    .sort((a, b) => b.damageMultiplier - a.damageMultiplier);
                
                const armors = this.equipmentCollection.filter(item => item.type === 'armor')
                    .sort((a, b) => b.defenseMultiplier - a.defenseMultiplier);
                
                weapons.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = `equipment-item ${item.equipped ? 'equipped' : ''}`;
                    itemElement.innerHTML = `
                        <div class="equipment-item-icon">${item.icon}</div>
                        <div class="equipment-item-info">
                            <div class="equipment-item-name">${item.name}</div>
                            <div class="equipment-item-stats">Dano: ${item.damageMultiplier}x</div>
                            <div class="equipment-item-stats">${item.description}</div>
                        </div>
                    `;
                    
                    itemElement.addEventListener('click', () => {
                        this.equipItem(this.equipmentCollection.findIndex(i => i.name === item.name));
                    });
                    
                    weaponsList.appendChild(itemElement);
                });
                
                armors.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = `equipment-item ${item.equipped ? 'equipped' : ''}`;
                    itemElement.innerHTML = `
                        <div class="equipment-item-icon">${item.icon}</div>
                        <div class="equipment-item-info">
                            <div class="equipment-item-name">${item.name}</div>
                            <div class="equipment-item-stats">Defesa: ${item.defenseMultiplier}x</div>
                            <div class="equipment-item-stats">${item.description}</div>
                        </div>
                    `;
                    
                    itemElement.addEventListener('click', () => {
                        this.equipItem(this.equipmentCollection.findIndex(i => i.name === item.name));
                    });
                    
                    armorsList.appendChild(itemElement);
                });
            }
            
            addToEquipmentCollection(item) {
                const existingItemIndex = this.equipmentCollection.findIndex(i => i.name === item.name);
                
                if (existingItemIndex === -1) {
                    this.equipmentCollection.push(item);
                } else {
                    this.equipmentCollection[existingItemIndex] = item;
                }
                
                this.updateEquipmentCollection();
            }
            
            equipItem(index) {
                const item = this.equipmentCollection[index];
                
                this.equipmentCollection.forEach(i => {
                    if (i.type === item.type) {
                        i.equipped = false;
                    }
                });
                
                item.equipped = true;
                
                if (item.type === 'weapon') {
                    this.weapon = item;
                } else if (item.type === 'armor') {
                    this.armor = item;
                }
                
                this.recalculateStats();
                this.updateUI();
                this.updateEquipmentCollection();
            }
            
            updateBattleItems() {
                battleItemsGridPokemon.innerHTML = '';
                
                if (this.items.mace > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🍎</div>
                        <div>Maçã (x${this.items.mace})</div>
                        <button class="battle-action-btn use-item-btn" data-item="mace">Usar</button>
                    `;
                    battleItemsGridPokemon.appendChild(itemSlot);
                }
                
                if (this.items.ham > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🍗</div>
                        <div>Pernil (x${this.items.ham})</div>
                        <button class="battle-action-btn use-item-btn" data-item="ham">Usar</button>
                    `;
                    battleItemsGridPokemon.appendChild(itemSlot);
                }
                
                if (this.items.steak > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🥩</div>
                        <div>Bife (x${this.items.steak})</div>
                        <button class="battle-action-btn use-item-btn" data-item="steak">Usar</button>
                    `;
                    battleItemsGridPokemon.appendChild(itemSlot);
                }
                
                if (this.items.strengthPotion > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🧪</div>
                        <div>Poção de Força (x${this.items.strengthPotion})</div>
                        <button class="battle-action-btn use-item-btn" data-item="strengthPotion">Usar</button>
                    `;
                    battleItemsGridPokemon.appendChild(itemSlot);
                }
                
                if (this.items.luckPotion > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🍀</div>
                        <div>Poção da Sorte (x${this.items.luckPotion})</div>
                        <button class="battle-action-btn use-item-btn" data-item="luckPotion">Usar</button>
                    `;
                    battleItemsGridPokemon.appendChild(itemSlot);
                }
                
                document.querySelectorAll('.use-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const item = btn.getAttribute('data-item');
                        itemsOptionsPokemon.style.display = 'none';
                        playerUseItem(item);
                    });
                });
            }
            
            buyItem(item, price, isDarkShop = false) {
                if (isDarkShop) {
                    if (this.items.dragonScales >= price) {
                        this.items.dragonScales -= price;
                        
                        switch(item) {
                            case 'mace':
                                this.items.mace += 10;
                                break;
                            case 'ham':
                                this.items.ham += 10;
                                break;
                            case 'steak':
                                this.items.steak += 10;
                                break;
                            case 'doomSword':
                                if (!this.purchasedItems.doomSword) {
                                    this.addToEquipmentCollection({
                                        name: "Espada da Perdição",
                                        damageMultiplier: 15.0,
                                        description: "Uma espada amaldiçoada que drena a vida do usuário",
                                        icon: "⚔️",
                                        type: "weapon",
                                        equipped: false
                                    });
                                    this.purchasedItems.doomSword = true;
                                }
                                break;
                            case 'soulArmor':
                                if (!this.purchasedItems.soulArmor) {
                                    this.addToEquipmentCollection({
                                        name: "Armadura de Almas",
                                        defenseMultiplier: 3.4,
                                        agilityPenalty: 0,
                                        description: "Uma armadura que consome a vitalidade do usuário",
                                        icon: "🛡️",
                                        type: "armor",
                                        equipped: false
                                    });
                                    this.purchasedItems.soulArmor = true;
                                }
                                break;
                        }
                        
                        this.updateUI();
                        return true;
                    }
                    return false;
                } else {
                    if (this.money >= price) {
                        this.money -= price;
                        
                        switch(item) {
                            case 'mace':
                                this.items.mace++;
                                break;
                            case 'ham':
                                this.items.ham++;
                                break;
                            case 'steak':
                                this.items.steak++;
                                break;
                            case 'strengthPotion':
                                this.items.strengthPotion++;
                                break;
                            case 'luckPotion':
                                this.items.luckPotion++;
                                break;
                            case 'stoneSword':
                                if (!this.purchasedItems.stoneSword) {
                                    this.addToEquipmentCollection({
                                        name: "Espada de Pedra",
                                        damageMultiplier: 1.2,
                                        description: "Uma espada feita de pedra afiada",
                                        icon: "⚔️",
                                        type: "weapon",
                                        equipped: false
                                    });
                                    this.purchasedItems.stoneSword = true;
                                }
                                break;
                            case 'goldSword':
                                if (!this.purchasedItems.goldSword) {
                                    this.addToEquipmentCollection({
                                        name: "Espada de Ouro",
                                        damageMultiplier: 1.42,
                                        description: "Uma espada forjada em ouro puro",
                                        icon: "⚔️",
                                        type: "weapon",
                                        equipped: false
                                    });
                                    this.purchasedItems.goldSword = true;
                                }
                                break;
                            case 'diamondSword':
                                if (!this.purchasedItems.diamondSword) {
                                    this.addToEquipmentCollection({
                                        name: "Espada de Diamante",
                                        damageMultiplier: 1.75,
                                        description: "Uma espada forjada com diamantes puros",
                                        icon: "⚔️",
                                        type: "weapon",
                                        equipped: false
                                    });
                                    this.purchasedItems.diamondSword = true;
                                    this.baseHp += 2;
                                    this.maxHealth = Math.floor(this.baseHp * 10);
                                    this.health = this.maxHealth;
                                }
                                break;
                            case 'chainMail':
                                if (!this.purchasedItems.chainMail) {
                                    this.addToEquipmentCollection({
                                        name: "Armadura de Malha",
                                        defenseMultiplier: 1.3,
                                        agilityPenalty: 2,
                                        description: "Uma armadura de malha pesada",
                                        icon: "🛡️",
                                        type: "armor",
                                        equipped: false
                                    });
                                    this.purchasedItems.chainMail = true;
                                }
                                break;
                            case 'goldArmor':
                                if (!this.purchasedItems.goldArmor) {
                                    this.addToEquipmentCollection({
                                        name: "Armadura de Ouro",
                                        defenseMultiplier: 1.6,
                                        agilityPenalty: 3,
                                        description: "Uma armadura de ouro ornamentada",
                                        icon: "🛡️",
                                        type: "armor",
                                        equipped: false
                                    });
                                    this.purchasedItems.goldArmor = true;
                                }
                                break;
                            case 'diamondArmor':
                                if (!this.purchasedItems.diamondArmor) {
                                    this.addToEquipmentCollection({
                                        name: "Armadura de Diamante",
                                        defenseMultiplier: 1.85,
                                        agilityPenalty: 5,
                                        description: "Uma armadura forjada com diamantes puros",
                                        icon: "🛡️",
                                        type: "armor",
                                        equipped: false
                                    });
                                    this.purchasedItems.diamondArmor = true;
                                }
                                break;
                        }
                        
                        this.updateUI();
                        return true;
                    }
                    return false;
                }
            }
            
            loseRandomItems() {
                const items = Object.keys(this.items).filter(key => this.items[key] > 0);
                let itemsLost = 0;
                
                for (let i = 0; i < 2 && items.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * items.length);
                    const itemToLose = items[randomIndex];
                    
                    if (this.items[itemToLose] > 0) {
                        this.items[itemToLose]--;
                        itemsLost++;
                        items.splice(randomIndex, 1);
                    }
                }
                
                return itemsLost;
            }
            
            // Novos métodos para o boss
            addBossRewards() {
                this.money += 1000;
                this.items.mace += 25;
                this.items.ham += 25;
                this.items.steak += 25;
                this.items.strengthPotion += 25;
                this.items.luckPotion += 25;
                this.items.dragonScales += 25;
                
                this.hasImperialArmor = true;
                this.hasDarkLongsword = true;
                
                this.addToEquipmentCollection({
                    name: "Armadura Imperial Do Monarca",
                    defenseMultiplier: 10.0,
                    agilityPenalty: 0,
                    description: "A lendária armadura do Rei Corrompido",
                    icon: "👑🛡️",
                    type: "armor",
                    equipped: false
                });
                
                this.addToEquipmentCollection({
                    name: "Longsword Banhada em Trevas",
                    damageMultiplier: 25.0,
                    description: "A espada lendária do Rei Corrompido",
                    icon: "⚔️",
                    type: "weapon",
                    equipped: false
                });
                
                this.updateUI();
            }
        }

        // Classe do Monstro
        class Monster {
            constructor(type, worldMap, playerX, playerY, playerLevel) {
                this.type = type;
                this.isGolden = Math.random() < GOLDEN_MONSTER_CHANCE;
                
                if (playerLevel >= 5) {
                    this.level = Math.floor(Math.random() * 10) + 1;
                } else {
                    this.level = 1;
                }
                
                if (type === 'elite' && playerLevel < 8) {
                    this.level = 1;
                }
                
                if (type === 'darkMage' && playerLevel < 10) {
                    this.level = 1;
                }
                
                let baseHealth, baseAttack, healthPerLevel, attackPerLevel;
                
                if (type === 'weak') {
                    this.name = "Goblin Fraco";
                    baseHealth = 20;
                    baseAttack = 4;
                    healthPerLevel = 5;
                    attackPerLevel = 2;
                    this.agility = 5;
                } else if (type === 'strong') {
                    this.name = "Orc Forte";
                    baseHealth = 35;
                    baseAttack = 11;
                    healthPerLevel = 7;
                    attackPerLevel = 3;
                    this.agility = 8;
                } else if (type === 'elite') {
                    this.name = "Dragão de Elite";
                    baseHealth = 100;
                    baseAttack = 25;
                    healthPerLevel = 10;
                    attackPerLevel = 5;
                    this.agility = 12;
                } else if (type === 'darkMage') {
                    this.name = "Mago Negro";
                    baseHealth = 150;
                    baseAttack = 34;
                    healthPerLevel = 15;
                    attackPerLevel = 10;
                    this.agility = 6;
                }
                
                if (this.isGolden) {
                    baseHealth = Math.floor(baseHealth * 1.5);
                    baseAttack = Math.floor(baseAttack * 1.5);
                    this.name = "⭐ " + this.name + " Dourado ⭐";
                }
                
                this.maxHealth = baseHealth + (this.level - 1) * healthPerLevel;
                this.health = this.maxHealth;
                this.attack = baseAttack + (this.level - 1) * attackPerLevel;
                
                this.defense = Math.floor(Math.random() * 5) + 1;
                this.agility = Math.floor(Math.random() * 5) + 1;
                this.magic = Math.floor(Math.random() * 5) + 1;
                
                this.statusEffects = [];
                this.dodgeChance = 0.02 + (this.agility - 5) * 0.02;
                
                const currentTile = worldMap[Math.floor(playerY)][Math.floor(playerX)];
                
                if (currentTile === 7 && type !== 'elite' && Math.random() < 0.5) {
                    this.type = 'elite';
                    this.name = "Dragão de Elite";
                    this.maxHealth = 100 + (this.level - 1) * 10;
                    this.health = this.maxHealth;
                    this.attack = 25 + (this.level - 1) * 5;
                    this.level = playerLevel >= 8 ? this.level : 1;
                    this.agility = 12;
                } else if (currentTile === 3 && type !== 'strong' && Math.random() < 0.3) {
                    this.type = 'strong';
                    this.name = "Orc Forte";
                    this.maxHealth = 35 + (this.level - 1) * 7;
                    this.health = this.maxHealth;
                    this.attack = 11 + (this.level - 1) * 3;
                    this.agility = 8;
                } else if (currentTile === 2 && type !== 'weak' && Math.random() < 0.3) {
                    this.type = 'weak';
                    this.name = "Goblin Fraco";
                    this.maxHealth = 20 + (this.level - 1) * 5;
                    this.health = this.maxHealth;
                    this.attack = 4 + (this.level - 1) * 2;
                    this.agility = 5;
                } else if (currentTile === 9 && type !== 'darkMage' && Math.random() < 0.4) {
                    this.type = 'darkMage';
                    this.name = "Mago Negro";
                    this.maxHealth = 150 + (this.level - 1) * 15;
                    this.health = this.maxHealth;
                    this.attack = 34 + (this.level - 1) * 10;
                    this.agility = 6;
                }
            }
            
            drawBattle(ctx, isAttacking = false) {
                ctx.clearRect(0, 0, 250, 250);
                
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 250, 250);
                
                const centerX = 125;
                const centerY = 125;
                
                if (this.isGolden) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                    ctx.fillRect(0, 0, 250, 250);
                }
                
                if (this.type === 'weak') {
                    ctx.fillStyle = '#27ae60';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 40, 55, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 35, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#c0392b';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 25, 10, 0, Math.PI, false);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 25, centerY - 55);
                    ctx.lineTo(centerX - 40, centerY - 75);
                    ctx.lineTo(centerX - 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 25, centerY - 55);
                    ctx.lineTo(centerX + 40, centerY - 75);
                    ctx.lineTo(centerX + 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(centerX + 30, centerY - 25, 6, 45);
                    ctx.fillRect(centerX + 25, centerY - 30, 18, 12);
                    
                } else if (this.type === 'strong') {
                    ctx.fillStyle = '#34495e';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 45, 60, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 35, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#ecf0f1';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 18, centerY - 25);
                    ctx.lineTo(centerX - 25, centerY - 10);
                    ctx.lineTo(centerX - 12, centerY - 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 18, centerY - 25);
                    ctx.lineTo(centerX + 25, centerY - 10);
                    ctx.lineTo(centerX + 12, centerY - 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#bdc3c7';
                    ctx.fillRect(centerX + 30, centerY - 40, 10, 60);
                    ctx.fillRect(centerX + 25, centerY - 35, 22, 15);
                    
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(centerX + 28, centerY - 30, 4, 40);
                    
                } else if (this.type === 'elite') {
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 50, 40, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#c0392b';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 45, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 47, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 47, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 47, 5, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 47, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 18, centerY - 60);
                    ctx.lineTo(centerX - 30, centerY - 80);
                    ctx.lineTo(centerX - 12, centerY - 65);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 18, centerY - 60);
                    ctx.lineTo(centerX + 30, centerY - 80);
                    ctx.lineTo(centerX + 12, centerY - 65);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
                    ctx.beginPath();
                    ctx.ellipse(centerX - 45, centerY - 20, 30, 25, Math.PI/4, 0, Math.PI * 2);
                    ctx.ellipse(centerX + 45, centerY - 20, 30, 25, -Math.PI/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (isAttacking) {
                        ctx.fillStyle = '#f39c12';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#ff6b6b';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 10, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = '#c0392b';
                    for (let i = 0; i < 10; i++) {
                        ctx.beginPath();
                        ctx.arc(centerX - 25 + i * 5, centerY, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (this.type === 'darkMage') {
                    ctx.fillStyle = '#4b0082';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 45, 60, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#6a0dad';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 35, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#9370db';
                    ctx.beginPath();
                    ctx.arc(centerX - 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d8bfd8';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 30, 15, 0, Math.PI, false);
                    ctx.fill();
                    
                    ctx.fillStyle = '#4b0082';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 20, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#9370db';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 25, centerY - 55);
                    ctx.lineTo(centerX - 40, centerY - 75);
                    ctx.lineTo(centerX - 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 25, centerY - 55);
                    ctx.lineTo(centerX + 40, centerY - 75);
                    ctx.lineTo(centerX + 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#6a0dad';
                    ctx.fillRect(centerX + 30, centerY - 40, 10, 60);
                    ctx.fillRect(centerX + 25, centerY - 35, 22, 15);
                    
                    if (isAttacking) {
                        ctx.fillStyle = '#9370db';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#d8bfd8';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 10, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                        this.recalculateStats();
                    } else if (effect.type === 'burn') {
                        this.health -= 4;
                        if (this.health < 0) this.health = 0;
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
                this.recalculateStats();
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            recalculateStats() {
                this.dodgeChance = 0.02 + (this.agility - 5) * 0.02;
                
                if (this.hasStatusEffect('slow')) {
                    this.dodgeChance -= 0.4;
                    if (this.dodgeChance < 0) this.dodgeChance = 0;
                }
            }
            
            updateBattleStatusEffects() {
                enemyStatusEffects.innerHTML = '';
                this.statusEffects.forEach(effect => {
                    const effectElement = document.createElement('div');
                    effectElement.className = `status-effect ${effect.type}`;
                    effectElement.textContent = effect.type.toUpperCase() + ` (${effect.duration})`;
                    enemyStatusEffects.appendChild(effectElement);
                });
            }
            
            takeDamage(damage) {
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                return actualDamage;
            }
            
            attackPlayer(player) {
                let damage = this.attack;
                
                if (this.type === 'elite' && Math.random() < 0.3) {
                    player.addStatusEffect({ type: 'burn', duration: 3 });
                    damage += 5;
                } else if (this.type === 'darkMage') {
                    if (Math.random() < 0.7) {
                        // Ataque normal - CORREÇÃO: Causa dano base, não 1 de dano
                        damage = this.attack;
                        if (Math.random() < 0.1) {
                            player.addStatusEffect({ type: 'stun', duration: 1 });
                        }
                    } else {
                        // Cura - CORREÇÃO: Não causa dano, apenas cura
                        this.health = Math.min(this.maxHealth, this.health + 20);
                        damage = 0;
                    }
                }
                
                return damage;
            }
            
            dropItems(player) {
                let droppedItems = [];
                let luckMultiplier = player.luckMultiplier;
                
                let dropMultiplier = 1 + (this.level - 1) * 0.1;
                
                const getRandomQuantity = () => Math.floor(Math.random() * 5) + 1;
                
                if (this.isGolden) {
                    dropMultiplier *= 20;
                    luckMultiplier *= 5;
                }
                
                if (this.type === 'weak') {
                    if (Math.random() < 0.4 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.25 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.005 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.01 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('dragonSlayer');
                        droppedItems.push("receita da Dragon Slayer");
                    }
                    if (Math.random() < 0.01 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('blackWolfArmor');
                        droppedItems.push("receita da Armadura do Lobo Negro");
                    }
                    
                } else if (this.type === 'strong') {
                    if (Math.random() < 0.45 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.35 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.10 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.15 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.05 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('dragonSlayer');
                        droppedItems.push("receita da Dragon Slayer");
                    }
                    if (Math.random() < 0.05 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('blackWolfArmor');
                        droppedItems.push("receita da Armadura do Lobo Negro");
                    }
                    
                } else if (this.type === 'elite') {
                    if (Math.random() < 0.50 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.40 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.30 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.25 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.15 * dropMultiplier * luckMultiplier) {
                        const quantity = Math.floor(Math.random() * 3) + 1;
                        player.addItem('dragonScales', quantity);
                        droppedItems.push(`escamas de dragão (x${quantity})`);
                    }
                    
                } else if (this.type === 'darkMage') {
                    if (Math.random() < 0.75 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.55 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.55 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.35 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.10 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('luckPotion', quantity);
                        droppedItems.push(`poção da sorte (x${quantity})`);
                    }
                    if (Math.random() < 0.35 * dropMultiplier * luckMultiplier) {
                        const quantity = Math.floor(Math.random() * 3) + 1;
                        player.addItem('dragonScales', quantity);
                        droppedItems.push(`escamas de dragão (x${quantity})`);
                    }
                    
                }
                
                return droppedItems;
            }
            
            getExpReward() {
                let baseExp = 0;
                let expPerLevel = 0;
                
                if (this.type === 'weak') {
                    baseExp = 10;
                    expPerLevel = 3;
                } else if (this.type === 'strong') {
                    baseExp = 30;
                    expPerLevel = 15;
                } else if (this.type === 'elite') {
                    baseExp = 60;
                    expPerLevel = 20;
                } else if (this.type === 'darkMage') {
                    baseExp = 200;
                    expPerLevel = 50;
                }
                
                let exp = baseExp + (this.level - 1) * expPerLevel;
                
                if (this.isGolden) {
                    exp *= 150;
                }
                
                return exp;
            }
            
            getMoneyReward() {
                let baseMoney = 0;
                let moneyPerLevel = 0;
                
                if (this.type === 'weak') {
                    baseMoney = 5;
                    moneyPerLevel = 2;
                } else if (this.type === 'strong') {
                    baseMoney = 10;
                    moneyPerLevel = 5;
                } else if (this.type === 'elite') {
                    baseMoney = 30;
                    moneyPerLevel = 15;
                } else if (this.type === 'darkMage') {
                    baseMoney = 100;
                    moneyPerLevel = 70;
                }
                
                let money = baseMoney + (this.level - 1) * moneyPerLevel;
                
                if (this.isGolden) {
                    money *= 200;
                }
                
                return money;
            }
        }

        // Classe do Monstro do Pântano
        class SwampMonster {
            constructor(playerLevel) {
                const rand = Math.random();
                let monsterType = 'weak';
                
                if (rand < 0.1) {
                    monsterType = 'weak';
                } else if (rand < 0.2) {
                    monsterType = 'strong';
                } else if (rand < 0.6) {
                    monsterType = 'elite';
                } else {
                    monsterType = 'darkMage';
                }
                
                this.type = monsterType;
                this.isGolden = Math.random() < GOLDEN_MONSTER_CHANCE;
                
                if (playerLevel >= 5) {
                    this.level = Math.floor(Math.random() * 10) + 1;
                } else {
                    this.level = 1;
                }
                
                let baseHealth, baseAttack, healthPerLevel, attackPerLevel;
                
                if (monsterType === 'weak') {
                    this.name = "Goblin do Pântano";
                    baseHealth = 25;
                    baseAttack = 6;
                    healthPerLevel = 6;
                    attackPerLevel = 3;
                    this.agility = 6;
                } else if (monsterType === 'strong') {
                    this.name = "Orc do Pântano";
                    baseHealth = 45;
                    baseAttack = 15;
                    healthPerLevel = 9;
                    attackPerLevel = 4;
                    this.agility = 9;
                } else if (monsterType === 'elite') {
                    this.name = "Dragão do Pântano";
                    baseHealth = 120;
                    baseAttack = 30;
                    healthPerLevel = 12;
                    attackPerLevel = 6;
                    this.agility = 13;
                } else if (monsterType === 'darkMage') {
                    this.name = "Mago do Pântano";
                    baseHealth = 180;
                    baseAttack = 40;
                    healthPerLevel = 18;
                    attackPerLevel = 12;
                    this.agility = 7;
                }
                
                if (this.isGolden) {
                    baseHealth = Math.floor(baseHealth * 1.5);
                    baseAttack = Math.floor(baseAttack * 1.5);
                    this.name = "⭐ " + this.name + " Dourado ⭐";
                }
                
                this.maxHealth = baseHealth + (this.level - 1) * healthPerLevel;
                this.health = this.maxHealth;
                this.attack = baseAttack + (this.level - 1) * attackPerLevel;
                
                this.defense = Math.floor(Math.random() * 6) + 2;
                this.agility = Math.floor(Math.random() * 6) + 2;
                this.magic = Math.floor(Math.random() * 6) + 2;
                
                this.statusEffects = [];
                this.dodgeChance = 0.03 + (this.agility - 5) * 0.02;
            }
            
            drawBattle(ctx, isAttacking = false) {
                ctx.clearRect(0, 0, 250, 250);
                
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 250, 250);
                
                const centerX = 125;
                const centerY = 125;
                
                if (this.isGolden) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                    ctx.fillRect(0, 0, 250, 250);
                }
                
                // Adicionar efeito de pântano
                ctx.fillStyle = 'rgba(45, 80, 22, 0.3)';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 100, 0, Math.PI * 2);
                ctx.fill();
                
                if (this.type === 'weak') {
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 40, 55, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#3e7c1f';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 35, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#c0392b';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 25, 10, 0, Math.PI, false);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 25, centerY - 55);
                    ctx.lineTo(centerX - 40, centerY - 75);
                    ctx.lineTo(centerX - 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 25, centerY - 55);
                    ctx.lineTo(centerX + 40, centerY - 75);
                    ctx.lineTo(centerX + 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(centerX + 30, centerY - 25, 6, 45);
                    ctx.fillRect(centerX + 25, centerY - 30, 18, 12);
                    
                } else if (this.type === 'strong') {
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 45, 60, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#3e7c1f';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 35, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#ecf0f1';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 18, centerY - 25);
                    ctx.lineTo(centerX - 25, centerY - 10);
                    ctx.lineTo(centerX - 12, centerY - 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 18, centerY - 25);
                    ctx.lineTo(centerX + 25, centerY - 10);
                    ctx.lineTo(centerX + 12, centerY - 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#bdc3c7';
                    ctx.fillRect(centerX + 30, centerY - 40, 10, 60);
                    ctx.fillRect(centerX + 25, centerY - 35, 22, 15);
                    
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(centerX + 28, centerY - 30, 4, 40);
                    
                } else if (this.type === 'elite') {
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 50, 40, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#3e7c1f';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 45, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 47, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 47, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 47, 5, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 47, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 18, centerY - 60);
                    ctx.lineTo(centerX - 30, centerY - 80);
                    ctx.lineTo(centerX - 12, centerY - 65);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 18, centerY - 60);
                    ctx.lineTo(centerX + 30, centerY - 80);
                    ctx.lineTo(centerX + 12, centerY - 65);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(45, 80, 22, 0.7)';
                    ctx.beginPath();
                    ctx.ellipse(centerX - 45, centerY - 20, 30, 25, Math.PI/4, 0, Math.PI * 2);
                    ctx.ellipse(centerX + 45, centerY - 20, 30, 25, -Math.PI/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (isAttacking) {
                        ctx.fillStyle = '#f39c12';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#ff6b6b';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 10, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = '#3e7c1f';
                    for (let i = 0; i < 10; i++) {
                        ctx.beginPath();
                        ctx.arc(centerX - 25 + i * 5, centerY, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (this.type === 'darkMage') {
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 45, 60, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#3e7c1f';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 35, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#9370db';
                    ctx.beginPath();
                    ctx.arc(centerX - 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.arc(centerX + 15, centerY - 43, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#d8bfd8';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 30, 15, 0, Math.PI, false);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2d5016';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 20, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#9370db';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 25, centerY - 55);
                    ctx.lineTo(centerX - 40, centerY - 75);
                    ctx.lineTo(centerX - 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 25, centerY - 55);
                    ctx.lineTo(centerX + 40, centerY - 75);
                    ctx.lineTo(centerX + 20, centerY - 60);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#3e7c1f';
                    ctx.fillRect(centerX + 30, centerY - 40, 10, 60);
                    ctx.fillRect(centerX + 25, centerY - 35, 22, 15);
                    
                    if (isAttacking) {
                        ctx.fillStyle = '#9370db';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#d8bfd8';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 40, 10, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                        this.recalculateStats();
                    } else if (effect.type === 'burn') {
                        this.health -= 4;
                        if (this.health < 0) this.health = 0;
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
                this.recalculateStats();
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            recalculateStats() {
                this.dodgeChance = 0.03 + (this.agility - 5) * 0.02;
                
                if (this.hasStatusEffect('slow')) {
                    this.dodgeChance -= 0.4;
                    if (this.dodgeChance < 0) this.dodgeChance = 0;
                }
            }
            
            updateBattleStatusEffects() {
                enemyStatusEffects.innerHTML = '';
                this.statusEffects.forEach(effect => {
                    const effectElement = document.createElement('div');
                    effectElement.className = `status-effect ${effect.type}`;
                    effectElement.textContent = effect.type.toUpperCase() + ` (${effect.duration})`;
                    enemyStatusEffects.appendChild(effectElement);
                });
            }
            
            takeDamage(damage) {
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                return actualDamage;
            }
            
            attackPlayer(player) {
                let damage = this.attack;
                
                if (this.type === 'elite' && Math.random() < 0.3) {
                    player.addStatusEffect({ type: 'burn', duration: 3 });
                    damage += 5;
                } else if (this.type === 'darkMage') {
                    if (Math.random() < 0.7) {
                        // Ataque normal
                        damage = this.attack;
                        if (Math.random() < 0.1) {
                            player.addStatusEffect({ type: 'stun', duration: 1 });
                        }
                    } else {
                        // Cura
                        this.health = Math.min(this.maxHealth, this.health + 20);
                        damage = 0;
                    }
                }
                
                return damage;
            }
            
            dropItems(player) {
                let droppedItems = [];
                let luckMultiplier = player.luckMultiplier;
                
                let dropMultiplier = 1.5 + (this.level - 1) * 0.1;
                
                const getRandomQuantity = () => Math.floor(Math.random() * 5) + 1;
                
                if (this.isGolden) {
                    dropMultiplier *= 20;
                    luckMultiplier *= 5;
                }
                
                if (this.type === 'weak') {
                    if (Math.random() < 0.5 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.35 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.01 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.02 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('dragonSlayer');
                        droppedItems.push("receita da Dragon Slayer");
                    }
                    if (Math.random() < 0.02 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('blackWolfArmor');
                        droppedItems.push("receita da Armadura do Lobo Negro");
                    }
                    
                } else if (this.type === 'strong') {
                    if (Math.random() < 0.55 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.45 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.15 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.20 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.08 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('dragonSlayer');
                        droppedItems.push("receita da Dragon Slayer");
                    }
                    if (Math.random() < 0.08 * dropMultiplier * luckMultiplier) {
                        player.addRecipe('blackWolfArmor');
                        droppedItems.push("receita da Armadura do Lobo Negro");
                    }
                    
                } else if (this.type === 'elite') {
                    if (Math.random() < 0.60 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.50 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.40 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.35 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.25 * dropMultiplier * luckMultiplier) {
                        const quantity = Math.floor(Math.random() * 3) + 1;
                        player.addItem('dragonScales', quantity);
                        droppedItems.push(`escamas de dragão (x${quantity})`);
                    }
                    
                } else if (this.type === 'darkMage') {
                    if (Math.random() < 0.85 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('mace', quantity);
                        droppedItems.push(`maçã (x${quantity})`);
                    }
                    if (Math.random() < 0.65 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('ham', quantity);
                        droppedItems.push(`pernil (x${quantity})`);
                    }
                    if (Math.random() < 0.65 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('steak', quantity);
                        droppedItems.push(`bife (x${quantity})`);
                    }
                    if (Math.random() < 0.45 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('strengthPotion', quantity);
                        droppedItems.push(`poção de força (x${quantity})`);
                    }
                    if (Math.random() < 0.15 * dropMultiplier * luckMultiplier) {
                        const quantity = getRandomQuantity();
                        player.addItem('luckPotion', quantity);
                        droppedItems.push(`poção da sorte (x${quantity})`);
                    }
                    if (Math.random() < 0.45 * dropMultiplier * luckMultiplier) {
                        const quantity = Math.floor(Math.random() * 3) + 1;
                        player.addItem('dragonScales', quantity);
                        droppedItems.push(`escamas de dragão (x${quantity})`);
                    }
                    
                }
                
                return droppedItems;
            }
            
            getExpReward() {
                let baseExp = 0;
                let expPerLevel = 0;
                
                if (this.type === 'weak') {
                    baseExp = 15;
                    expPerLevel = 4;
                } else if (this.type === 'strong') {
                    baseExp = 40;
                    expPerLevel = 18;
                } else if (this.type === 'elite') {
                    baseExp = 80;
                    expPerLevel = 25;
                } else if (this.type === 'darkMage') {
                    baseExp = 250;
                    expPerLevel = 60;
                }
                
                let exp = baseExp + (this.level - 1) * expPerLevel;
                
                if (this.isGolden) {
                    exp *= 150;
                }
                
                return exp;
            }
            
            getMoneyReward() {
                let baseMoney = 0;
                let moneyPerLevel = 0;
                
                if (this.type === 'weak') {
                    baseMoney = 8;
                    moneyPerLevel = 3;
                } else if (this.type === 'strong') {
                    baseMoney = 15;
                    moneyPerLevel = 7;
                } else if (this.type === 'elite') {
                    baseMoney = 40;
                    moneyPerLevel = 20;
                } else if (this.type === 'darkMage') {
                    baseMoney = 120;
                    moneyPerLevel = 85;
                }
                
                let money = baseMoney + (this.level - 1) * moneyPerLevel;
                
                if (this.isGolden) {
                    money *= 200;
                }
                
                return money;
            }
        }

        // Classe do Boss - Rei Corrompido
        class CorruptedKing {
            constructor() {
                this.name = "???";
                this.maxHealth = 50;
                this.health = 50;
                this.attack = 2;
                this.defense = 5;
                this.agility = 10;
                this.level = 99;
                
                this.statusEffects = [];
                this.dodgeChance = 0.05;
                this.isTransformed = false;
                
                this.phase = 1; // Fase 1: ???, Fase 2: Rei Corrompido
            }
            
           drawBattle(ctx, isAttacking = false) {
    ctx.clearRect(0, 0, 300, 300);
    
    ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
    ctx.fillRect(0, 0, 300, 300);
    
    const centerX = 150;
    const centerY = 150;
    
    if (!this.isTransformed) {
        // Fase 1: Personagem misterioso
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 80, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'rgba(231, 76, 60, 0.5)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 70, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'rgba(142, 68, 173, 0.7)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 60, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 50, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(centerX - 15, centerY - 10, 8, 0, Math.PI * 2);
        ctx.arc(centerX + 15, centerY - 10, 8, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#c0392b';
        ctx.beginPath();
        ctx.arc(centerX, centerY + 5, 12, 0, Math.PI, false);
        ctx.fill();
        
        // Aura maléfica
        ctx.strokeStyle = 'rgba(231, 76, 60, 0.7)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 90, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.strokeStyle = 'rgba(142, 68, 173, 0.5)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 95, 0, Math.PI * 2);
        ctx.stroke();
    } else {
        // Fase 2: Rei Corrompido - Design Aprimorado
        
        // Capa imperial majestosa (desenhada primeiro para ficar atrás)
        ctx.fillStyle = 'rgba(30, 30, 30, 0.9)';
        ctx.beginPath();
        ctx.moveTo(centerX - 80, centerY - 20);
        ctx.lineTo(centerX - 100, centerY + 120);
        ctx.lineTo(centerX + 100, centerY + 120);
        ctx.lineTo(centerX + 80, centerY - 20);
        ctx.closePath();
        ctx.fill();
        
        // Detalhes da capa - forro vermelho
        ctx.fillStyle = 'rgba(192, 57, 43, 0.8)';
        ctx.beginPath();
        ctx.moveTo(centerX - 75, centerY - 15);
        ctx.lineTo(centerX - 95, centerY + 115);
        ctx.lineTo(centerX + 95, centerY + 115);
        ctx.lineTo(centerX + 75, centerY - 15);
        ctx.closePath();
        ctx.fill();
        
        // Corpo musculoso e imponente
        ctx.fillStyle = '#2c3e50';
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 65, 90, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Armadura negra detalhada
        ctx.fillStyle = '#1c2833';
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 60, 85, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Peitoral ornamentado
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.moveTo(centerX - 40, centerY - 30);
        ctx.lineTo(centerX - 20, centerY - 50);
        ctx.lineTo(centerX + 20, centerY - 50);
        ctx.lineTo(centerX + 40, centerY - 30);
        ctx.lineTo(centerX + 40, centerY + 10);
        ctx.lineTo(centerX - 40, centerY + 10);
        ctx.closePath();
        ctx.fill();
        
        // Detalhes do peitoral
        ctx.fillStyle = '#c0392b';
        ctx.beginPath();
        ctx.arc(centerX, centerY - 20, 15, 0, Math.PI * 2);
        ctx.fill();
        
        // Ombreiras imponentes
        ctx.fillStyle = '#34495e';
        ctx.beginPath();
        ctx.ellipse(centerX - 50, centerY - 20, 25, 15, 0, 0, Math.PI * 2);
        ctx.ellipse(centerX + 50, centerY - 20, 25, 15, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Coroa demoníaca detalhada
        ctx.fillStyle = '#f39c12';
        ctx.beginPath();
        ctx.moveTo(centerX - 35, centerY - 75);
        ctx.lineTo(centerX - 25, centerY - 95);
        ctx.lineTo(centerX - 15, centerY - 75);
        ctx.lineTo(centerX - 5, centerY - 100);
        ctx.lineTo(centerX + 5, centerY - 75);
        ctx.lineTo(centerX + 15, centerY - 95);
        ctx.lineTo(centerX + 25, centerY - 75);
        ctx.lineTo(centerX + 35, centerY - 100);
        ctx.lineTo(centerX + 45, centerY - 75);
        ctx.lineTo(centerX + 35, centerY - 65);
        ctx.lineTo(centerX - 35, centerY - 65);
        ctx.closePath();
        ctx.fill();
        
        // Detalhes da coroa
        ctx.fillStyle = '#e74c3c';
        for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.arc(centerX - 30 + i * 15, centerY - 85, 4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Espada longa das trevas
        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(centerX + 45, centerY - 60, 12, 120);
        
        ctx.fillStyle = '#e74c3c';
        ctx.fillRect(centerX + 40, centerY - 65, 22, 20);
        
        ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
        ctx.beginPath();
        ctx.arc(centerX + 51, centerY - 60, 18, 0, Math.PI * 2);
        ctx.fill();
        
        // Aura avassaladora e brilhante
        const gradient = ctx.createRadialGradient(centerX, centerY, 80, centerX, centerY, 120);
        gradient.addColorStop(0, 'rgba(231, 76, 60, 0.8)');
        gradient.addColorStop(0.5, 'rgba(142, 68, 173, 0.6)');
        gradient.addColorStop(1, 'rgba(52, 152, 219, 0.4)');
        
        ctx.strokeStyle = gradient;
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 100, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 110, 0, Math.PI * 2);
        ctx.stroke();
        
        // Efeitos brilhantes adicionais
        if (isAttacking) {
            ctx.fillStyle = 'rgba(231, 76, 60, 0.4)';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 80, 0, Math.PI * 2);
            ctx.fill();
            
            // Partículas brilhantes
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const particleX = centerX + Math.cos(angle) * 70;
                const particleY = centerY + Math.sin(angle) * 70;
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(particleX, particleY, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }
}
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            takeDamage(damage) {
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                
                // Se estiver na fase 1 e a vida chegar a 0, transformar
                if (this.health <= 0 && !this.isTransformed) {
                    this.transform();
                    return actualDamage;
                }
                
                return actualDamage;
            }
            
            transform() {
    this.isTransformed = true;
    this.name = "Rei Corrompido";
    this.maxHealth = 1500;
    this.health = 1500;
    this.attack = 76;
    this.defense = 20;
    this.agility = 15;
    this.dodgeChance = 0.1;
    
    // Mostrar animação de transformação sem texto
    showBossTransformation();

          function showBossTransformation() {
    bossTransformation.style.display = 'flex';
    
    // Remover o texto de transformação
    const transformationText = bossTransformation.querySelector('.transformation-text');
    if (transformationText) {
        transformationText.remove();
    }
    
    // Adicionar efeitos visuais
    const effectsContainer = document.createElement('div');
    effectsContainer.style.position = 'absolute';
    effectsContainer.style.width = '100%';
    effectsContainer.style.height = '100%';
    effectsContainer.style.pointerEvents = 'none';
    
    // Criar partículas brilhantes
    for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'absolute';
        particle.style.width = '10px';
        particle.style.height = '10px';
        particle.style.background = 'radial-gradient(circle, #ff6b6b, #e74c3c, #8e44ad)';
        particle.style.borderRadius = '50%';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animation = `particleFloat ${1 + Math.random() * 2}s infinite alternate`;
        
        effectsContainer.appendChild(particle);
    }
    
    // Adicionar brilho pulsante
    const glow = document.createElement('div');
    glow.style.position = 'absolute';
    glow.style.width = '100%';
    glow.style.height = '100%';
    glow.style.background = 'radial-gradient(circle, rgba(231, 76, 60, 0.3) 0%, rgba(142, 68, 173, 0.2) 50%, transparent 70%)';
    glow.style.animation = 'glowPulse 1s infinite alternate';
    
    effectsContainer.appendChild(glow);
    bossTransformation.appendChild(effectsContainer);
    
    // Adicionar estilos CSS para animações
    if (!document.querySelector('#transformation-styles')) {
        const style = document.createElement('style');
        style.id = 'transformation-styles';
        style.textContent = `
            @keyframes particleFloat {
                0% { transform: translateY(0) scale(1); opacity: 1; }
                100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
            }
            @keyframes glowPulse {
                0% { opacity: 0.3; transform: scale(1); }
                100% { opacity: 0.7; transform: scale(1.1); }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        bossTransformation.style.display = 'none';
        effectsContainer.remove();
        
        // Atualizar stats do boss após transformação
        bossEnemyName.textContent = currentBoss.name;
        bossBattleEnemyHealth.textContent = currentBoss.health;
        bossBattleEnemyMaxHealth.textContent = currentBoss.maxHealth;
        bossBattleEnemyAgility.textContent = currentBoss.agility;
        
        // Redesenhar o boss
        currentBoss.drawBattle(bossEnemyCtx);
        
        addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> liberou todo o seu poder!`, "system");
    }, 3000);
}
            
            attackPlayer(player) ;
                if (!this.isTransformed) {
                    // Ataque normal na fase 1
                    return this.attack;
                } else {
                    // Ataques na fase 2
                    const rand = Math.random();
                    
                    if (rand < 0.7) {
                        // Carga Imperial - 70% de chance
                        return { damage: this.attack, type: 'imperialCharge' };
                    } else if (rand < 0.9) {
                        // Névoa das Trevas - 20% de chance
                        player.addStatusEffect({ type: 'poison', duration: 3, damagePerTurn: 5 });
                        if (Math.random() < 0.2) {
                            player.addStatusEffect({ type: 'stun', duration: 1 });
                        }
                        return { damage: 30, type: 'darkMist' };
                    } else {
                        // Revigoração Do Monarca - 10% de chance
                        this.health = Math.min(this.maxHealth, this.health + 100);
                        return { damage: 0, type: 'monarchRevival' };
                    }
                }
            }
            
            updateBattleStatusEffects() {
                // Implementar se necessário
            }
        }

        // Classe do Mercador
        class Merchant {
            constructor(worldMap, biome, isDarkShop = false) {
                this.biome = biome;
                this.isDarkShop = isDarkShop;
                let validPosition = false;
                let attempts = 0;
                
                while (!validPosition && attempts < 100) {
                    this.x = Math.floor(Math.random() * (WORLD_SIZE - 10)) + 5;
                    this.y = Math.floor(Math.random() * (WORLD_SIZE - 10)) + 5;
                    
                    if (worldMap[this.y][this.x] === biome) {
                        validPosition = true;
                    }
                    
                    attempts++;
                }
                
                if (!validPosition) {
                    this.x = Math.floor(WORLD_SIZE / 2);
                    this.y = Math.floor(WORLD_SIZE / 2);
                }
            }
            
            draw() {
                const offsetX = player.x - MAP_WIDTH / 2;
                const offsetY = player.y - MAP_HEIGHT / 2;
                
                const screenX = Math.floor(this.x - offsetX);
                const screenY = Math.floor(this.y - offsetY);
                
                if (screenX >= 0 && screenX < MAP_WIDTH && screenY >= 0 && screenY < MAP_HEIGHT) {
                    const x = screenX * TILE_SIZE;
                    const y = screenY * TILE_SIZE;
                    
                    if (this.isDarkShop) {
                        ctx.fillStyle = COLORS.DARK_SHOP;
                        ctx.fillRect(x + 10, y + 20, TILE_SIZE - 20, TILE_SIZE - 30);
                        
                        ctx.fillStyle = COLORS.DARK_SHOP_DARK;
                        ctx.beginPath();
                        ctx.moveTo(x, y + 20);
                        ctx.lineTo(x + TILE_SIZE / 2, y);
                        ctx.lineTo(x + TILE_SIZE, y + 20);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.fillStyle = '#4a235a';
                        ctx.fillRect(x + TILE_SIZE / 2 - 10, y + 30, 20, 30);
                        
                        ctx.fillStyle = '#8e44ad';
                        ctx.fillRect(x + 15, y + 30, 15, 15);
                        ctx.fillRect(x + TILE_SIZE - 30, y + 30, 15, 15);
                        
                        ctx.fillStyle = '#2c3e50';
                        ctx.fillRect(x, y + TILE_SIZE - 10, TILE_SIZE, 10);
                        
                        ctx.fillStyle = '#e74c3c';
                        ctx.fillRect(x + TILE_SIZE / 2 - 5, y + TILE_SIZE - 20, 10, 15);
                        
                        ctx.fillStyle = '#e74c3c';
                        ctx.font = 'bold 12px MedievalSharp';
                        ctx.textAlign = 'center';
                        ctx.fillText('Loja Negra', x + TILE_SIZE / 2, y - 5);
                    } else {
                        ctx.fillStyle = COLORS.SHOP;
                        ctx.fillRect(x + 10, y + 20, TILE_SIZE - 20, TILE_SIZE - 30);
                        
                        ctx.fillStyle = COLORS.SHOP_DARK;
                        ctx.beginPath();
                        ctx.moveTo(x, y + 20);
                        ctx.lineTo(x + TILE_SIZE / 2, y);
                        ctx.lineTo(x + TILE_SIZE, y + 20);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x + TILE_SIZE / 2 - 10, y + 30, 20, 30);
                        
                        ctx.fillStyle = '#3498db';
                        ctx.fillRect(x + 15, y + 30, 15, 15);
                        ctx.fillRect(x + TILE_SIZE - 30, y + 30, 15, 15);
                        
                        ctx.fillStyle = '#D2691E';
                        ctx.fillRect(x, y + TILE_SIZE - 10, TILE_SIZE, 10);
                        
                        ctx.fillStyle = '#f8c555';
                        ctx.fillRect(x + TILE_SIZE / 2 - 5, y + TILE_SIZE - 20, 10, 15);
                        
                        ctx.fillStyle = '#f8c555';
                        ctx.font = 'bold 12px MedievalSharp';
                        ctx.textAlign = 'center';
                        ctx.fillText('Loja', x + TILE_SIZE / 2, y - 5);
                    }
                }
            }
            
            isPlayerNearby(player) {
                const distance = Math.sqrt(Math.pow(player.x - this.x, 2) + Math.pow(player.y - this.y, 2));
                return distance < 2;
            }
        }

        // Classe do Personagem Misterioso no Pântano
        class MysteriousCharacter {
            constructor(swampCenterX, swampCenterY) {
                this.x = swampCenterX;
                this.y = swampCenterY;
                this.hasInteracted = false;
                this.dialogueStage = 0;
            }
            
            draw() {
                const offsetX = player.x - MAP_WIDTH / 2;
                const offsetY = player.y - MAP_HEIGHT / 2;
                
                const screenX = Math.floor(this.x - offsetX);
                const screenY = Math.floor(this.y - offsetY);
                
                if (screenX >= 0 && screenX < MAP_WIDTH && screenY >= 0 && screenY < MAP_HEIGHT) {
                    const x = screenX * TILE_SIZE;
                    const y = screenY * TILE_SIZE;
                    
                    // Desenhar personagem misterioso
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 20, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.5)';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(142, 68, 173, 0.7)';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Aura
                    ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 25, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            
            isPlayerNearby(player) {
                const distance = Math.sqrt(Math.pow(player.x - this.x, 2) + Math.pow(player.y - this.y, 2));
                return distance < 2;
            }
            
            interact() {
                if (!this.hasInteracted) {
                    this.hasInteracted = true;
                    startDialogue();
                }
            }
        }

        // Variáveis globais do jogo
        let player;
        let worldMap;
        let merchantForest;
        let merchantMountain;
        let darkMerchant;
        let mysteriousCharacter;
        let lastTime = 0;
        let currentMonster = null;
        let isPlayerTurn = true;
        let battleAnimation = null;
        let currentRound = 1;
        let battleEffects = [];
        let attackAnimations = [];
        let keys = {};
        let buttonsLocked = false;
        let isInDialogue = false;
        let currentBoss = null;
        let isBossBattle = false;
        let bossBattleRound = 1;
        let isBossTransformed = false;

        // Variáveis para o diálogo
        let currentDialogue = [];
        let currentDialogueIndex = 0;
        let dialogueTimer = null;
        let isTyping = false;

        function setBattleButtonsLocked(locked) {
            buttonsLocked = locked;
            
            // Selecionar todos os botões de batalha
            const battleButtons = document.querySelectorAll('.battle-action-btn, .use-item-btn');
            
            battleButtons.forEach(btn => {
                if (locked) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        function generateWorldMap() {
            const map = Array(WORLD_SIZE).fill().map(() => Array(WORLD_SIZE).fill(0));
            
            createBiome(map, 2, 15, 20);
            createBiome(map, 3, 10, 15);
            createBiome(map, 6, 8, 12);
            createBiome(map, 9, 5, 8);
            
            // Pântano Abissal - agora é um único quadrado maior
            addSwampArea(map);
            
            addVolcanicArea(map);
            
            for (let i = 0; i < 5; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addWaterBody(map, x, y);
            }
            
            for (let i = 0; i < 5; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addPath(map, x, y);
            }
            
            addFlowers(map);
            
            return map;
        }

        function createBiome(map, biomeType, minSize, maxSize) {
            const numBiomes = 3 + Math.floor(Math.random() * 3);
            
            for (let b = 0; b < numBiomes; b++) {
                const size = minSize + Math.floor(Math.random() * (maxSize - minSize));
                const x = Math.floor(Math.random() * (WORLD_SIZE - size * 2)) + size;
                const y = Math.floor(Math.random() * (WORLD_SIZE - size * 2)) + size;
                
                for (let i = -size; i < size; i++) {
                    for (let j = -size; j < size; j++) {
                        const newX = x + i;
                        const newY = y + j;
                        if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                            const dist = Math.sqrt(i*i + j*j);
                            if (dist < size && Math.random() < 0.8 && map[newY][newX] === 0) {
                                map[newY][newX] = biomeType;
                            }
                        }
                    }
                }
            }
        }

        function addWaterBody(map, x, y) {
            const size = 5 + Math.floor(Math.random() * 8);
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        if (dist < size * (0.7 + Math.random() * 0.3)) {
                            map[newY][newX] = 1;
                        }
                    }
                }
            }
        }

        function addPath(map, x, y) {
            const length = 20 + Math.floor(Math.random() * 30);
            let dirX = Math.random() < 0.5 ? 1 : -1;
            let dirY = Math.random() < 0.5 ? 1 : -1;
            
            if (Math.random() < 0.5) dirY = 0;
            else dirX = 0;
            
            for (let i = 0; i < length; i++) {
                if (x >= 0 && x < WORLD_SIZE && y >= 0 && y < WORLD_SIZE) {
                    if (map[y][x] === 0) {
                        map[y][x] = 4;
                    }
                    
                    if (Math.random() < 0.15) {
                        if (dirX !== 0) {
                            dirY = Math.random() < 0.5 ? 1 : -1;
                            dirX = 0;
                        } else {
                            dirX = Math.random() < 0.5 ? 1 : -1;
                            dirY = 0;
                        }
                    }
                    
                    x += dirX;
                    y += dirY;
                }
            }
        }

        function addVolcanicArea(map) {
            const centerX = Math.floor(Math.random() * (WORLD_SIZE - 20)) + 10;
            const centerY = Math.floor(Math.random() * (WORLD_SIZE - 20)) + 10;
            const size = 8 + Math.floor(Math.random() * 5);
            
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = centerX + i;
                    const newY = centerY + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        if (dist < size) {
                            if (dist < size * 0.3) {
                                map[newY][newX] = 8;
                            } else {
                                map[newY][newX] = 7;
                            }
                        }
                    }
                }
            }
        }

        function addSwampArea(map) {
            // Pântano Abissal - agora é um único quadrado maior
            const centerX = Math.floor(Math.random() * (WORLD_SIZE - 25)) + 12;
            const centerY = Math.floor(Math.random() * (WORLD_SIZE - 25)) + 12;
            const size = 12 + Math.floor(Math.random() * 6); // Maior que o vulcão
            
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = centerX + i;
                    const newY = centerY + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        if (dist < size) {
                            map[newY][newX] = 10;
                        }
                    }
                }
            }
            
            // Adicionar personagem misterioso no centro do pântano
            mysteriousCharacter = new MysteriousCharacter(centerX, centerY);
        }

        function addFlowers(map) {
            for (let y = 0; y < WORLD_SIZE; y++) {
                for (let x = 0; x < WORLD_SIZE; x++) {
                    if (map[y][x] === 0 && Math.random() < 0.03) {
                        map[y][x] = 5;
                    }
                }
            }
        }

        // Funções de desenho do mapa
        function drawMap(worldMap, player) {
    const offsetX = player.x - MAP_WIDTH / 2;
    const offsetY = player.y - MAP_HEIGHT / 2;
    
    // Desenhar fundo padrão para áreas fora do mapa
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    for (let y = 0; y < MAP_HEIGHT; y++) {
        for (let x = 0; x < MAP_WIDTH; x++) {
            const mapX = Math.floor(offsetX + x);
            const mapY = Math.floor(offsetY + y);
            
            let tileType = 0;
            let color = COLORS.GRASS;
            
            // Verificar se está dentro dos limites do mapa
            if (mapX >= 0 && mapX < WORLD_SIZE && mapY >= 0 && mapY < WORLD_SIZE) {
                tileType = worldMap[mapY][mapX];
            } else {
                // Fora do mapa - desenhar barreira
                tileType = -1;
            }
            
            switch (tileType) {
                case -1: // Barreira do mapa
                    color = '#2c3e50';
                    break;
                case 0:
                    color = COLORS.GRASS;
                    break;
                case 1:
                    color = COLORS.WATER;
                    break;
                case 2:
                    color = COLORS.FOREST;
                    break;
                case 3:
                    color = COLORS.MOUNTAIN;
                    break;
                case 4:
                    color = COLORS.PATH;
                    break;
                case 5:
                    color = COLORS.GRASS;
                    break;
                case 6:
                    color = COLORS.SAND;
                    break;
                case 7:
                    color = COLORS.VOLCANIC;
                    break;
                case 8:
                    color = COLORS.LAVA;
                    break;
                case 9:
                    color = COLORS.DARK_FOREST;
                    break;
                case 10:
                    color = COLORS.SWAMP;
                    break;
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            if (tileType === -1) {
                // Desenhar barreira decorativa
                ctx.fillStyle = '#34495e';
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        const barrierX = x * TILE_SIZE + 8 + i * 12;
                        const barrierY = y * TILE_SIZE + 8 + j * 12;
                        ctx.fillRect(barrierX, barrierY, 8, 8);
                    }
                }
                ctx.strokeStyle = '#7f8c8d';
                ctx.lineWidth = 2;
                ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else if (tileType === 0) {
                ctx.fillStyle = COLORS.GRASS_DARK;
                for (let i = 0; i < 8; i++) {
                    const detailX = x * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    const detailY = y * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    ctx.fillRect(detailX, detailY, 2, 2);
                }
            } else if (tileType === 1) {
                ctx.fillStyle = COLORS.WATER_DARK;
                for (let i = 0; i < 6; i++) {
                    const waveX = x * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                    const waveY = y * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                    ctx.beginPath();
                    ctx.ellipse(waveX, waveY, 12, 6, Math.random() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (tileType === 2) {
                const treeX = x * TILE_SIZE + TILE_SIZE / 2;
                const treeY = y * TILE_SIZE + TILE_SIZE / 2;
                
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(treeX - 4, treeY, 8, TILE_SIZE / 2);
                
                ctx.fillStyle = COLORS.FOREST_DARK;
                ctx.beginPath();
                ctx.arc(treeX, treeY - 8, TILE_SIZE / 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#229954';
                ctx.beginPath();
                ctx.arc(treeX - 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                ctx.arc(treeX + 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                ctx.fill();
            } else if (tileType === 3) {
                ctx.fillStyle = COLORS.MOUNTAIN_DARK;
                for (let i = 0; i < 8; i++) {
                    const rockX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    const rockY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    ctx.beginPath();
                    ctx.ellipse(rockX, rockY, 10, 6, Math.random() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (Math.random() < 0.4) {
                    ctx.fillStyle = '#ecf0f1';
                    ctx.beginPath();
                    ctx.moveTo(x * TILE_SIZE + 10, y * TILE_SIZE + 15);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE - 10, y * TILE_SIZE + 15);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + 5);
                    ctx.closePath();
                    ctx.fill();
                }
            } else if (tileType === 4) {
                ctx.fillStyle = COLORS.PATH_DARK;
                for (let i = 0; i < 6; i++) {
                    const stoneX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    const stoneY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    ctx.beginPath();
                    ctx.ellipse(stoneX, stoneY, 8, 5, 0, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (tileType === 5) {
                const flowerX = x * TILE_SIZE + TILE_SIZE / 2;
                const flowerY = y * TILE_SIZE + TILE_SIZE / 2;
                
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(flowerX - 1, flowerY, 2, TILE_SIZE / 3);
                
                const flowerColor = [COLORS.FLOWER1, COLORS.FLOWER2, COLORS.FLOWER3][Math.floor(Math.random() * 3)];
                ctx.fillStyle = flowerColor;
                ctx.beginPath();
                ctx.arc(flowerX, flowerY - 5, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#f1c40f';
                ctx.beginPath();
                ctx.arc(flowerX, flowerY - 5, 3, 0, Math.PI * 2);
                ctx.fill();
            } else if (tileType === 6) {
                ctx.fillStyle = COLORS.SAND_DARK;
                for (let i = 0; i < 10; i++) {
                    const sandX = x * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    const sandY = y * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    ctx.beginPath();
                    ctx.arc(sandX, sandY, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (tileType === 7) {
                ctx.fillStyle = COLORS.VOLCANIC_DARK;
                for (let i = 0; i < 12; i++) {
                    const rockX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    const rockY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    ctx.beginPath();
                    ctx.ellipse(rockX, rockY, 8, 5, Math.random() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (Math.random() < 0.3) {
                    ctx.fillStyle = COLORS.LAVA;
                    ctx.beginPath();
                    ctx.arc(x * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20), 
                           y * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20), 
                           5, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (tileType === 8) {
                ctx.fillStyle = COLORS.LAVA_DARK;
                for (let i = 0; i < 15; i++) {
                    const lavaX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    const lavaY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    ctx.beginPath();
                    ctx.ellipse(lavaX, lavaY, 6, 4, Math.random() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.fillStyle = COLORS.LAVA;
                for (let i = 0; i < 8; i++) {
                    const bubbleX = x * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                    const bubbleY = y * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                    ctx.beginPath();
                    ctx.arc(bubbleX, bubbleY, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (tileType === 9) {
                ctx.fillStyle = COLORS.DARK_FOREST_DARK;
                for (let i = 0; i < 8; i++) {
                    const detailX = x * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    const detailY = y * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                    ctx.fillRect(detailX, detailY, 2, 2);
                }
                
                const treeX = x * TILE_SIZE + TILE_SIZE / 2;
                const treeY = y * TILE_SIZE + TILE_SIZE / 2;
                
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(treeX - 4, treeY, 8, TILE_SIZE / 2);
                
                ctx.fillStyle = '#1b2631';
                ctx.beginPath();
                ctx.arc(treeX, treeY - 8, TILE_SIZE / 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#1b5e20';
                ctx.beginPath();
                ctx.arc(treeX - 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                ctx.arc(treeX + 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                ctx.fill();
            } else if (tileType === 10) {
                ctx.fillStyle = COLORS.SWAMP_DARK;
                for (let i = 0; i < 8; i++) {
                    const detailX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    const detailY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                    ctx.beginPath();
                    ctx.ellipse(detailX, detailY, 8, 5, Math.random() * Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Adicionar bolhas de gás
                if (Math.random() < 0.2) {
                    ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
                    ctx.beginPath();
                    ctx.arc(x * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20), 
                           y * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20), 
                           4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
    }
    
    merchantForest.draw();
    merchantMountain.draw();
    darkMerchant.draw();
    
    // Desenhar personagem misterioso se existir e não tiver interagido
    if (mysteriousCharacter && !mysteriousCharacter.hasInteracted) {
        mysteriousCharacter.draw();
    }
    
    if (merchantForest.isPlayerNearby(player) || merchantMountain.isPlayerNearby(player)) {
        ctx.fillStyle = '#f8c555';
        ctx.font = 'bold 14px MedievalSharp';
        ctx.textAlign = 'center';
        ctx.fillText('Pressione E para interagir', canvas.width / 2, canvas.height - 20);
    } else if (darkMerchant.isPlayerNearby(player)) {
        ctx.fillStyle = '#e74c3c';
        ctx.font = 'bold 14px MedievalSharp';
        ctx.textAlign = 'center';
        ctx.fillText('Pressione E para interagir', canvas.width / 2, canvas.height - 20);
    } else if (mysteriousCharacter && mysteriousCharacter.isPlayerNearby(player) && !mysteriousCharacter.hasInteracted) {
        ctx.fillStyle = '#e74c3c';
        ctx.font = 'bold 14px MedievalSharp';
        ctx.textAlign = 'center';
        ctx.fillText('Pressione E para interagir', canvas.width / 2, canvas.height - 20);
    }
}

        // Funções de batalha
        function startBattle() {
            const rand = Math.random();
            let monsterType = 'weak';
            
            if (rand < 0.5) {
                monsterType = 'weak';
            } else if (rand < 0.8) {
                monsterType = 'strong';
            } else if (rand < 0.95) {
                monsterType = 'elite';
            } else {
                monsterType = 'darkMage';
            }
            
            const currentTile = worldMap[Math.floor(player.y)][Math.floor(player.x)];
            if (currentTile === 7 && Math.random() < 0.5) {
                monsterType = 'elite';
            } else if (currentTile === 3 && Math.random() < 0.3) {
                monsterType = 'strong';
            } else if (currentTile === 2 && Math.random() < 0.3) {
                monsterType = 'weak';
            } else if (currentTile === 9 && Math.random() < 0.4) {
                monsterType = 'darkMage';
            }
            
            currentMonster = new Monster(monsterType, worldMap, player.x, player.y, player.level);
            isPlayerTurn = true;
            battleAnimation = null;
            currentRound = 1;
            battleEffects = [];
            buttonsLocked = false; // Resetar estado dos botões
            
            player.clearStatusEffects();
            if (currentMonster) currentMonster.statusEffects = [];
            
            battleEnemyLevel.textContent = currentMonster.level;
            battleEnemyHealth.textContent = currentMonster.health;
            battleEnemyMaxHealth.textContent = currentMonster.maxHealth;
            battleEnemyAgility.textContent = currentMonster.agility;
            enemyName.textContent = currentMonster.name;
            
            roundIndicator.textContent = `Round ${currentRound}`;
            
            addBattleLog("Uma batalha começou!", "system");
            
            battleScreen.style.display = 'flex';
            showMainBattleActions();
            
            player.drawBattle(playerCtx);
            currentMonster.drawBattle(enemyCtx);
            
            // Garantir que os botões estejam desbloqueados no início da batalha
            setBattleButtonsLocked(false);
        }

        function startSwampBattle() {
            currentMonster = new SwampMonster(player.level);
            isPlayerTurn = true;
            battleAnimation = null;
            currentRound = 1;
            battleEffects = [];
            buttonsLocked = false;
            
            player.clearStatusEffects();
            if (currentMonster) currentMonster.statusEffects = [];
            
            battleEnemyLevel.textContent = currentMonster.level;
            battleEnemyHealth.textContent = currentMonster.health;
            battleEnemyMaxHealth.textContent = currentMonster.maxHealth;
            battleEnemyAgility.textContent = currentMonster.agility;
            enemyName.textContent = currentMonster.name;
            
            roundIndicator.textContent = `Round ${currentRound}`;
            
            addBattleLog("Um monstro do pântano apareceu!", "system");
            
            battleScreen.style.display = 'flex';
            showMainBattleActions();
            
            player.drawBattle(playerCtx);
            currentMonster.drawBattle(enemyCtx);
            
            setBattleButtonsLocked(false);
        }

        function startBossBattle() {
            currentBoss = new CorruptedKing();
            isPlayerTurn = true;
            isBossBattle = true;
            bossBattleRound = 1;
            buttonsLocked = false;
            
            player.clearStatusEffects();
            if (currentBoss) currentBoss.statusEffects = [];
            
            bossBattlePlayerLevel.textContent = player.level;
            bossBattlePlayerHealth.textContent = player.health;
            bossBattlePlayerMaxHealth.textContent = player.maxHealth;
            bossBattlePlayerMana.textContent = player.mana;
            bossBattlePlayerMaxMana.textContent = player.maxMana;
            bossBattlePlayerStamina.textContent = player.stamina;
            bossBattlePlayerMaxStamina.textContent = player.maxStamina;
            
            bossEnemyName.textContent = currentBoss.name;
            bossBattleEnemyLevel.textContent = currentBoss.level;
            bossBattleEnemyHealth.textContent = currentBoss.health;
            bossBattleEnemyMaxHealth.textContent = currentBoss.maxHealth;
            bossBattleEnemyAgility.textContent = currentBoss.agility;
            
            bossRoundIndicator.textContent = `Round ${bossBattleRound}`;
            
            addBossBattleLog("Uma batalha épica começou!", "system");
            
            bossBattleScreen.style.display = 'flex';
            showBossMainBattleActions();
            
            player.drawBossBattle(bossPlayerCtx);
            currentBoss.drawBattle(bossEnemyCtx);
            
            setBossBattleButtonsLocked(false);
        }

        function showMainBattleActions() {
            battleActionsPokemon.style.display = 'grid';
            attackOptionsPokemon.style.display = 'none';
            magicOptionsPokemon.style.display = 'none';
            itemsOptionsPokemon.style.display = 'none';
            actOptionsPokemon.style.display = 'none';
            
            // Garantir que os botões estejam desbloqueados quando mostrar as ações principais
            if (isPlayerTurn && !battleAnimation) {
                setBattleButtonsLocked(false);
            }
        }

        function showBossMainBattleActions() {
            bossBattleActionsPokemon.style.display = 'grid';
            
            // Garantir que os botões estejam desbloqueados quando mostrar as ações principais
            if (isPlayerTurn && !battleAnimation) {
                setBossBattleButtonsLocked(false);
            }
        }

        function showAttackOptions() {
            battleActionsPokemon.style.display = 'none';
            attackOptionsPokemon.style.display = 'grid';
            
            // Garantir que os botões estejam desbloqueados quando mostrar opções de ataque
            if (isPlayerTurn && !battleAnimation) {
                setBattleButtonsLocked(false);
            }
        }

        function showMagicOptions() {
            battleActionsPokemon.style.display = 'none';
            magicOptionsPokemon.style.display = 'grid';
            
            // Garantir que os botões estejam desbloqueados quando mostrar opções de magia
            if (isPlayerTurn && !battleAnimation) {
                setBattleButtonsLocked(false);
            }
        }

        function showItemsOptions() {
            battleActionsPokemon.style.display = 'none';
            itemsOptionsPokemon.style.display = 'grid';
            player.updateBattleItems();
            
            // Garantir que os botões estejam desbloqueados quando mostrar opções de itens
            if (isPlayerTurn && !battleAnimation) {
                setBattleButtonsLocked(false);
            }
        }

        function showActOptions() {
            battleActionsPokemon.style.display = 'none';
            actOptionsPokemon.style.display = 'grid';
            
            // Garantir que os botões estejam desbloqueados quando mostrar opções de ação
            if (isPlayerTurn && !battleAnimation) {
                setBattleButtonsLocked(false);
            }
        }

        function playerAttack(attackType) {
            if (!isPlayerTurn || battleAnimation || buttonsLocked) return;
            
            // Bloquear botões imediatamente
            setBattleButtonsLocked(true);
            
            let damage = 0;
            let isCritical = false;
            let message = "";
            let attackResult = null;
            
            if (attackType === 'sword') {
                damage = player.swordAttack();
                isCritical = damage > (5 + Math.floor(player.strength * 0.5));
                
                message = `<span class="log-player">Cavaleiro</span> usa <span class="log-skill">Espadada</span>!`;
                
                createSwordEffect();
                
            } else if (attackType === 'charge') {
                attackResult = player.chargeAttack();
                
                if (!attackResult.success) {
                    addBattleLog(attackResult.message, "system");
                    showMainBattleActions();
                    // Desbloquear botões se falhou
                    setBattleButtonsLocked(false);
                    return;
                }
                
                damage = attackResult.damage;
                isCritical = attackResult.isCritical;
                
                message = `<span class="log-player">Cavaleiro</span> usa <span class="log-skill">Investida</span>!`;
                
                createChargeEffect();
            }
            
            addBattleLog(message, "player");
            
            battleAnimation = {
                type: 'playerAttack',
                step: 0,
                maxSteps: 20,
                attackType: attackType
            };
            
            animateBattle();
            
            setTimeout(() => {
                if (Math.random() < currentMonster.dodgeChance) {
                    addBattleLog(`<span class="log-enemy">${currentMonster.name}</span> desviou do ataque!`, "enemy");
                    createMissEffect();
                } else {
                    const actualDamage = currentMonster.takeDamage(damage);
                    
                    createDamageEffect(actualDamage, "enemy");
                    
                    if (isCritical) {
                        addBattleLog(` <span class="log-effect">CRÍTICO!</span> Causou ${actualDamage} de dano!`, "system");
                    } else {
                        addBattleLog(` Causou ${actualDamage} de dano!`, "system");
                    }
                    
                    battleEnemyHealth.textContent = currentMonster.health;
                    
                    if (currentMonster.health <= 0) {
                        endBattle(true);
                        return;
                    }
                }
                
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }, 800);
        }

       function showBossAttackOptions() {
    bossBattleActionsPokemon.style.display = 'none';
    bossAttackOptionsPokemon.style.display = 'grid';
    setBossBattleButtonsLocked(false);
}

function showBossMagicOptions() {
    bossBattleActionsPokemon.style.display = 'none';
    bossMagicOptionsPokemon.style.display = 'grid';
    setBossBattleButtonsLocked(false);
}

function showBossItemsOptions() {
    bossBattleActionsPokemon.style.display = 'none';
    bossItemsOptionsPokemon.style.display = 'grid';
    player.updateBossBattleItems();
    setBossBattleButtonsLocked(false);
}

function showBossActOptions() {
    bossBattleActionsPokemon.style.display = 'none';
    bossActOptionsPokemon.style.display = 'grid';
    setBossBattleButtonsLocked(false);
}

function playerBossAttack(attackType) {
    if (!isPlayerTurn || buttonsLocked) return;
    
    setBossBattleButtonsLocked(true);
    
    let damage = 0;
    let isCritical = false;
    let message = "";
    let attackResult = null;
    
    if (attackType === 'sword') {
        damage = player.swordAttack();
        isCritical = damage > (5 + Math.floor(player.strength * 0.5));
        
        message = `<span class="log-player">Cavaleiro</span> usa <span class="log-skill">Espadada</span>!`;
        
    } else if (attackType === 'charge') {
        attackResult = player.chargeAttack();
        
        if (!attackResult.success) {
            addBossBattleLog(attackResult.message, "system");
            showBossMainBattleActions();
            setBossBattleButtonsLocked(false);
            return;
        }
        
        damage = attackResult.damage;
        isCritical = attackResult.isCritical;
        
        message = `<span class="log-player">Cavaleiro</span> usa <span class="log-skill">Investida</span>!`;
    } else if (attackType === 'heavyArmor') {
        attackResult = player.activateHeavyArmor();
        
        if (!attackResult.success) {
            addBossBattleLog(attackResult.message, "system");
            showBossMainBattleActions();
            setBossBattleButtonsLocked(false);
            return;
        }
        
        message = attackResult.message;
    }
    
    addBossBattleLog(message, "player");
    
    setTimeout(() => {
        if (attackType === 'heavyArmor') {
            // Habilidade defensiva, não causa dano
            player.updateUI();
            isPlayerTurn = false;
            setTimeout(bossTurn, 1000);
            return;
        }
        
        if (Math.random() < currentBoss.dodgeChance) {
            addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> desviou do ataque!`, "enemy");
        } else {
            const actualDamage = currentBoss.takeDamage(damage);
            
            if (isCritical) {
                addBossBattleLog(` <span class="log-effect">CRÍTICO!</span> Causou ${actualDamage} de dano!`, "system");
            } else {
                addBossBattleLog(` Causou ${actualDamage} de dano!`, "system");
            }
            
            bossBattleEnemyHealth.textContent = currentBoss.health;
            
            if (currentBoss.health <= 0 && currentBoss.isTransformed) {
                endBossBattle(true);
                return;
            }
        }
        
        currentBoss.updateStatusEffects();
        player.updateUI();
        
        isPlayerTurn = false;
        setTimeout(bossTurn, 1000);
    }, 800);
}

function playerBossMagic(spellType) {
    if (!isPlayerTurn || buttonsLocked) return;
    setBossBattleButtonsLocked(true);
    let damage = 0;
    let message = "";
    let manaCost = 0;
    let statusEffect = null;
    let burnChance = 0;
    
    switch(spellType) {
        case 'fireball':
            if (player.baseMag < 12) {
                addBossBattleLog("Você precisa de pelo menos 12 pontos em Magia para usar Bola de Fogo!", "system");
                showBossMainBattleActions();
                return;
            }
            
            manaCost = 30;
            if (!player.useMana(manaCost)) {
                addBossBattleLog("Mana insuficiente para lançar Bola de Fogo!", "system");
                showBossMainBattleActions();
                return;
            }
            
            damage = 20 + Math.floor(player.magic * 0.8);
            message = `<span class="log-player">Cavaleiro</span> conjura <span class="log-skill">Bola de Fogo</span>!`;
            burnChance = 0.5;
            break;
            
        case 'freeze':
            if (player.baseMag < 15) {
                addBossBattleLog("Você precisa de pelo menos 15 pontos em Magia para usar Brisa Congelante!", "system");
                showBossMainBattleActions();
                return;
            }
            
            manaCost = 40;
            if (!player.useMana(manaCost)) {
                addBossBattleLog("Mana insuficiente para lançar Brisa Congelante!", "system");
                showBossMainBattleActions();
                return;
            }
            
            damage = 10 + Math.floor(player.magic * 0.5);
            message = `<span class="log-player">Cavaleiro</span> invoca <span class="log-skill">Brisa Congelante</span>!`;
            statusEffect = { type: 'slow', duration: 3 };
            break;
            
        case 'possession':
            if (player.baseMag < 20) {
                addBossBattleLog("Você precisa de pelo menos 20 pontos em Magia para usar Posseção!", "system");
                showBossMainBattleActions();
                return;
            }
            
            manaCost = 65;
            if (!player.useMana(manaCost)) {
                addBossBattleLog("Mana insuficiente para lançar Posseção!", "system");
                showBossMainBattleActions();
                return;
            }
            
            damage = 25 + Math.floor(player.magic * 1.2);
            message = `<span class="log-player">Cavaleiro</span> lança <span class="log-skill">Posseção</span>!`;
            statusEffect = { type: 'stun', duration: 3 };
            break;
    }
    
    addBossBattleLog(message, "player");
    
    setTimeout(() => {
        if (Math.random() < currentBoss.dodgeChance) {
            addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> desviou do feitiço!`, "enemy");
        } else {
            const actualDamage = currentBoss.takeDamage(damage);
            
            addBossBattleLog(` O feitiço causou ${actualDamage} de dano!`, "system");
            
            if (spellType === 'fireball' && Math.random() < burnChance) {
                currentBoss.addStatusEffect({ type: 'burn', duration: 3 });
                addBossBattleLog(` <span class="log-enemy">${currentBoss.name}</span> foi <span class="log-effect">queimado</span>!`, "system");
            } else if (statusEffect) {
                currentBoss.addStatusEffect(statusEffect);
                addBossBattleLog(` <span class="log-enemy">${currentBoss.name}</span> foi afetado por <span class="log-effect">${statusEffect.type.toUpperCase()}</span>!`, "system");
            }
            
            bossBattleEnemyHealth.textContent = currentBoss.health;
            
            if (currentBoss.health <= 0 && currentBoss.isTransformed) {
                endBossBattle(true);
                return;
            }
        }
        
        currentBoss.updateStatusEffects();
        player.updateUI();
        
        isPlayerTurn = false;
        setTimeout(bossTurn, 1000);
    }, 1000);
}

function playerBossUseItem(itemType) {
    if (!isPlayerTurn || buttonsLocked) return;
    
    setBossBattleButtonsLocked(true);
    
    const result = player.useItem(itemType);
    
    if (result.success) {
        addBossBattleLog(result.message, "player");
        
        player.updateUI();
        
        isPlayerTurn = false;
        setTimeout(bossTurn, 1000);
    } else {
        addBossBattleLog(result.message, "system");
        showBossMainBattleActions();
        setBossBattleButtonsLocked(false);
    }
}

function playerBossAct(actionType) {
    if (!isPlayerTurn || buttonsLocked) return;
    
    setBossBattleButtonsLocked(true);
    
    let message = "";
    
    if (actionType === 'meditate') {
        message = player.meditate();
        addBossBattleLog(message, "player");
        
        player.updateUI();
        
        isPlayerTurn = false;
        setTimeout(bossTurn, 1000);
    } else if (actionType === 'rest') {
        if (player.baseStr < 16) {
            addBossBattleLog("Você precisa de pelo menos 16 pontos em Força para usar Descansar!", "system");
            showBossMainBattleActions();
            setBossBattleButtonsLocked(false);
            return;
        }
        
        message = player.rest();
        addBossBattleLog(message, "player");
        
        player.updateUI();
        
        isPlayerTurn = false;
        setTimeout(bossTurn, 1000);
    } else if (actionType === 'flee') {
        addBossBattleLog("Você não pode fugir desta batalha!", "system");
        showBossMainBattleActions();
        setBossBattleButtonsLocked(false);
    }
}

        function playerMagic(spellType) {
            if (!isPlayerTurn || battleAnimation) return;
            setBattleButtonsLocked(true);
            let damage = 0;
            let message = "";
            let manaCost = 0;
            let statusEffect = null;
            let burnChance = 0;
            
            switch(spellType) {
                case 'fireball':
                    if (player.baseMag < 12) {
                        addBattleLog("Você precisa de pelo menos 12 pontos em Magia para usar Bola de Fogo!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    manaCost = 30;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Bola de Fogo!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    damage = 20 + Math.floor(player.magic * 0.8);
                    message = `<span class="log-player">Cavaleiro</span> conjura <span class="log-skill">Bola de Fogo</span>!`;
                    burnChance = 0.5;
                    
                    createFireballEffect();
                    break;
                    
                case 'freeze':
                    if (player.baseMag < 15) {
                        addBattleLog("Você precisa de pelo menos 15 pontos em Magia para usar Brisa Congelante!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    manaCost = 40;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Brisa Congelante!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    damage = 10 + Math.floor(player.magic * 0.5);
                    message = `<span class="log-player">Cavaleiro</span> invoca <span class="log-skill">Brisa Congelante</span>!`;
                    statusEffect = { type: 'slow', duration: 3 };
                    
                    createFreezeEffect();
                    break;
                    
                case 'possession':
                    if (player.baseMag < 20) {
                        addBattleLog("Você precisa de pelo menos 20 pontos em Magia para usar Posseção!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    manaCost = 65;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Posseção!", "system");
                        showMainBattleActions();
                        return;
                    }
                    
                    damage = 25 + Math.floor(player.magic * 1.2);
                    message = `<span class="log-player">Cavaleiro</span> lança <span class="log-skill">Posseção</span>!`;
                    statusEffect = { type: 'stun', duration: 3 };
                    
                    createPossessionEffect();
                    break;
            }
            
            addBattleLog(message, "player");
            
            battleAnimation = {
                type: 'playerMagic',
                step: 0,
                maxSteps: 25,
                spell: spellType
            };
            
            animateBattle();
            
            setTimeout(() => {
                if (Math.random() < currentMonster.dodgeChance) {
                    addBattleLog(`<span class="log-enemy">${currentMonster.name}</span> desviou do feitiço!`, "enemy");
                    createMissEffect();
                } else {
                    const actualDamage = currentMonster.takeDamage(damage);
                    
                    createDamageEffect(actualDamage, "enemy");
                    
                    addBattleLog(` O feitiço causou ${actualDamage} de dano!`, "system");
                    
                    if (spellType === 'fireball' && Math.random() < burnChance) {
                        currentMonster.addStatusEffect({ type: 'burn', duration: 3 });
                        addBattleLog(` <span class="log-enemy">${currentMonster.name}</span> foi <span class="log-effect">queimado</span>!`, "system");
                        createBurnEffect();
                    } else if (statusEffect) {
                        currentMonster.addStatusEffect(statusEffect);
                        addBattleLog(` <span class="log-enemy">${currentMonster.name}</span> foi afetado por <span class="log-effect">${statusEffect.type.toUpperCase()}</span>!`, "system");
                        createStatusEffect(statusEffect.type);
                    }
                    
                    battleEnemyHealth.textContent = currentMonster.health;
                    
                    if (currentMonster.health <= 0) {
                        endBattle(true);
                        return;
                    }
                }
                
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }, 1000);
        }

        function playerBossMagic(spellType) {
            if (!isPlayerTurn || buttonsLocked) return;
            setBossBattleButtonsLocked(true);
            let damage = 0;
            let message = "";
            let manaCost = 0;
            let statusEffect = null;
            let burnChance = 0;
            
            switch(spellType) {
                case 'fireball':
                    if (player.baseMag < 12) {
                        addBossBattleLog("Você precisa de pelo menos 12 pontos em Magia para usar Bola de Fogo!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    manaCost = 30;
                    if (!player.useMana(manaCost)) {
                        addBossBattleLog("Mana insuficiente para lançar Bola de Fogo!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    damage = 20 + Math.floor(player.magic * 0.8);
                    message = `<span class="log-player">Cavaleiro</span> conjura <span class="log-skill">Bola de Fogo</span>!`;
                    burnChance = 0.5;
                    break;
                    
                case 'freeze':
                    if (player.baseMag < 15) {
                        addBossBattleLog("Você precisa de pelo menos 15 pontos em Magia para usar Brisa Congelante!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    manaCost = 40;
                    if (!player.useMana(manaCost)) {
                        addBossBattleLog("Mana insuficiente para lançar Brisa Congelante!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    damage = 10 + Math.floor(player.magic * 0.5);
                    message = `<span class="log-player">Cavaleiro</span> invoca <span class="log-skill">Brisa Congelante</span>!`;
                    statusEffect = { type: 'slow', duration: 3 };
                    break;
                    
                case 'possession':
                    if (player.baseMag < 20) {
                        addBossBattleLog("Você precisa de pelo menos 20 pontos em Magia para usar Posseção!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    manaCost = 65;
                    if (!player.useMana(manaCost)) {
                        addBossBattleLog("Mana insuficiente para lançar Posseção!", "system");
                        showBossMainBattleActions();
                        return;
                    }
                    
                    damage = 25 + Math.floor(player.magic * 1.2);
                    message = `<span class="log-player">Cavaleiro</span> lança <span class="log-skill">Posseção</span>!`;
                    statusEffect = { type: 'stun', duration: 3 };
                    break;
            }
            
            addBossBattleLog(message, "player");
            
            setTimeout(() => {
                if (Math.random() < currentBoss.dodgeChance) {
                    addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> desviou do feitiço!`, "enemy");
                } else {
                    const actualDamage = currentBoss.takeDamage(damage);
                    
                    addBossBattleLog(` O feitiço causou ${actualDamage} de dano!`, "system");
                    
                    if (spellType === 'fireball' && Math.random() < burnChance) {
                        currentBoss.addStatusEffect({ type: 'burn', duration: 3 });
                        addBossBattleLog(` <span class="log-enemy">${currentBoss.name}</span> foi <span class="log-effect">queimado</span>!`, "system");
                    } else if (statusEffect) {
                        currentBoss.addStatusEffect(statusEffect);
                        addBossBattleLog(` <span class="log-enemy">${currentBoss.name}</span> foi afetado por <span class="log-effect">${statusEffect.type.toUpperCase()}</span>!`, "system");
                    }
                    
                    bossBattleEnemyHealth.textContent = currentBoss.health;
                    
                    // Verificar se o boss foi derrotado
                    if (currentBoss.health <= 0 && currentBoss.isTransformed) {
                        endBossBattle(true);
                        return;
                    }
                }
                
                currentBoss.updateStatusEffects();
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(bossTurn, 1000);
            }, 1000);
        }

        function playerUseItem(itemType) {
            if (!isPlayerTurn || battleAnimation || buttonsLocked) return;
            
            // Bloquear botões imediatamente
            setBattleButtonsLocked(true);
            
            const result = player.useItem(itemType);
            
            if (result.success) {
                addBattleLog(result.message, "player");
                
                createItemUseEffect(itemType);
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            } else {
                addBattleLog(result.message, "system");
                showMainBattleActions();
                setBattleButtonsLocked(false);
            }
        }

        function playerBossUseItem(itemType) {
            if (!isPlayerTurn || buttonsLocked) return;
            
            // Bloquear botões imediatamente
            setBossBattleButtonsLocked(true);
            
            const result = player.useItem(itemType);
            
            if (result.success) {
                addBossBattleLog(result.message, "player");
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(bossTurn, 1000);
            } else {
                addBossBattleLog(result.message, "system");
                showBossMainBattleActions();
                setBossBattleButtonsLocked(false);
            }
        }

        function playerAct(actionType) {
            if (!isPlayerTurn || battleAnimation || buttonsLocked) return;
            
            // Bloquear botões imediatamente
            setBattleButtonsLocked(true);
            
            let message = "";
            
            if (actionType === 'meditate') {
                message = player.meditate();
                addBattleLog(message, "player");
                
                createMeditateEffect();
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            } else if (actionType === 'rest') {
                if (player.baseStr < 16) {
                    addBattleLog("Você precisa de pelo menos 16 pontos em Força para usar Descansar!", "system");
                    showMainBattleActions();
                    setBattleButtonsLocked(false);
                    return;
                }
                
                message = player.rest();
                addBattleLog(message, "player");
                
                createRestEffect();
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            } else if (actionType === 'flee') {
                let fleeChance = 0;
                
                if (currentMonster.type === 'weak') {
                    fleeChance = 0.2 + (player.baseAgi - 10) * 0.005;
                } else if (currentMonster.type === 'strong') {
                    fleeChance = 0.1 + (player.baseAgi - 10) * 0.005;
                } else if (currentMonster.type === 'elite') {
                    fleeChance = 0.05 + (player.baseAgi - 10) * 0.005;
                } else if (currentMonster.type === 'darkMage') {
                    fleeChance = 0.01 + (player.baseAgi - 10) * 0.005;
                }
                
                if (Math.random() < fleeChance) {
                    addBattleLog("Você conseguiu fugir da batalha!", "system");
                    
                    setTimeout(() => {
                        battleScreen.style.display = 'none';
                        player.updateUI();
                        setBattleButtonsLocked(false);
                    }, 1500);
                } else {
                    addBattleLog("Você não conseguiu fugir!", "system");
                    
                    isPlayerTurn = false;
                    setTimeout(monsterTurn, 1000);
                }
            }
        }

        function playerBossAct(actionType) {
            if (!isPlayerTurn || buttonsLocked) return;
            
            // Bloquear botões imediatamente
            setBossBattleButtonsLocked(true);
            
            let message = "";
            
            if (actionType === 'meditate') {
                message = player.meditate();
                addBossBattleLog(message, "player");
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(bossTurn, 1000);
            } else if (actionType === 'rest') {
                if (player.baseStr < 16) {
                    addBossBattleLog("Você precisa de pelo menos 16 pontos em Força para usar Descansar!", "system");
                    showBossMainBattleActions();
                    setBossBattleButtonsLocked(false);
                    return;
                }
                
                message = player.rest();
                addBossBattleLog(message, "player");
                
                player.updateUI();
                
                isPlayerTurn = false;
                setTimeout(bossTurn, 1000);
            } else if (actionType === 'flee') {
                addBossBattleLog("Você não pode fugir desta batalha!", "system");
                showBossMainBattleActions();
                setBossBattleButtonsLocked(false);
            }
        }

        function monsterTurn() {
            if (isPlayerTurn) return;
            
            player.recoverStamina(10);
            player.updateUI();
            
            if (currentMonster.hasStatusEffect('stun')) {
                addBattleLog(`<span class="log-enemy">${currentMonster.name}</span> está <span class="log-effect">atordoado</span> e perdeu a vez!`, "system");
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                
                isPlayerTurn = true;
                currentRound++;
                roundIndicator.textContent = `Round ${currentRound}`;
                showMainBattleActions();
                // Desbloquear botões quando for a vez do jogador
                setBattleButtonsLocked(false);
                return;
            }
            
            let damage = 0;
            let message = "";
            
            if (currentMonster.type === 'darkMage') {
                if (Math.random() < 0.7) {
                    // Ataque normal - CORREÇÃO: Causa dano base
                    damage = currentMonster.attack;
                    message = `<span class="log-enemy">${currentMonster.name}</span> lança <span class="log-skill">Magia Negra</span>!`;
                    
                    createDarkMagicEffect();
                } else {
                    // Cura - CORREÇÃO: Não causa dano
                    currentMonster.health = Math.min(currentMonster.maxHealth, currentMonster.health + 20);
                    message = `<span class="log-enemy">${currentMonster.name}</span> usa <span class="log-skill">Cura das Trevas</span> e recupera 20 de HP!`;
                    
                    createDarkHealEffect();
                }
            } else if (currentMonster.type === 'elite') {
                damage = currentMonster.attackPlayer(player);
                message = `<span class="log-enemy">${currentMonster.name}</span> cospe <span class="log-skill">Fogo</span>!`;
                
                createDragonFireEffect();
            } else {
                damage = currentMonster.attackPlayer(player);
                message = `<span class="log-enemy">${currentMonster.name}</span> ataca!`;
                
                createMonsterAttackEffect();
            }
            
            addBattleLog(message, "enemy");
            
            battleAnimation = {
                type: 'monsterAttack',
                step: 0,
                maxSteps: 20
            };
            
            animateBattle();
            
            setTimeout(() => {
                if (Math.random() < player.dodgeChance) {
                    addBattleLog(`<span class="log-player">Cavaleiro</span> desviou do ataque!`, "player");
                    createMissEffect();
                } else {
                    const actualDamage = player.takeDamage(damage);
                    
                    createDamageEffect(actualDamage, "player");
                    
                    addBattleLog(` Causou ${actualDamage} de dano!`, "system");
                    
                    if (currentMonster.type === 'elite' && player.hasStatusEffect('burn')) {
                        addBattleLog(` <span class="log-player">Cavaleiro</span> está <span class="log-effect">queimando</span>!`, "system");
                        createBurnEffect();
                    }
                    
                    if (currentMonster.type === 'darkMage' && player.hasStatusEffect('stun')) {
                        addBattleLog(` <span class="log-player">Cavaleiro</span> está <span class="log-effect">atordoado</span>!`, "system");
                        createStunEffect();
                    }
                    
                    player.updateUI();
                    
                    if (player.health <= 0) {
                        endBattle(false);
                        return;
                    }
                }
                
                player.updateStatusEffects();
                player.updateBattleStatusEffects();
                
                isPlayerTurn = true;
                currentRound++;
                roundIndicator.textContent = `Round ${currentRound}`;
                showMainBattleActions();
                // Desbloquear botões quando for a vez do jogador
                setBattleButtonsLocked(false);
            }, 800);
        }

        function bossTurn() {
            if (isPlayerTurn) return;
            
            player.recoverStamina(10);
            player.updateUI();
            
            if (currentBoss.hasStatusEffect('stun')) {
                addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> está <span class="log-effect">atordoado</span> e perdeu a vez!`, "system");
                currentBoss.updateStatusEffects();
                
                isPlayerTurn = true;
                bossBattleRound++;
                bossRoundIndicator.textContent = `Round ${bossBattleRound}`;
                showBossMainBattleActions();
                setBossBattleButtonsLocked(false);
                return;
            }
            
            const attackResult = currentBoss.attackPlayer(player);
            let message = "";
            
            if (typeof attackResult === 'number') {
                // Ataque normal na fase 1
                message = `<span class="log-enemy">${currentBoss.name}</span> ataca!`;
            } else {
                // Ataques na fase 2
                switch(attackResult.type) {
                    case 'imperialCharge':
                        message = `<span class="log-enemy">${currentBoss.name}</span> usa <span class="log-skill">Carga Imperial</span>!`;
                        break;
                    case 'darkMist':
                        message = `<span class="log-enemy">${currentBoss.name}</span> invoca <span class="log-skill">Névoa das Trevas</span>!`;
                        break;
                    case 'monarchRevival':
                        message = `<span class="log-enemy">${currentBoss.name}</span> usa <span class="log-skill">Revigoração Do Monarca</span> e recupera 100 de HP!`;
                        break;
                }
            }
            
            addBossBattleLog(message, "enemy");
            
            setTimeout(() => {
                if (Math.random() < player.dodgeChance) {
                    addBossBattleLog(`<span class="log-player">Cavaleiro</span> desviou do ataque!`, "player");
                } else {
                    let actualDamage = 0;
                    
                    if (typeof attackResult === 'number') {
                        actualDamage = player.takeDamage(attackResult);
                    } else {
                        actualDamage = player.takeDamage(attackResult.damage);
                        
                        if (attackResult.type === 'darkMist') {
                            addBossBattleLog(` <span class="log-player">Cavaleiro</span> foi <span class="log-effect">envenenado</span>!`, "system");
                        }
                    }
                    
                    if (actualDamage > 0) {
                        addBossBattleLog(` Causou ${actualDamage} de dano!`, "system");
                    }
                    
                    player.updateUI();
                    
                    if (player.health <= 0) {
                        endBossBattle(false);
                        return;
                    }
                }
                
                player.updateStatusEffects();
                
                isPlayerTurn = true;
                bossBattleRound++;
                bossRoundIndicator.textContent = `Round ${bossBattleRound}`;
                showBossMainBattleActions();
                setBossBattleButtonsLocked(false);
            }, 800);
        }

        // Funções de efeitos visuais
        function createSwordEffect() {
            const effect = {
                type: 'sword',
                x: 300,
                y: 200,
                angle: 0,
                step: 0,
                maxSteps: 10
            };
            attackAnimations.push(effect);
        }

        function createChargeEffect() {
            const effect = {
                type: 'charge',
                x: 150,
                y: 200,
                targetX: 400,
                step: 0,
                maxSteps: 15
            };
            attackAnimations.push(effect);
        }

        function createFireballEffect() {
            const effect = {
                type: 'fireball',
                x: 150,
                y: 200,
                radius: 10,
                step: 0,
                maxSteps: 15
            };
            attackAnimations.push(effect);
        }

        function createFreezeEffect() {
            const effect = {
                type: 'freeze',
                x: 400,
                y: 200,
                radius: 10,
                step: 0,
                maxSteps: 20
            };
            attackAnimations.push(effect);
        }

        function createPossessionEffect() {
            const effect = {
                type: 'possession',
                x: 400,
                y: 200,
                radius: 10,
                step: 0,
                maxSteps: 20
            };
            attackAnimations.push(effect);
        }

        function createHeavyArmorEffect() {
            const effect = {
                type: 'heavy-armor',
                x: 150,
                y: 200,
                step: 0,
                maxSteps: 15
            };
            battleEffects.push(effect);
        }

        function createDamageEffect(damage, target) {
            const x = target === "player" ? 150 : 400;
            const y = target === "player" ? 200 : 150;
            
            const effect = {
                type: 'damage',
                value: damage,
                x: x,
                y: y,
                step: 0,
                maxSteps: 60
            };
            battleEffects.push(effect);
        }

        function createMissEffect() {
            const effect = {
                type: 'miss',
                x: 400,
                y: 150,
                step: 0,
                maxSteps: 60
            };
            battleEffects.push(effect);
        }

        function createBurnEffect() {
            const effect = {
                type: 'burn',
                x: 400,
                y: 120,
                step: 0,
                maxSteps: 60
            };
            battleEffects.push(effect);
        }

        function createStunEffect() {
            const effect = {
                type: 'stun',
                x: 150,
                y: 170,
                step: 0,
                maxSteps: 60
            };
            battleEffects.push(effect);
        }

        function createItemUseEffect(itemType) {
            const effect = {
                type: 'item',
                item: itemType,
                x: 150,
                y: 200,
                step: 0,
                maxSteps: 30
            };
            battleEffects.push(effect);
        }

        function createMeditateEffect() {
            const effect = {
                type: 'meditate',
                x: 150,
                y: 200,
                step: 0,
                maxSteps: 30
            };
            battleEffects.push(effect);
        }

        function createRestEffect() {
            const effect = {
                type: 'rest',
                x: 150,
                y: 200,
                step: 0,
                maxSteps: 30
            };
            battleEffects.push(effect);
        }

        function createDarkMagicEffect() {
            const effect = {
                type: 'dark-magic',
                x: 400,
                y: 200,
                targetX: 150,
                step: 0,
                maxSteps: 15
            };
            attackAnimations.push(effect);
        }

        function createDarkHealEffect() {
            const effect = {
                type: 'dark-heal',
                x: 400,
                y: 200,
                radius: 10,
                step: 0,
                maxSteps: 20
            };
            attackAnimations.push(effect);
        }

        function createDragonFireEffect() {
            const effect = {
                type: 'dragon-fire',
                x: 400,
                y: 200,
                step: 0,
                maxSteps: 15
            };
            attackAnimations.push(effect);
        }

        function createMonsterAttackEffect() {
            const effect = {
                type: 'sword',
                x: 400,
                y: 200,
                angle: Math.PI,
                step: 0,
                maxSteps: 10
            };
            attackAnimations.push(effect);
        }

        function createStatusEffect(type) {
            const effect = {
                type: type,
                x: 400,
                y: 120,
                step: 0,
                maxSteps: 60
            };
            battleEffects.push(effect);
        }

        function animateBattle() {
            if (!battleAnimation) return;
            
            playerCtx.clearRect(0, 0, 250, 250);
            enemyCtx.clearRect(0, 0, 250, 250);
            
            playerCtx.fillStyle = 'rgba(26, 58, 95, 0.5)';
            playerCtx.fillRect(0, 0, 250, 250);
            enemyCtx.fillStyle = 'rgba(26, 58, 95, 0.5)';
            enemyCtx.fillRect(0, 0, 250, 250);
            
            player.drawBattle(playerCtx, battleAnimation.type === 'playerAttack');
            currentMonster.drawBattle(enemyCtx, battleAnimation.type === 'monsterAttack');
            
            drawBattleEffects();
            
            battleAnimation.step++;
            
            if (battleAnimation.step < battleAnimation.maxSteps) {
                requestAnimationFrame(animateBattle);
            } else {
                battleAnimation = null;
                attackAnimations = [];
                
                player.drawBattle(playerCtx, false);
                currentMonster.drawBattle(enemyCtx, false);
            }
        }

        function drawBattleEffects() {
            for (let i = attackAnimations.length - 1; i >= 0; i--) {
                const anim = attackAnimations[i];
                
                anim.step++;
                
                if (anim.step >= anim.maxSteps) {
                    attackAnimations.splice(i, 1);
                    continue;
                }
                
                const progress = anim.step / anim.maxSteps;
                const ctx = anim.type.includes('fireball') || anim.type.includes('freeze') || 
                           anim.type.includes('possession') || anim.type.includes('dark-heal') ? 
                           enemyCtx : playerCtx;
                
                switch(anim.type) {
                    case 'sword':
                        ctx.save();
                        ctx.translate(anim.x, anim.y);
                        ctx.rotate(anim.angle + progress * Math.PI);
                        ctx.fillStyle = '#f8c555';
                        ctx.fillRect(-20, -2, 40, 4);
                        ctx.fillStyle = '#bdc3c7';
                        ctx.fillRect(20, -3, 10, 6);
                        ctx.restore();
                        anim.angle += 0.3;
                        break;
                        
                    case 'charge':
                        playerCtx.save();
                        playerCtx.fillStyle = 'rgba(255, 165, 0, 0.7)';
                        const chargeX = anim.x + (anim.targetX - anim.x) * progress;
                        playerCtx.beginPath();
                        playerCtx.arc(chargeX, anim.y, 15, 0, Math.PI * 2);
                        playerCtx.fill();
                        playerCtx.restore();
                        break;
                        
                    case 'fireball':
                        ctx.save();
                        ctx.fillStyle = '#ff6b6b';
                        ctx.beginPath();
                        ctx.arc(anim.x, anim.y, anim.radius + progress * 20, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                        break;
                        
                    case 'freeze':
                        ctx.save();
                        ctx.fillStyle = 'rgba(173, 216, 230, 0.7)';
                        ctx.beginPath();
                        ctx.arc(anim.x, anim.y, anim.radius + progress * 25, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                        break;
                        
                    case 'possession':
                        ctx.save();
                        ctx.fillStyle = 'rgba(138, 43, 226, 0.7)';
                        ctx.beginPath();
                        ctx.arc(anim.x, anim.y, anim.radius + progress * 22, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                        break;
                        
                    case 'dark-magic':
                        ctx.save();
                        ctx.fillStyle = 'rgba(75, 0, 130, 0.7)';
                        const magicX = anim.x + (anim.targetX - anim.x) * progress;
                        ctx.beginPath();
                        ctx.arc(magicX, anim.y, 12, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                        break;
                        
                    case 'dark-heal':
                        ctx.save();
                        ctx.fillStyle = 'rgba(106, 13, 173, 0.7)';
                        ctx.beginPath();
                        ctx.arc(anim.x, anim.y, anim.radius + progress * 15, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                        break;
                        
                    case 'dragon-fire':
                        ctx.save();
                        ctx.fillStyle = '#ff6b6b';
                        ctx.fillRect(anim.x - 60 * progress, anim.y - 30, 120 * progress, 60);
                        ctx.restore();
                        break;
                }
            }
            
            for (let i = battleEffects.length - 1; i >= 0; i--) {
                const effect = battleEffects[i];
                const ctx = effect.type.includes('player') ? playerCtx : enemyCtx;
                
                effect.step++;
                
                if (effect.step >= effect.maxSteps) {
                    battleEffects.splice(i, 1);
                    continue;
                }
                
                const progress = effect.step / effect.maxSteps;
                const alpha = 1 - progress;
                const offsetY = progress * 30;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 16px MedievalSharp';
                ctx.textAlign = 'center';
                
                switch(effect.type) {
                    case 'damage':
                        ctx.fillStyle = '#e74c3c';
                        ctx.fillText(`-${effect.value}`, effect.x, effect.y - offsetY);
                        break;
                    case 'miss':
                        ctx.fillStyle = '#95a5a6';
                        ctx.fillText('ESQUIVOU!', effect.x, effect.y - offsetY);
                        break;
                    case 'burn':
                        ctx.fillStyle = '#ff6b6b';
                        ctx.fillText('QUEIMANDO!', effect.x, effect.y - offsetY);
                        break;
                    case 'stun':
                        ctx.fillStyle = '#a29bfe';
                        ctx.fillText('ATORDOADO!', effect.x, effect.y - offsetY);
                        break;
                    case 'item':
                        ctx.fillStyle = '#2ecc71';
                        ctx.fillText('+ITEM', effect.x, effect.y - offsetY);
                        break;
                    case 'meditate':
                        ctx.fillStyle = '#3498db';
                        ctx.fillText('MEDITANDO', effect.x, effect.y - offsetY);
                        break;
                    case 'rest':
                        ctx.fillStyle = '#f39c12';
                        ctx.fillText('DESCANSANDO', effect.x, effect.y - offsetY);
                        break;
                    case 'heavy-armor':
                        ctx.fillStyle = '#bdc3c7';
                        ctx.fillText('DEFESA+', effect.x, effect.y - offsetY);
                        break;
                }
                
                ctx.restore();
            }
        }

        function endBattle(playerWon) {
            if (playerWon) {
                const expGained = currentMonster.getExpReward();
                const moneyGained = currentMonster.getMoneyReward();
                
                player.addExp(expGained);
                player.money += moneyGained;
                
                const droppedItems = currentMonster.dropItems(player);
                
                let dropMessage = "";
                if (droppedItems.length > 0) {
                    dropMessage = ` e encontrou: ${droppedItems.join(', ')}`;
                }
                
                addBattleLog(`Você venceu! Ganhou ${expGained} de EXP, ${moneyGained} de dinheiro${dropMessage}.`, "system");
                
                // Bloquear botões durante a notificação de vitória
                setBattleButtonsLocked(true);
                
                setTimeout(() => {
                    showVictoryNotification(expGained, moneyGained, droppedItems);
                }, 1000);
                
                setTimeout(() => {
                    battleScreen.style.display = 'none';
                    player.updateUI();
                    // Desbloquear botões após a batalha
                    setBattleButtonsLocked(false);
                }, 4000);
            } else {
                addBattleLog("Você foi derrotado!", "system");
                
                // Bloquear botões durante a morte
                setBattleButtonsLocked(true);
                
                setTimeout(() => {
                    battleScreen.style.display = 'none';
                    deathScreen.style.display = 'flex';
                    
                    player.exp = Math.floor(player.exp * 0.5);
                    const itemsLost = player.loseRandomItems();
                    
                    setTimeout(() => {
                        deathScreen.style.display = 'none';
                        player.health = player.maxHealth;
                        player.mana = player.maxMana;
                        player.stamina = player.maxStamina;
                        player.statusEffects = [];
                        player.updateUI();
                        // Desbloquear botões após a morte
                        setBattleButtonsLocked(false);
                    }, 3000);
                }, 2000);
            }
        }

        function endBossBattle(playerWon) {
            if (playerWon) {
                // Esconder UI de batalha
                bossBattleActionsPokemon.style.display = 'none';
                bossBattleDialog.style.display = 'none';
                
                // Mostrar diálogo final do boss
                bossFinalDialog.style.display = 'flex';
                
                const finalDialogues = [
                    "Bom... Muito bom meu jovem",
                    "Você e suas habilidades são excepcionais, estou admirado...",
                    "Nesta vida, enfrentei muitos de vocês.. Meu reino, desabou, a ira, me tomou conta, mas ver você aqui empenhado, talvez me traga algum sentimento de verdade...",
                    "Eu jamais daria a honra de perder uma luta... Mas estou velho, cansado, exausto, e somente quero descançar... Obrigado por me livar deste inferno, eu agradeço",
                    "Adeus, que o mundo não seja tão infernal quanto foi para mim a você, te desejo o bem.... Foi uma boa luta"
                ];
                
                let currentDialogueIndex = 0;
                
                function showNextDialogue() {
                    if (currentDialogueIndex < finalDialogues.length) {
                        bossFinalDialogText.textContent = finalDialogues[currentDialogueIndex];
                        currentDialogueIndex++;
                        setTimeout(showNextDialogue, 3000);
                    } else {
                        // Fim do diálogo, dar recompensas ao jogador
                        setTimeout(() => {
                            bossBattleScreen.style.display = 'none';
                            player.addBossRewards();
                            player.updateUI();
                            
                            // Remover personagem misterioso do mapa
                            mysteriousCharacter.hasInteracted = true;
                            
                            // Mostrar notificação de recompensas
                            setTimeout(() => {
                                showNotification("Recompensas do Rei Corrompido", "Você recebeu a Armadura Imperial Do Monarca, a Longsword Banhada em Trevas, 1000 de ouro e 25x de todos os itens!");
                            }, 1000);
                        }, 3000);
                    }
                }
                
                showNextDialogue();
                
            } else {
                addBossBattleLog("Você foi derrotado!", "system");
                
                // Bloquear botões durante a morte
                setBossBattleButtonsLocked(true);
                
                setTimeout(() => {
                    bossBattleScreen.style.display = 'none';
                    deathScreen.style.display = 'flex';
                    
                    player.exp = Math.floor(player.exp * 0.5);
                    const itemsLost = player.loseRandomItems();
                    
                    setTimeout(() => {
                        deathScreen.style.display = 'none';
                        player.health = player.maxHealth;
                        player.mana = player.maxMana;
                        player.stamina = player.maxStamina;
                        player.statusEffects = [];
                        player.updateUI();
                        // Desbloquear botões após a morte
                        setBossBattleButtonsLocked(false);
                    }, 3000);
                }, 2000);
            }
        }

        function addBattleLog(message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = message;
            battleDialog.appendChild(logEntry);
            battleDialog.scrollTop = battleDialog.scrollHeight;
        }

        function addBossBattleLog(message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = message;
            bossBattleDialog.appendChild(logEntry);
            bossBattleDialog.scrollTop = bossBattleDialog.scrollHeight;
        }

        // Funções de notificação
        function showLevelUpNotification() {
            const notification = document.createElement('div');
            notification.className = 'level-up-notification';
            notification.innerHTML = `
                <div>LEVEL UP!</div>
                <div>Nível ${player.level}</div>
            `;
            document.querySelector('.game-board').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showVictoryNotification(exp, money, items) {
            const notification = document.createElement('div');
            notification.className = 'victory-notification';
            
            let itemsText = '';
            if (items.length > 0) {
                itemsText = `<div>Itens: ${items.join(', ')}</div>`;
            }
            
            notification.innerHTML = `
                <div>VITÓRIA!</div>
                <div>EXP: +${exp}</div>
                <div>Dinheiro: +${money}</div>
                ${itemsText}
            `;
            document.querySelector('.game-board').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function showLevelRequiredMessage() {
            levelRequiredMessage.style.display = 'block';
            
            setTimeout(() => {
                levelRequiredMessage.style.display = 'none';
            }, 2000);
        }

        function showBossTransformation() {
            bossTransformation.style.display = 'flex';
            
            setTimeout(() => {
                bossTransformation.style.display = 'none';
                
                // Atualizar stats do boss após transformação
                bossEnemyName.textContent = currentBoss.name;
                bossBattleEnemyHealth.textContent = currentBoss.health;
                bossBattleEnemyMaxHealth.textContent = currentBoss.maxHealth;
                bossBattleEnemyAgility.textContent = currentBoss.agility;
                
                // Redesenhar o boss
                currentBoss.drawBattle(bossEnemyCtx);
                
                addBossBattleLog(`<span class="log-enemy">${currentBoss.name}</span> se transformou! Sua vida foi restaurada para ${currentBoss.maxHealth}!`, "system");
            }, 3000);
        }

        // Funções de diálogo
        function startDialogue() {
            isInDialogue = true;
            dialogueScreen.style.display = 'flex';
            currentDialogueIndex = 0;
            
            // Definir diálogos
            currentDialogue = [
                {
                    character: "???",
                    text: "Estas terras... São cheias de maldições",
                    options: [
                        { text: "Oque está dizendo?", next: 1 },
                        { text: "flw troxa", next: -1 }
                    ]
                },
                {
                    character: "???",
                    text: "Poder, Aquisição, e oque mais? Logo você estará diante de meu poder, mas qual o sentido de tudo isso? Não posso ver a luz do dia mais, estou preso nesta maldição, e não suporto mais a decadência dos seres humanos diante de sua própria existência...",
                    options: [
                        { text: "Está dizendo que você irá me enfrentar?", next: 2 },
                        { text: "flw troxa", next: -1 }
                    ]
                },
                {
                    character: "???",
                    text: "Bem meu jovem... Escolhas são dificeis, mas nunca finitas, eu estou entediado, e quero me divertir, então venha... PROVE SEU VALOR!",
                    options: [
                        { text: "Estou dentro", next: 3 },
                        { text: "flw troxa", next: -1 }
                    ]
                }
            ];
            
            showDialogue(0);
        }

        function showDialogue(index) {
    if (index === -1) {
        // Fim do diálogo - apenas fecha sem marcar como interagido
        endDialogue();
        return;
    }
    
    if (index >= currentDialogue.length) {
        // Iniciar batalha com o boss
        startBossBattle();
        dialogueScreen.style.display = 'none';
        isInDialogue = false;
        // Marcar que interagiu apenas quando inicia a batalha
        mysteriousCharacter.hasInteracted = true;
        return;
    }
    
    const dialogue = currentDialogue[index];
    dialogueCharacterName.textContent = dialogue.character;
    
    // Limpar texto anterior
    dialogueText.textContent = "";
    dialogueOptions.innerHTML = "";
    
    // Digitar texto letra por letra
    isTyping = true;
    let charIndex = 0;
    const text = dialogue.text;
    
    function typeWriter() {
        if (charIndex < text.length) {
            dialogueText.textContent += text.charAt(charIndex);
            charIndex++;
            setTimeout(typeWriter, 100);
        } else {
            isTyping = false;
            
            // Mostrar opções após terminar de digitar
            dialogue.options.forEach(option => {
                const optionButton = document.createElement('button');
                optionButton.className = 'dialogue-option';
                optionButton.textContent = option.text;
                optionButton.addEventListener('click', () => {
                    if (!isTyping) {
                        showDialogue(option.next);
                    }
                });
                dialogueOptions.appendChild(optionButton);
            });
        }
    }
    
    typeWriter();
}

        function endDialogue() {
            dialogueScreen.style.display = 'none';
            isInDialogue = false;
        }

        // Funções de loja
        function openShop() {
            shopScreen.style.display = 'flex';
            loadShopItems('food');
        }

        function openDarkShop() {
            darkShopScreen.style.display = 'flex';
            loadDarkShopItems('food');
        }

        function loadShopItems(category) {
            shopItems.innerHTML = '';
            
            if (category === 'food') {
                const maceItem = document.createElement('div');
                maceItem.className = 'shop-item';
                maceItem.innerHTML = `
                    <div class="shop-item-icon">🍎</div>
                    <div class="shop-item-name">Maçã</div>
                    <div class="shop-item-price">10 💰</div>
                    <button class="shop-buy-btn" data-item="mace" data-price="10">Comprar</button>
                `;
                shopItems.appendChild(maceItem);
                
                const hamItem = document.createElement('div');
                hamItem.className = 'shop-item';
                hamItem.innerHTML = `
                    <div class="shop-item-icon">🍗</div>
                    <div class="shop-item-name">Pernil</div>
                    <div class="shop-item-price">25 💰</div>
                    <button class="shop-buy-btn" data-item="ham" data-price="25">Comprar</button>
                `;
                shopItems.appendChild(hamItem);
                
                const steakItem = document.createElement('div');
                steakItem.className = 'shop-item';
                steakItem.innerHTML = `
                    <div class="shop-item-icon">🥩</div>
                    <div class="shop-item-name">Bife</div>
                    <div class="shop-item-price">40 💰</div>
                    <button class="shop-buy-btn" data-item="steak" data-price="40">Comprar</button>
                `;
                shopItems.appendChild(steakItem);
            } else if (category === 'weapons') {
                let stoneSwordItem, goldSwordItem, diamondSwordItem;
                
                if (!player.purchasedItems.stoneSword) {
                    stoneSwordItem = document.createElement('div');
                    stoneSwordItem.className = 'shop-item';
                    stoneSwordItem.innerHTML = `
                        <div class="shop-item-icon">⚔️</div>
                        <div class="shop-item-name">Espada de Pedra</div>
                        <div class="shop-item-price">130 💰</div>
                        <button class="shop-buy-btn" data-item="stoneSword" data-price="130">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(stoneSwordItem);
                } else if (!player.purchasedItems.goldSword) {
                    goldSwordItem = document.createElement('div');
                    goldSwordItem.className = 'shop-item';
                    goldSwordItem.innerHTML = `
                        <div class="shop-item-icon">⚔️</div>
                        <div class="shop-item-name">Espada de Ouro</div>
                        <div class="shop-item-price">250 💰</div>
                        <button class="shop-buy-btn" data-item="goldSword" data-price="250">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(goldSwordItem);
                } else if (!player.purchasedItems.diamondSword) {
                    diamondSwordItem = document.createElement('div');
                    diamondSwordItem.className = 'shop-item';
                    diamondSwordItem.innerHTML = `
                        <div class="shop-item-icon">⚔️</div>
                        <div class="shop-item-name">Espada de Diamante</div>
                        <div class="shop-item-price">320 💰</div>
                        <button class="shop-buy-btn" data-item="diamondSword" data-price="320">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(diamondSwordItem);
                }
                
                let chainMailItem, goldArmorItem, diamondArmorItem;
                
                if (!player.purchasedItems.chainMail) {
                    chainMailItem = document.createElement('div');
                    chainMailItem.className = 'shop-item';
                    chainMailItem.innerHTML = `
                        <div class="shop-item-icon">🛡️</div>
                        <div class="shop-item-name">Armadura de Malha</div>
                        <div class="shop-item-price">200 💰</div>
                        <button class="shop-buy-btn" data-item="chainMail" data-price="200">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(chainMailItem);
                } else if (!player.purchasedItems.goldArmor) {
                    goldArmorItem = document.createElement('div');
                    goldArmorItem.className = 'shop-item';
                    goldArmorItem.innerHTML = `
                        <div class="shop-item-icon">🛡️</div>
                        <div class="shop-item-name">Armadura de Ouro</div>
                        <div class="shop-item-price">350 💰</div>
                        <button class="shop-buy-btn" data-item="goldArmor" data-price="350">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(goldArmorItem);
                } else if (!player.purchasedItems.diamondArmor) {
                    diamondArmorItem = document.createElement('div');
                    diamondArmorItem.className = 'shop-item';
                    diamondArmorItem.innerHTML = `
                        <div class="shop-item-icon">🛡️</div>
                        <div class="shop-item-name">Armadura de Diamante</div>
                        <div class="shop-item-price">500 💰</div>
                        <button class="shop-buy-btn" data-item="diamondArmor" data-price="500">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(diamondArmorItem);
                }
            } else if (category === 'potions') {
                const strengthPotionItem = document.createElement('div');
                strengthPotionItem.className = 'shop-item';
                strengthPotionItem.innerHTML = `
                    <div class="shop-item-icon">🧪</div>
                    <div class="shop-item-name">Poção de Força</div>
                    <div class="shop-item-price">55 💰</div>
                    <button class="shop-buy-btn" data-item="strengthPotion" data-price="55">Comprar</button>
                `;
                shopItems.appendChild(strengthPotionItem);
                
                const luckPotionItem = document.createElement('div');
                luckPotionItem.className = 'shop-item';
                luckPotionItem.innerHTML = `
                    <div class="shop-item-icon">🍀</div>
                    <div class="shop-item-name">Poção da Sorte</div>
                    <div class="shop-item-price">150 💰</div>
                    <button class="shop-buy-btn" data-item="luckPotion" data-price="150">Comprar</button>
                `;
                shopItems.appendChild(luckPotionItem);
            }
            
            document.querySelectorAll('.shop-buy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const item = btn.getAttribute('data-item');
                    const price = parseInt(btn.getAttribute('data-price'));
                    
                    if (player.buyItem(item, price)) {
                        showNotification("Sucesso", "Compra realizada com sucesso!");
                        loadShopItems(category);
                    } else {
                        showNotification("Erro", "Dinheiro insuficiente!");
                    }
                });
            });
        }

        function loadDarkShopItems(category) {
            darkShopItems.innerHTML = '';
            
            if (category === 'food') {
                const maceItem = document.createElement('div');
                maceItem.className = 'dark-shop-item';
                maceItem.innerHTML = `
                    <div class="dark-shop-item-icon">🍎</div>
                    <div class="dark-shop-item-name">10 Maçãs</div>
                    <div class="dark-shop-item-price">1 🐉</div>
                    <button class="dark-shop-buy-btn" data-item="mace" data-price="1">Comprar</button>
                `;
                darkShopItems.appendChild(maceItem);
                
                const hamItem = document.createElement('div');
                hamItem.className = 'dark-shop-item';
                hamItem.innerHTML = `
                    <div class="dark-shop-item-icon">🍗</div>
                    <div class="dark-shop-item-name">10 Pernis</div>
                    <div class="dark-shop-item-price">2 🐉</div>
                    <button class="dark-shop-buy-btn" data-item="ham" data-price="2">Comprar</button>
                `;
                darkShopItems.appendChild(hamItem);
                
                const steakItem = document.createElement('div');
                steakItem.className = 'dark-shop-item';
                steakItem.innerHTML = `
                    <div class="dark-shop-item-icon">🥩</div>
                    <div class="dark-shop-item-name">10 Bifes</div>
                    <div class="dark-shop-item-price">5 🐉</div>
                    <button class="dark-shop-buy-btn" data-item="steak" data-price="5">Comprar</button>
                `;
                darkShopItems.appendChild(steakItem);
            } else if (category === 'weapons') {
                if (!player.purchasedItems.doomSword) {
                    const doomSwordItem = document.createElement('div');
                    doomSwordItem.className = 'dark-shop-item';
                    doomSwordItem.innerHTML = `
                        <div class="dark-shop-item-icon">⚔️</div>
                        <div class="dark-shop-item-name">Espada da Perdição</div>
                        <div class="dark-shop-item-description">Aumenta dano em 15x, mas reduz HP em 35%</div>
                        <div class="dark-shop-item-price">10 🐉</div>
                        <button class="dark-shop-buy-btn" data-item="doomSword" data-price="10">
                            Comprar
                        </button>
                    `;
                    darkShopItems.appendChild(doomSwordItem);
                }
                
                if (!player.purchasedItems.soulArmor) {
                    const soulArmorItem = document.createElement('div');
                    soulArmorItem.className = 'dark-shop-item';
                    soulArmorItem.innerHTML = `
                        <div class="dark-shop-item-icon">🛡️</div>
                        <div class="dark-shop-item-name">Armadura de Almas</div>
                        <div class="dark-shop-item-description">Aumenta defesa e agilidade em 3.4x, mas reduz HP em 20%</div>
                        <div class="dark-shop-item-price">15 🐉</div>
                        <button class="dark-shop-buy-btn" data-item="soulArmor" data-price="15">
                            Comprar
                        </button>
                    `;
                    darkShopItems.appendChild(soulArmorItem);
                }
            } else if (category === 'orbs') {
                const orbItem = document.createElement('div');
                orbItem.className = 'dark-shop-item';
                orbItem.innerHTML = `
                    <div class="dark-shop-item-icon">🔮</div>
                    <div class="dark-shop-item-name">Orbe de Invocação</div>
                    <div class="dark-shop-item-description">Em breve disponível</div>
                    <div class="dark-shop-item-price">??? 🐉</div>
                    <button class="dark-shop-buy-btn" disabled>Indisponível</button>
                `;
                darkShopItems.appendChild(orbItem);
            }
            
            document.querySelectorAll('.dark-shop-buy-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', () => {
                        const item = btn.getAttribute('data-item');
                        const price = parseInt(btn.getAttribute('data-price'));
                        
                        if (player.buyItem(item, price, true)) {
                            showNotification("Sucesso", "Compra realizada com sucesso!");
                            loadDarkShopItems(category);
                        } else {
                            showNotification("Erro", "Escamas de dragão insuficientes!");
                        }
                    });
                }
            });
        }
function saveGame() {
    const saveData = {
        level: player.level,
        x: player.x,
        y: player.y,
        money: player.money,
        exp: player.exp,
        expToNextLevel: player.expToNextLevel,
        upgradePoints: player.upgradePoints,
        baseHp: player.baseHp,
        baseStr: player.baseStr,
        baseAgi: player.baseAgi,
        baseDef: player.baseDef,
        baseMag: player.baseMag,
        health: player.health,
        maxHealth: player.maxHealth,
        mana: player.mana,
        maxMana: player.maxMana,
        stamina: player.stamina,
        maxStamina: player.maxStamina,
        items: player.items,
        recipes: player.recipes,
        equipmentCollection: player.equipmentCollection,
        purchasedItems: player.purchasedItems,
        hasDragonSlayer: player.hasDragonSlayer,
        hasBlackWolfArmor: player.hasBlackWolfArmor,
        hasImperialArmor: player.hasImperialArmor,
        hasDarkLongsword: player.hasDarkLongsword,
        weapon: player.weapon,
        armor: player.armor,
        mysteriousCharacterInteracted: mysteriousCharacter ? mysteriousCharacter.hasInteracted : false
    };
    
    localStorage.setItem('knightOfValorSave', JSON.stringify(saveData));
    showNotification("Jogo Salvo", "Progresso salvo com sucesso!");
}

function loadGame() {
    const saveData = localStorage.getItem('knightOfValorSave');
    
    if (saveData) {
        const data = JSON.parse(saveData);
        
        player.level = data.level || 1;
        player.x = data.x || 15;
        player.y = data.y || 15;
        player.money = data.money || 0;
        player.exp = data.exp || 0;
        player.expToNextLevel = data.expToNextLevel || 40;
        player.upgradePoints = data.upgradePoints || 0;
        player.baseHp = data.baseHp || 10;
        player.baseStr = data.baseStr || 10;
        player.baseAgi = data.baseAgi || 10;
        player.baseDef = data.baseDef || 10;
        player.baseMag = data.baseMag || 10;
        player.health = data.health || player.maxHealth;
        player.maxHealth = data.maxHealth || Math.floor(player.baseHp * 10);
        player.mana = data.mana || player.maxMana;
        player.maxMana = data.maxMana || Math.floor(50 * Math.pow(1.05, player.baseMag - 10));
        player.stamina = data.stamina || player.maxStamina;
        player.maxStamina = data.maxStamina || 30 + (player.baseAgi - 10) * 2;
        player.items = data.items || { mace: 2, ham: 0, steak: 0, strengthPotion: 0, luckPotion: 0, dragonScales: 0 };
        player.recipes = data.recipes || { dragonSlayer: false, blackWolfArmor: false };
        player.equipmentCollection = data.equipmentCollection || player.equipmentCollection;
        player.purchasedItems = data.purchasedItems || player.purchasedItems;
        player.hasDragonSlayer = data.hasDragonSlayer || false;
        player.hasBlackWolfArmor = data.hasBlackWolfArmor || false;
        player.hasImperialArmor = data.hasImperialArmor || false;
        player.hasDarkLongsword = data.hasDarkLongsword || false;
        player.weapon = data.weapon || player.weapon;
        player.armor = data.armor || player.armor;
        
        // Recarregar stats
        player.recalculateStats();
        
        // Atualizar estado do personagem misterioso
        if (mysteriousCharacter && data.mysteriousCharacterInteracted) {
            mysteriousCharacter.hasInteracted = data.mysteriousCharacterInteracted;
        }
        
        player.updateUI();
        showNotification("Jogo Carregado", "Progresso carregado com sucesso!");
        return true;
    }
    return false;
}

function deleteSave() {
    localStorage.removeItem('knightOfValorSave');
    showNotification("Save Deletado", "Progresso salvo foi deletado.");
}

// Adicionar botões de save/load no inventário
function addSaveLoadButtons() {
    const saveLoadSection = document.createElement('div');
    saveLoadSection.className = 'upgrade-points';
    saveLoadSection.innerHTML = `
        <h3>Gerenciar Progresso</h3>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="battle-btn" id="saveGameBtn">Salvar Jogo</button>
            <button class="battle-btn" id="loadGameBtn">Carregar Jogo</button>
            <button class="battle-btn" id="deleteSaveBtn" style="background: linear-gradient(to bottom, #e74c3c, #c0392b);">Deletar Save</button>
        </div>
    `;
    
    document.querySelector('.inventory-container').appendChild(saveLoadSection);
    
    document.getElementById('saveGameBtn').addEventListener('click', saveGame);
    document.getElementById('loadGameBtn').addEventListener('click', loadGame);
    document.getElementById('deleteSaveBtn').addEventListener('click', deleteSave);
}
        
        function initGame() {
            player = new Player();
            worldMap = generateWorldMap();
            merchantForest = new Merchant(worldMap, 2);
            merchantMountain = new Merchant(worldMap, 3);
            darkMerchant = new Merchant(worldMap, 9, true);
            
            if (!loadGame()) {
        player.updateUI();
    }
          
          
            
            // Simular carregamento
             let progress = 0;
    const loadingInterval = setInterval(() => {
        progress += 2;
        loadingProgress.style.width = `${progress}%`;
        
        if (progress >= 100) {
            clearInterval(loadingInterval);
            startBtn.disabled = false;
        }
    }, 50);
}

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            if (startScreen.style.display === 'flex') return;
            if (isInDialogue) return;
            if (battleScreen.style.display === 'flex') return;
            if (bossBattleScreen.style.display === 'flex') return;
            if (inventoryScreen.style.display === 'flex') return;
            if (equipmentScreen.style.display === 'flex') return;
            if (shopScreen.style.display === 'flex') return;
            if (darkShopScreen.style.display === 'flex') return;
            if (deathScreen.style.display === 'flex') return;
            if (notificationScreen.style.display === 'flex') return;
            
            keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'e') {
                if (merchantForest.isPlayerNearby(player) || merchantMountain.isPlayerNearby(player)) {
                    openShop();
                } else if (darkMerchant.isPlayerNearby(player)) {
                    openDarkShop();
                } else if (mysteriousCharacter && mysteriousCharacter.isPlayerNearby(player) && !mysteriousCharacter.hasInteracted) {
                    mysteriousCharacter.interact();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        startBtn.addEventListener('click', () => {
            startScreen.style.display = 'none';
        });

        // Event listeners de batalha
        attackBtnPokemon.addEventListener('click', showAttackOptions);
        magicBtnPokemon.addEventListener('click', showMagicOptions);
        itemsBtnPokemon.addEventListener('click', showItemsOptions);
        actBtnPokemon.addEventListener('click', showActOptions);

        swordAttackBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAttack('sword');
        });

        chargeBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAttack('charge');
        });

        heavyArmorBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAttack('heavy-armor');
        });

        fireballBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerMagic('fireball');
        });

        freezeBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerMagic('freeze');
        });

        possessionBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerMagic('possession');
        });

        meditateBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAct('meditate');
        });

        restBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAct('rest');
        });

        fleeBtnPokemon.addEventListener('click', () => {
            showMainBattleActions();
            playerAct('flee');
        });

        backFromAttackBtnPokemon.addEventListener('click', showMainBattleActions);
        backFromMagicBtnPokemon.addEventListener('click', showMainBattleActions);
        backFromItemsBtnPokemon.addEventListener('click', showMainBattleActions);
        backFromActBtnPokemon.addEventListener('click', showMainBattleActions);

        // Event listeners de batalha do boss
        bossAttackBtnPokemon.addEventListener('click', showBossAttackOptions);
bossMagicBtnPokemon.addEventListener('click', showBossMagicOptions);
bossItemsBtnPokemon.addEventListener('click', showBossItemsOptions);
bossActBtnPokemon.addEventListener('click', showBossActOptions);

bossSwordAttackBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAttack('sword');
});

bossChargeBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAttack('charge');
});

bossHeavyArmorBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAttack('heavyArmor');
});

bossFireballBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossMagic('fireball');
});

bossFreezeBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossMagic('freeze');
});

bossPossessionBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossMagic('possession');
});

bossMeditateBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAct('meditate');
});

bossRestBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAct('rest');
});

bossFleeBtnPokemon.addEventListener('click', () => {
    showBossMainBattleActions();
    playerBossAct('flee');
});

bossBackFromAttackBtnPokemon.addEventListener('click', showBossMainBattleActions);
bossBackFromMagicBtnPokemon.addEventListener('click', showBossMainBattleActions);
bossBackFromItemsBtnPokemon.addEventListener('click', showBossMainBattleActions);
bossBackFromActBtnPokemon.addEventListener('click', showBossMainBattleActions);

        // Event listeners de inventário
        inventoryBtn.addEventListener('click', () => {
            inventoryScreen.style.display = 'flex';
        });

        closeInventoryBtn.addEventListener('click', () => {
            inventoryScreen.style.display = 'none';
        });

        document.querySelectorAll('.upgrade-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const stat = btn.getAttribute('data-stat');
                player.upgradeStat(stat);
                player.updateUI();
            });
        });

        craftingResult.addEventListener('click', () => {
            player.craftItem();
        });

        craftingSlots.forEach((slot, index) => {
            slot.addEventListener('click', () => {
                if (player.craftingSlots[index] === null) {
                    if (player.items.ham > 0 || player.items.dragonScales > 0 || player.items.strengthPotion > 0 || player.items.steak > 0) {
                        const itemChoice = prompt("Qual item deseja adicionar? (Digite 'ham' para Pernil, 'dragonScales' para Escamas de Dragão, 'strengthPotion' para Poção de Força ou 'steak' para Bife):");
                        if (itemChoice === 'ham' && player.items.ham > 0) {
                            player.addToCraftingSlot(index, 'ham');
                        } else if (itemChoice === 'dragonScales' && player.items.dragonScales > 0) {
                            player.addToCraftingSlot(index, 'dragonScales');
                        } else if (itemChoice === 'strengthPotion' && player.items.strengthPotion > 0) {
                            player.addToCraftingSlot(index, 'strengthPotion');
                        } else if (itemChoice === 'steak' && player.items.steak > 0) {
                            player.addToCraftingSlot(index, 'steak');
                        } else {
                            showNotification("Erro", "Item inválido ou quantidade insuficiente!");
                        }
                    } else {
                        showNotification("Aviso", "Você não tem itens para adicionar ao crafting!");
                    }
                } else {
                    player.clearCraftingSlot(index);
                }
            });
            
            slot.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                player.clearCraftingSlot(index);
            });
        });

        equipmentBtn.addEventListener('click', () => {
            equipmentScreen.style.display = 'flex';
        });

        closeEquipmentBtn.addEventListener('click', () => {
            equipmentScreen.style.display = 'none';
        });

        closeShopBtn.addEventListener('click', () => {
            shopScreen.style.display = 'none';
        });

        closeDarkShopBtn.addEventListener('click', () => {
            darkShopScreen.style.display = 'none';
        });

        closeNotificationBtn.addEventListener('click', () => {
            notificationScreen.style.display = 'none';
        });

        shopCategories.forEach(category => {
            category.addEventListener('click', () => {
                shopCategories.forEach(c => c.classList.remove('active'));
                category.classList.add('active');
                loadShopItems(category.getAttribute('data-category'));
            });
        });

        darkShopCategories.forEach(category => {
            category.addEventListener('click', () => {
                darkShopCategories.forEach(c => c.classList.remove('active'));
                category.classList.add('active');
                loadDarkShopItems(category.getAttribute('data-category'));
            });
        });

        // Funções auxiliares
        function setBossBattleButtonsLocked(locked) {
            buttonsLocked = locked;
            
            const bossBattleButtons = document.querySelectorAll('.boss-battle-action-btn');
            
            bossBattleButtons.forEach(btn => {
                if (locked) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationScreen.style.display = 'flex';
        }

        // Loop principal do jogo
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            player.update(deltaTime);
            
            if (player.moveCooldown === 0 && !isInDialogue) {
                let moveResult = false;
                
                if (keys['w'] || keys['arrowup']) {
                    moveResult = player.move(0, -1, worldMap);
                } else if (keys['s'] || keys['arrowdown']) {
                    moveResult = player.move(0, 1, worldMap);
                } else if (keys['a'] || keys['arrowleft']) {
                    moveResult = player.move(-1, 0, worldMap);
                } else if (keys['d'] || keys['arrowright']) {
                    moveResult = player.move(1, 0, worldMap);
                }
                
                if (moveResult === 'monster') {
                    startBattle();
                } else if (moveResult === 'swampMonster') {
                    startSwampBattle();
                }
            }
          
            
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawMap(worldMap, player);
            
            player.draw();
            
            requestAnimationFrame(gameLoop);
        }

        addSaveLoadButtons();
        initGame();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>