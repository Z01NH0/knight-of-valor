<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knight of Valor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'MedievalSharp', cursive, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #f8c555;
            text-shadow: 0 0 10px rgba(248, 197, 85, 0.5);
            letter-spacing: 3px;
            font-weight: bold;
        }
        
        .game-board {
            position: relative;
            width: 100%;
            height: 600px;
            border: 4px solid #f8c555;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background: #0f3460;
        }
        
        canvas {
            display: block;
        }
        
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid #f8c555;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            width: 60px;
            font-weight: bold;
            color: #f8c555;
        }
        
        .bar-container {
            flex: 1;
            height: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(248, 197, 85, 0.3);
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .health-bar {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }
        
        .mana-bar {
            background: linear-gradient(90deg, #3498db, #9b59b6);
        }
        
        .stamina-bar {
            background: linear-gradient(90deg, #2ecc71, #f1c40f);
        }
        
        .exp-bar {
            background: linear-gradient(90deg, #9b59b6, #e74c3c);
        }
        
        .money-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .inventory-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid #f8c555;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .inventory-btn:hover {
            background: rgba(248, 197, 85, 0.2);
            transform: scale(1.1);
        }
        
        /* Tela de Combate */
        .battle-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        
        .battle-container {
            width: 90%;
            height: 90%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .battle-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(248, 197, 85, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(52, 152, 219, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .battle-scene {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
            position: relative;
            margin: 20px 0;
        }
        
        .battle-character {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .character-canvas {
            width: 200px;
            height: 200px;
            margin-bottom: 10px;
        }
        
        .battle-stats {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .player-stats, .enemy-stats {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 180px;
            border: 2px solid #f8c555;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .player-stats h3, .enemy-stats h3 {
            color: #f8c555;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 5px;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 0.9rem;
        }
        
        .round-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #f8c555;
            font-weight: bold;
        }
        
        .battle-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-btn:hover {
            background: linear-gradient(to bottom, #bdc3c7, #95a5a6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .battle-btn {
            background: linear-gradient(to bottom, #f8c555, #d4a017);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .battle-btn:hover {
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        
        .battle-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .battle-log {
            height: 100px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            overflow-y: auto;
            font-size: 0.9rem;
            border: 2px solid rgba(248, 197, 85, 0.3);
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .attack-options, .magic-options, .items-options, .act-options {
            display: none;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            position: relative;
        }
        
        .inventory-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(5px);
        }
        
        .inventory-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .close-btn {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: linear-gradient(to bottom, #ff6b6b, #e74c3c);
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .upgrade-points {
            margin: 10px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .upgrade-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upgrade-btn:hover {
            background: linear-gradient(to bottom, #58d68d, #2ecc71);
            transform: scale(1.1);
        }
        
        .upgrade-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .crafting-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .crafting-title {
            text-align: center;
            margin-bottom: 15px;
            color: #f8c555;
        }
        
        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 150px;
            margin: 0 auto 15px;
        }
        
        .crafting-slot {
            width: 40px;
            height: 40px;
            border: 2px solid #f8c555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .crafting-result {
            width: 60px;
            height: 60px;
            border: 3px solid #f8c555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            font-size: 1.5rem;
            position: relative;
            cursor: pointer;
        }
        
        .crafting-pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-slot {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(248, 197, 85, 0.2);
            text-align: center;
        }
        
        .item-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .instructions {
            margin-top: 15px;
            text-align: center;
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .status-effects {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .status-effect {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .burn { background: rgba(231, 76, 60, 0.7); }
        .slow { background: rgba(52, 152, 219, 0.7); }
        .stun { background: rgba(155, 89, 182, 0.7); }
        .strength-potion { background: rgba(230, 126, 34, 0.7); }
        .heavy-armor { background: rgba(149, 165, 166, 0.7); }
        
        /* Loja */
        .shop-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            backdrop-filter: blur(5px);
        }
        
        .shop-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .shop-categories {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .shop-category {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .shop-category.active {
            background: rgba(248, 197, 85, 0.2);
            border-color: #f8c555;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .shop-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .shop-item-price {
            color: #f8c555;
            margin-bottom: 10px;
        }
        
        .shop-buy-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .shop-buy-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #58d68d, #2ecc71);
        }
        
        .shop-buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        /* Menu de Equipamentos */
        .equipment-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 25;
            backdrop-filter: blur(5px);
        }
        
        .equipment-container {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a3a5f"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f8c555" stroke-width="1" opacity="0.1"/></svg>');
            border: 4px solid #f8c555;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(248, 197, 85, 0.3);
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(248, 197, 85, 0.3);
            padding-bottom: 10px;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .equipment-slot {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
            min-height: 150px;
        }
        
        .equipment-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .equipment-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .equipment-stats {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .equipment-btn {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .equipment-btn:hover {
            background: linear-gradient(to bottom, #5dade2, #3498db);
        }
        
        .inventory-btn-equipment {
            background: linear-gradient(to bottom, #f8c555, #d4a017);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'MedievalSharp', cursive;
            border: 2px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            margin-top: 10px;
        }
        
        .inventory-btn-equipment:hover {
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        
        .equipment-collection {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(248, 197, 85, 0.2);
        }
        
        .collection-title {
            text-align: center;
            margin-bottom: 15px;
            color: #f8c555;
        }
        
        .collection-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .collection-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid rgba(248, 197, 85, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .collection-item:hover {
            background: rgba(248, 197, 85, 0.1);
        }
        
        .collection-item.equipped {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }
        
        .collection-item-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .game-board {
                height: 500px;
            }
            
            .battle-container {
                width: 95%;
                height: 95%;
            }
            
            .battle-stats {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .player-stats, .enemy-stats {
                min-width: 90%;
            }
            
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .shop-items {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .collection-items {
                grid-template-columns: 1fr;
            }
        }
        
        /* Efeitos visuais de batalha */
        .battle-effect {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        .damage-text {
            position: absolute;
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        .status-text {
            position: absolute;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        
        .burn-text { color: #ff6b6b; }
        .slow-text { color: #74b9ff; }
        .stun-text { color: #a29bfe; }
        .strength-text { color: #f39c12; }
        .heavy-armor-text { color: #bdc3c7; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1></h1>
        </div>
        
        <div class="game-board">
            <canvas id="gameCanvas" width="1000" height="600"></canvas>
            
            <div class="ui-overlay">
                <div class="stat-bar">
                    <div class="stat-label">HP:</div>
                    <div class="bar-container">
                        <div id="healthBar" class="bar-fill health-bar" style="width: 100%"></div>
                    </div>
                    <span id="healthText">100/100</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">MANA:</div>
                    <div class="bar-container">
                        <div id="manaBar" class="bar-fill mana-bar" style="width: 100%"></div>
                    </div>
                    <span id="manaText">50/50</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">STAMINA:</div>
                    <div class="bar-container">
                        <div id="staminaBar" class="bar-fill stamina-bar" style="width: 100%"></div>
                    </div>
                    <span id="staminaText">30/30</span>
                </div>
                
                <div class="stat-bar">
                    <div class="stat-label">EXP:</div>
                    <div class="bar-container">
                        <div id="expBar" class="bar-fill exp-bar" style="width: 0%"></div>
                    </div>
                    <span id="expText">0/40</span>
                </div>
                
                <div class="money-display">
                    <span>💰</span>
                    <span id="moneyText">100</span>
                </div>
            </div>
            
            <div class="inventory-btn" id="inventoryBtn">
                🎒
            </div>
            
            <!-- Tela de Combate -->
            <div class="battle-screen" id="battleScreen">
                <div class="battle-container">
                    <div class="round-indicator" id="roundIndicator">Round 1</div>
                    
                    <div class="battle-stats">
                        <div class="player-stats">
                            <h3>Cavaleiro</h3>
                            <div class="stat-line">
                                <span>Nível:</span>
                                <span id="battlePlayerLevel">1</span>
                            </div>
                            <div class="stat-line">
                                <span>HP:</span>
                                <span id="battlePlayerHealth">100</span>/<span id="battlePlayerMaxHealth">100</span>
                            </div>
                            <div class="stat-line">
                                <span>MANA:</span>
                                <span id="battlePlayerMana">50</span>/<span id="battlePlayerMaxMana">50</span>
                            </div>
                            <div class="stat-line">
                                <span>STAMINA:</span>
                                <span id="battlePlayerStamina">30</span>/<span id="battlePlayerMaxStamina">30</span>
                            </div>
                            <div id="playerStatusEffects" class="status-effects"></div>
                        </div>
                        <div class="enemy-stats">
                            <h3 id="enemyName">Monstro</h3>
                            <div class="stat-line">
                                <span>Nível:</span>
                                <span id="battleEnemyLevel">1</span>
                            </div>
                            <div class="stat-line">
                                <span>HP:</span>
                                <span id="battleEnemyHealth">20</span>/<span id="battleEnemyMaxHealth">20</span>
                            </div>
                            <div class="stat-line">
                                <span>Agilidade:</span>
                                <span id="battleEnemyAgility">5</span>
                            </div>
                            <div id="enemyStatusEffects" class="status-effects"></div>
                        </div>
                    </div>
                    
                    <div class="battle-scene">
                        <div class="battle-character">
                            <canvas id="playerBattleCanvas" class="character-canvas" width="200" height="200"></canvas>
                            <div>Cavaleiro</div>
                        </div>
                        <div class="battle-character">
                            <canvas id="enemyBattleCanvas" class="character-canvas" width="200" height="200"></canvas>
                            <div id="enemyBattleName">Monstro</div>
                        </div>
                    </div>
                    
                    <div class="battle-log" id="battleLog">
                        <div class="log-entry">Uma batalha começou!</div>
                    </div>
                    
                    <div class="battle-actions" id="battleActions">
                        <button class="back-btn" id="backBtn" style="display: none;">← Voltar</button>
                        <button class="battle-btn" id="attackBtn">ATACAR</button>
                        <button class="battle-btn" id="magicBtn">PODER MÁGICO</button>
                        <button class="battle-btn" id="itemsBtn">ITENS</button>
                        <button class="battle-btn" id="actBtn">AGIR</button>
                    </div>
                    
                    <div class="attack-options" id="attackOptions">
                        <button class="back-btn" id="backFromAttackBtn">← Voltar</button>
                        <button class="battle-btn" id="swordAttackBtn">ESPADADA</button>
                        <button class="battle-btn" id="chargeBtn" disabled>INVESTIDA (Bloqueada)</button>
                        <button class="battle-btn" id="heavyArmorBtn" disabled>ARMADURA PESADA (Bloqueada)</button>
                    </div>
                    
                    <div class="magic-options" id="magicOptions">
                        <button class="back-btn" id="backFromMagicBtn">← Voltar</button>
                        <button class="battle-btn" id="fireballBtn" disabled>BOLA DE FOGO (Bloqueada)</button>
                        <button class="battle-btn" id="freezeBtn" disabled>BRISA CONGELANTE (Bloqueada)</button>
                        <button class="battle-btn" id="possessionBtn" disabled>POSSEÇÃO (Bloqueada)</button>
                    </div>
                    
                    <div class="items-options" id="itemsOptions">
                        <button class="back-btn" id="backFromItemsBtn">← Voltar</button>
                        <div class="items-grid" id="battleItemsGrid">
                            <!-- Itens serão adicionados dinamicamente -->
                        </div>
                    </div>
                    
                    <div class="act-options" id="actOptions">
                        <button class="back-btn" id="backFromActBtn">← Voltar</button>
                        <button class="battle-btn" id="meditateBtn">MEDITAR</button>
                    </div>
                </div>
            </div>
            
            <!-- Tela de Inventário -->
            <div class="inventory-screen" id="inventoryScreen">
                <div class="inventory-container">
                    <div class="inventory-header">
                        <h2>Inventário e Status</h2>
                        <button class="close-btn" id="closeInventoryBtn">Fechar</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span>Nível:</span>
                            <span id="inventoryLevel">1</span>
                        </div>
                        <div class="stat-item">
                            <span>Experiência:</span>
                            <span id="inventoryExp">0/100</span>
                        </div>
                        <div class="stat-item">
                            <span>Dinheiro:</span>
                            <span id="inventoryMoney">100</span>
                        </div>
                        <div class="stat-item">
                            <span>Pontos de Upgrade:</span>
                            <span id="upgradePoints">0</span>
                        </div>
                    </div>
                    
                    <div class="upgrade-points" id="upgradeSection">
                        <h3>Atributos</h3>
                        <div class="stat-item">
                            <span>HP: <span id="statHp">10</span></span>
                            <button class="upgrade-btn" data-stat="hp">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Força: <span id="statStr">10</span></span>
                            <button class="upgrade-btn" data-stat="str">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Agilidade: <span id="statAgi">10</span></span>
                            <button class="upgrade-btn" data-stat="agi">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Defesa: <span id="statDef">10</span></span>
                            <button class="upgrade-btn" data-stat="def">+</button>
                        </div>
                        <div class="stat-item">
                            <span>Magia: <span id="statMag">10</span></span>
                            <button class="upgrade-btn" data-stat="mag">+</button>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Habilidades Desbloqueadas</h3>
                        <div id="unlockedSkills">
                            <div>Investida: <span id="chargeStatus">Bloqueada</span></div>
                            <div>Armadura Pesada: <span id="heavyArmorStatus">Bloqueada</span></div>
                            <div>Bola de Fogo: <span id="fireballStatus">Bloqueada</span></div>
                            <div>Brisa Congelante: <span id="freezeStatus">Bloqueada</span></div>
                            <div>Posseção: <span id="possessionStatus">Bloqueada</span></div>
                        </div>
                    </div>
                    
                    <div class="upgrade-points">
                        <h3>Itens</h3>
                        <div class="items-grid">
                            <div class="item-slot">
                                <div class="item-icon">🍎</div>
                                <div>Maçã: <span id="inventoryMaceCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🍗</div>
                                <div>Pernil: <span id="inventoryHamCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🧪</div>
                                <div>Poção de Força: <span id="inventoryStrengthPotionCount">0</span></div>
                            </div>
                            <div class="item-slot">
                                <div class="item-icon">🐉</div>
                                <div>Escamas de Dragão: <span id="inventoryDragonScalesCount">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="crafting-section">
                        <h3 class="crafting-title">Crafting - Dragon Slayer</h3>
                        <div class="crafting-grid">
                            <div class="crafting-slot" id="craftSlot1"></div>
                            <div class="crafting-slot" id="craftSlot2"></div>
                            <div class="crafting-slot" id="craftSlot3"></div>
                            <div class="crafting-slot" id="craftSlot4"></div>
                            <div class="crafting-slot" id="craftSlot5"></div>
                            <div class="crafting-slot" id="craftSlot6"></div>
                            <div class="crafting-slot" id="craftSlot7"></div>
                            <div class="crafting-slot" id="craftSlot8"></div>
                            <div class="crafting-slot" id="craftSlot9"></div>
                        </div>
                        <div class="crafting-result" id="craftingResult">
                            <span>⚔️</span>
                        </div>
                        <p style="text-align: center; margin-top: 10px; font-size: 0.9rem;">
                            Receita: Pernil no centro inferior, Escamas de Dragão nas outras posições
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="battle-btn" id="equipmentBtn">Ver Equipamentos</button>
                    </div>
                </div>
            </div>
            
            <!-- Tela de Equipamentos -->
            <div class="equipment-screen" id="equipmentScreen">
                <div class="equipment-container">
                    <div class="equipment-header">
                        <h2>Equipamentos</h2>
                        <button class="close-btn" id="closeEquipmentBtn">Fechar</button>
                    </div>
                    
                    <div class="equipment-slots">
                        <div class="equipment-slot">
                            <div class="equipment-icon">⚔️</div>
                            <div class="equipment-name" id="weaponName">Espada Básica</div>
                            <div class="equipment-stats" id="weaponStats">Dano: 1.0x</div>
                            <div class="equipment-stats" id="weaponDescription">Sua espada inicial</div>
                        </div>
                        
                        <div class="equipment-slot">
                            <div class="equipment-icon">🛡️</div>
                            <div class="equipment-name" id="armorName">Armadura Básica</div>
                            <div class="equipment-stats" id="armorStats">Defesa: 1.0x</div>
                            <div class="equipment-stats" id="armorDescription">Sua armadura inicial</div>
                        </div>
                    </div>
                    
                    <button class="inventory-btn-equipment" id="inventoryBtnEquipment">Inventário</button>
                    
                    <div class="equipment-collection" id="equipmentCollection" style="display: none;">
                        <h3 class="collection-title">Coleção de Equipamentos</h3>
                        <div class="collection-items" id="collectionItems">
                            <!-- Itens da coleção serão carregados dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tela da Loja -->
            <div class="shop-screen" id="shopScreen">
                <div class="shop-container">
                    <div class="shop-header">
                        <h2>Loja do Mercador</h2>
                        <button class="close-btn" id="closeShopBtn">Fechar</button>
                    </div>
                    
                    <div class="shop-categories">
                        <div class="shop-category active" data-category="food">Comidas</div>
                        <div class="shop-category" data-category="weapons">Armamentos</div>
                        <div class="shop-category" data-category="potions">Poções</div>
                    </div>
                    
                    <div class="shop-items" id="shopItems">
                        <!-- Itens da loja serão carregados dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <p></p>
            <p></p>
        </div>
    </div>

    <script>
        // Configurações do jogo
        const TILE_SIZE = 64;
        const MAP_WIDTH = 16;  // Largura do mapa visível
        const MAP_HEIGHT = 10; // Altura do mapa visível
        const WORLD_SIZE = 200; // Tamanho do mundo (200x200 tiles)
        const MOVE_COOLDOWN = 200; // 0.6 segundos entre movimentos
        const MONSTER_SPAWN_CHANCE = 0.1; // 30% de chance de spawnar monstro a cada 3 tiles

        // Elementos do DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Elementos de UI
        const healthBar = document.getElementById('healthBar');
        const healthText = document.getElementById('healthText');
        const manaBar = document.getElementById('manaBar');
        const manaText = document.getElementById('manaText');
        const staminaBar = document.getElementById('staminaBar');
        const staminaText = document.getElementById('staminaText');
        const expBar = document.getElementById('expBar');
        const expText = document.getElementById('expText');
        const moneyText = document.getElementById('moneyText');
        
        // Elementos de batalha
        const playerCanvas = document.getElementById('playerBattleCanvas');
        const enemyCanvas = document.getElementById('enemyBattleCanvas');
        const battleScreen = document.getElementById('battleScreen');
        const battlePlayerLevel = document.getElementById('battlePlayerLevel');
        const battlePlayerHealth = document.getElementById('battlePlayerHealth');
        const battlePlayerMaxHealth = document.getElementById('battlePlayerMaxHealth');
        const battlePlayerMana = document.getElementById('battlePlayerMana');
        const battlePlayerMaxMana = document.getElementById('battlePlayerMaxMana');
        const battlePlayerStamina = document.getElementById('battlePlayerStamina');
        const battlePlayerMaxStamina = document.getElementById('battlePlayerMaxStamina');
        const battleEnemyLevel = document.getElementById('battleEnemyLevel');
        const battleEnemyHealth = document.getElementById('battleEnemyHealth');
        const battleEnemyMaxHealth = document.getElementById('battleEnemyMaxHealth');
        const battleEnemyAgility = document.getElementById('battleEnemyAgility');
        const enemyName = document.getElementById('enemyName');
        const battleLog = document.getElementById('battleLog');
        const battleActions = document.getElementById('battleActions');
        const attackOptions = document.getElementById('attackOptions');
        const magicOptions = document.getElementById('magicOptions');
        const itemsOptions = document.getElementById('itemsOptions');
        const actOptions = document.getElementById('actOptions');
        const attackBtn = document.getElementById('attackBtn');
        const swordAttackBtn = document.getElementById('swordAttackBtn');
        const chargeBtn = document.getElementById('chargeBtn');
        const heavyArmorBtn = document.getElementById('heavyArmorBtn');
        const magicBtn = document.getElementById('magicBtn');
        const itemsBtn = document.getElementById('itemsBtn');
        const fireballBtn = document.getElementById('fireballBtn');
        const freezeBtn = document.getElementById('freezeBtn');
        const possessionBtn = document.getElementById('possessionBtn');
        const actBtn = document.getElementById('actBtn');
        const meditateBtn = document.getElementById('meditateBtn');
        const roundIndicator = document.getElementById('roundIndicator');
        const playerStatusEffects = document.getElementById('playerStatusEffects');
        const enemyStatusEffects = document.getElementById('enemyStatusEffects');
        const backBtn = document.getElementById('backBtn');
        const backFromAttackBtn = document.getElementById('backFromAttackBtn');
        const backFromMagicBtn = document.getElementById('backFromMagicBtn');
        const backFromItemsBtn = document.getElementById('backFromItemsBtn');
        const backFromActBtn = document.getElementById('backFromActBtn');
        const battleItemsGrid = document.getElementById('battleItemsGrid');
        
        // Elementos de inventário
        const inventoryScreen = document.getElementById('inventoryScreen');
        const inventoryBtn = document.getElementById('inventoryBtn');
        const closeInventoryBtn = document.getElementById('closeInventoryBtn');
        const inventoryLevel = document.getElementById('inventoryLevel');
        const inventoryExp = document.getElementById('inventoryExp');
        const inventoryMoney = document.getElementById('inventoryMoney');
        const upgradePoints = document.getElementById('upgradePoints');
        
        // Elementos de status
        const statHp = document.getElementById('statHp');
        const statStr = document.getElementById('statStr');
        const statAgi = document.getElementById('statAgi');
        const statDef = document.getElementById('statDef');
        const statMag = document.getElementById('statMag');
        const chargeStatus = document.getElementById('chargeStatus');
        const heavyArmorStatus = document.getElementById('heavyArmorStatus');
        const fireballStatus = document.getElementById('fireballStatus');
        const freezeStatus = document.getElementById('freezeStatus');
        const possessionStatus = document.getElementById('possessionStatus');
        
        // Elementos de itens
        const inventoryMaceCount = document.getElementById('inventoryMaceCount');
        const inventoryHamCount = document.getElementById('inventoryHamCount');
        const inventoryStrengthPotionCount = document.getElementById('inventoryStrengthPotionCount');
        const inventoryDragonScalesCount = document.getElementById('inventoryDragonScalesCount');
        
        // Elementos de crafting
        const craftingSlots = [
            document.getElementById('craftSlot1'),
            document.getElementById('craftSlot2'),
            document.getElementById('craftSlot3'),
            document.getElementById('craftSlot4'),
            document.getElementById('craftSlot5'),
            document.getElementById('craftSlot6'),
            document.getElementById('craftSlot7'),
            document.getElementById('craftSlot8'),
            document.getElementById('craftSlot9')
        ];
        const craftingResult = document.getElementById('craftingResult');
        
        // Elementos de equipamentos
        const equipmentScreen = document.getElementById('equipmentScreen');
        const equipmentBtn = document.getElementById('equipmentBtn');
        const closeEquipmentBtn = document.getElementById('closeEquipmentBtn');
        const weaponName = document.getElementById('weaponName');
        const weaponStats = document.getElementById('weaponStats');
        const weaponDescription = document.getElementById('weaponDescription');
        const armorName = document.getElementById('armorName');
        const armorStats = document.getElementById('armorStats');
        const armorDescription = document.getElementById('armorDescription');
        const inventoryBtnEquipment = document.getElementById('inventoryBtnEquipment');
        const equipmentCollection = document.getElementById('equipmentCollection');
        const collectionItems = document.getElementById('collectionItems');
        
        // Elementos da loja
        const shopScreen = document.getElementById('shopScreen');
        const closeShopBtn = document.getElementById('closeShopBtn');
        const shopCategories = document.querySelectorAll('.shop-category');
        const shopItems = document.getElementById('shopItems');
        
        // Cores
        const COLORS = {
            GRASS: '#2ecc71',
            GRASS_DARK: '#27ae60',
            WATER: '#3498db',
            WATER_DARK: '#2980b9',
            FOREST: '#27ae60',
            FOREST_DARK: '#229954',
            MOUNTAIN: '#95a5a6',
            MOUNTAIN_DARK: '#7f8c8d',
            PATH: '#d35400',
            PATH_DARK: '#ba4a00',
            FLOWER1: '#e74c3c',
            FLOWER2: '#9b59b6',
            FLOWER3: '#f1c40f',
            SAND: '#f1c40f',
            SAND_DARK: '#d4ac0d',
            SHOP: '#8B4513',
            SHOP_DARK: '#654321'
        };

        // Classe do Jogador
        class Player {
            constructor() {
                this.level = 1;
                this.x = WORLD_SIZE / 2;
                this.y = WORLD_SIZE / 2;
                this.money = 0;
                this.exp = 0;
                this.expToNextLevel = 40;
                this.upgradePoints = 0
                
                // Atributos base
                this.baseHp = 10;
                this.baseStr = 10;
                this.baseAgi = 10;
                this.baseDef = 10;
                this.baseMag = 10;
                
                // Atributos atuais (com multiplicadores)
                this.maxHealth = Math.floor(this.baseHp * 10);
                this.health = this.maxHealth;
                this.maxMana = Math.floor(50 * Math.pow(1.05, this.baseMag - 10));
                this.mana = this.maxMana;
                this.maxStamina = 30 + (this.baseAgi - 10) * 2; // Stamina base + 2 por ponto de agilidade
                this.stamina = this.maxStamina;
                this.strength = this.baseStr;
                this.agility = this.baseAgi;
                this.defense = this.baseDef;
                this.magic = this.baseMag;
                
                this.dodgeChance = 0.04 + (this.baseAgi - 10) * 0.03; // 4% base + 0.3% por ponto de agilidade
                this.moveCooldown = 0;
                this.stepsTaken = 0;
                
                // Status effects
                this.statusEffects = [];
                
                // Itens
                this.items = {
                    mace: 2,
                    ham: 0,
                    strengthPotion: 0,
                    dragonScales: 0
                };
                
                // Crafting
                this.craftingSlots = Array(9).fill(null);
                this.hasDragonSlayer = false;
                this.dragonSlayerMultiplier = 1; // Multiplicador de dano da Dragon Slayer
                
                // Equipamentos
                this.weapon = {
                    name: "Espada Básica",
                    damageMultiplier: 1.0,
                    description: "Sua espada inicial",
                    icon: "⚔️",
                    type: "weapon"
                };
                
                this.armor = {
                    name: "Armadura Básica",
                    defenseMultiplier: 1.0,
                    agilityPenalty: 0,
                    description: "Sua armadura inicial",
                    icon: "🛡️",
                    type: "armor"
                };
                
                // Coleção de equipamentos
                this.equipmentCollection = [
                    {
                        name: "Espada Básica",
                        damageMultiplier: 1.0,
                        description: "Sua espada inicial",
                        icon: "⚔️",
                        type: "weapon",
                        equipped: true
                    },
                    {
                        name: "Armadura Básica",
                        defenseMultiplier: 1.0,
                        agilityPenalty: 0,
                        description: "Sua armadura inicial",
                        icon: "🛡️",
                        type: "armor",
                        equipped: true
                    }
                ];
                
                // Itens comprados na loja
                this.purchasedItems = {
                    stoneSword: false,
                    goldSword: false,
                    chainMail: false,
                    goldArmor: false
                };
            }
            
            draw() {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // Desenhar o cavaleiro com base nos equipamentos
                this.drawKnight(centerX, centerY);
            }
            
            drawKnight(x, y) {
                // Corpo com armadura baseada no equipamento
                if (this.armor.name === "Armadura de Malha") {
                    // Armadura de malha
                    ctx.fillStyle = '#7f8c8d';
                    ctx.fillRect(x - 20, y - 15, 40, 30);
                    
                    // Detalhes da armadura de malha
                    ctx.fillStyle = '#95a5a6';
                    for (let i = 0; i < 4; i++) {
                        for (let j = 0; j < 3; j++) {
                            ctx.fillRect(x - 18 + i * 12, y - 13 + j * 10, 8, 8);
                        }
                    }
                } else if (this.armor.name === "Armadura de Ouro") {
                    // Armadura de ouro
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(x - 20, y - 15, 40, 30);
                    
                    // Detalhes dourados
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(x - 18, y - 13, 36, 26);
                    
                    // Padrão de armadura dourada
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(x - 15, y - 10, 30, 20);
                    
                    // Detalhes ornamentais
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(x - 12, y - 7, 24, 14);
                } else {
                    // Armadura básica
                    ctx.fillStyle = '#34495e';
                    ctx.fillRect(x - 20, y - 15, 40, 30);
                    
                    // Detalhes da armadura
                    ctx.fillStyle = '#2c3e50';
                    ctx.fillRect(x - 18, y - 13, 36, 26);
                }
                
                // Cabeça
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(x - 10, y - 25, 20, 10);
                
                // Capacete com detalhes
                ctx.fillStyle = this.armor.name === "Armadura de Ouro" ? '#f8c555' : '#95a5a6';
                ctx.fillRect(x - 12, y - 27, 24, 5);
                ctx.fillRect(x - 15, y - 22, 30, 3);
                
                // Visor do capacete
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x - 8, y - 24, 16, 4);
                
                // Escudo
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(x - 25, y - 10, 8, 20);
                
                // Detalhes do escudo
                ctx.fillStyle = '#f8c555';
                ctx.fillRect(x - 23, y - 5, 4, 10);
                
                // Espada baseada no equipamento
                this.drawWeapon(x, y);
            }
            
            drawWeapon(x, y) {
                if (this.hasDragonSlayer) {
                    // Dragon Slayer - espada épica
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillRect(x + 15, y - 15, 5, 30);
                    
                    // Lâmina flamejante
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.moveTo(x + 20, y - 15);
                    ctx.lineTo(x + 25, y - 20);
                    ctx.lineTo(x + 20, y - 10);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(x + 20, y);
                    ctx.lineTo(x + 25, y - 5);
                    ctx.lineTo(x + 20, y + 5);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(x + 20, y + 15);
                    ctx.lineTo(x + 25, y + 10);
                    ctx.lineTo(x + 20, y + 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Efeito de fogo
                    ctx.fillStyle = 'rgba(255, 69, 0, 0.3)';
                    ctx.beginPath();
                    ctx.arc(x + 22, y - 5, 8, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.weapon.name === "Espada de Pedra") {
                    // Espada de Pedra
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(x + 15, y - 12, 3, 24);
                    ctx.fillRect(x + 10, y - 15, 13, 6);
                    
                    // Detalhes da lâmina de pedra
                    ctx.fillStyle = '#7f8c8d';
                    ctx.fillRect(x + 16, y - 10, 1, 20);
                } else if (this.weapon.name === "Espada de Ouro") {
                    // Espada de Ouro
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(x + 15, y - 12, 3, 24);
                    ctx.fillRect(x + 10, y - 15, 13, 6);
                    
                    // Detalhes dourados
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(x + 11, y - 14, 11, 4);
                    ctx.fillRect(x + 16, y - 10, 1, 20);
                } else {
                    // Espada básica
                    ctx.fillStyle = '#bdc3c7';
                    ctx.fillRect(x + 15, y - 12, 3, 24);
                    ctx.fillRect(x + 10, y - 15, 13, 6);
                }
                
                // Detalhes da armadura
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - 20, y - 15, 40, 30);
            }
            
            drawBattle(ctx, isAttacking = false, attackType = null) {
                ctx.clearRect(0, 0, 200, 200);
                
                // Fundo do personagem
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 200, 200);
                
                // Efeito de ataque
                if (isAttacking) {
                    if (attackType === 'sword') {
                        ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                        ctx.fillRect(0, 0, 200, 200);
                    } else if (attackType === 'charge') {
                        // Efeito de investida - rastro de movimento
                        ctx.fillStyle = 'rgba(255, 165, 0, 0.4)';
                        ctx.beginPath();
                        ctx.arc(100, 100, 80, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (attackType === 'fireball') {
                        // Efeito de fogo
                        ctx.fillStyle = 'rgba(255, 69, 0, 0.5)';
                        ctx.beginPath();
                        ctx.arc(100, 100, 90, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (attackType === 'freeze') {
                        // Efeito de gelo
                        ctx.fillStyle = 'rgba(173, 216, 230, 0.5)';
                        ctx.beginPath();
                        ctx.arc(100, 100, 90, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (attackType === 'possession') {
                        // Efeito de possessão
                        ctx.fillStyle = 'rgba(138, 43, 226, 0.5)';
                        ctx.beginPath();
                        ctx.arc(100, 100, 90, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                const centerX = 100;
                const centerY = 100;
                
                // Corpo com armadura detalhada
                if (this.armor.name === "Armadura de Malha") {
                    ctx.fillStyle = '#7f8c8d';
                    ctx.fillRect(centerX - 35, centerY - 15, 70, 50);
                    
                    // Detalhes da armadura de malha
                    ctx.fillStyle = '#95a5a6';
                    for (let i = 0; i < 5; i++) {
                        for (let j = 0; j < 4; j++) {
                            ctx.fillRect(centerX - 33 + i * 14, centerY - 13 + j * 12, 10, 10);
                        }
                    }
                } else if (this.armor.name === "Armadura de Ouro") {
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(centerX - 35, centerY - 15, 70, 50);
                    
                    // Detalhes dourados
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(centerX - 33, centerY - 13, 66, 46);
                    
                    // Padrão de armadura dourada
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(cente0rX - 28, centerY - 8, 56, 36);
                    
                    // Detalhes ornamentais
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(centerX - 25, centerY - 5, 50, 30);
                } else {
                    ctx.fillStyle = '#2c3e50';
                    ctx.fillRect(centerX - 35, centerY - 15, 70, 50);
                    
                    // Detalhes da armadura
                    ctx.fillStyle = '#34495e';
                    ctx.fillRect(centerX - 33, centerY - 13, 66, 46);
                }
                
                // Cabeça
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(centerX - 20, centerY - 40, 40, 25);
                
                // Capacete com detalhes
                ctx.fillStyle = this.armor.name === "Armadura de Ouro" ? '#f8c555' : '#7f8c8d';
                ctx.fillRect(centerX - 25, centerY - 45, 50, 10);
                ctx.fillRect(centerX - 30, centerY - 35, 60, 5);
                
                // Visor do capacete
                ctx.fillStyle = '#3498db';
                ctx.fillRect(centerX - 15, centerY - 38, 30, 10);
                
                // Escudo
                ctx.fillStyle = '#34495e';
                ctx.fillRect(centerX - 55, centerY - 10, 20, 40);
                
                // Detalhes do escudo
                ctx.fillStyle = '#f8c555';
                ctx.fillRect(centerX - 53, centerY, 16, 30);
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(centerX - 45, centerY + 15, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // Espada baseada no equipamento
                this.drawBattleWeapon(ctx, centerX, centerY, isAttacking);
                
                // Detalhes da armadura
                ctx.strokeStyle = '#1c2833';
                ctx.lineWidth = 2;
                ctx.strokeRect(centerX - 35, centerY - 15, 70, 50);
            }
            
            drawBattleWeapon(ctx, x, y, isAttacking) {
                if (this.hasDragonSlayer) {
                    // Dragon Slayer - espada épica
                    ctx.fillStyle = '#e74c3c';
                    // Lâmina
                    ctx.fillRect(x + 25, y - 20, 8, 50);
                    // Guarda
                    ctx.fillRect(x + 20, y - 25, 18, 12);
                    // Punho
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + 25, y + 30, 8, 20);
                    
                    // Efeito flamejante
                    if (isAttacking) {
                        ctx.fillStyle = '#f39c12';
                        ctx.beginPath();
                        ctx.moveTo(x + 33, y - 20);
                        ctx.lineTo(x + 45, y - 35);
                        ctx.lineTo(x + 33, y - 5);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(x + 33, y + 5);
                        ctx.lineTo(x + 45, y - 10);
                        ctx.lineTo(x + 33, y + 20);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(x + 33, y + 30);
                        ctx.lineTo(x + 45, y + 15);
                        ctx.lineTo(x + 33, y + 45);
                        ctx.closePath();
                        ctx.fill();
                    }
                } else if (this.weapon.name === "Espada de Pedra") {
                    // Espada de Pedra
                    ctx.fillStyle = '#95a5a6';
                    // Lâmina
                    ctx.fillRect(x + 25, y - 20, 6, 50);
                    // Guarda
                    ctx.fillRect(x + 20, y - 25, 16, 12);
                    // Punho
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + 25, y + 30, 6, 20);
                    
                    // Detalhes da lâmina de pedra
                    ctx.fillStyle = '#7f8c8d';
                    ctx.fillRect(x + 26, y - 15, 4, 40);
                } else if (this.weapon.name === "Espada de Ouro") {
                    // Espada de Ouro
                    ctx.fillStyle = '#f8c555';
                    // Lâmina
                    ctx.fillRect(x + 25, y - 20, 6, 50);
                    // Guarda
                    ctx.fillRect(x + 20, y - 25, 16, 12);
                    // Punho
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + 25, y + 30, 6, 20);
                    
                    // Detalhes dourados
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(x + 21, y - 24, 14, 10);
                    ctx.fillRect(x + 26, y - 15, 4, 40);
                } else {
                    // Espada básica
                    ctx.fillStyle = '#bdc3c7';
                    // Lâmina
                    ctx.fillRect(x + 25, y - 20, 6, 50);
                    // Guarda
                    ctx.fillRect(x + 20, y - 25, 16, 12);
                    // Punho
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + 25, y + 30, 6, 20);
                }
            }
            
            move(dx, dy, worldMap) {
                if (this.moveCooldown > 0) return false;
                
                const newX = this.x + dx;
                const newY = this.y + dy;
                
                // Verificar se a nova posição está dentro dos limites do mundo
                if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                    // Verificar se a nova posição não é água (intransponível)
                    if (worldMap[Math.floor(newY)][Math.floor(newX)] !== 1) {
                        this.x = newX;
                        this.y = newY;
                        this.moveCooldown = MOVE_COOLDOWN;
                        this.stepsTaken++;
                        
                        // Verificar se deve spawnar um monstro (a cada 3 passos)
                        if (this.stepsTaken % 3 === 0 && Math.random() < MONSTER_SPAWN_CHANCE) {
                            return 'monster';
                        }
                        
                        return true;
                    }
                }
                return false;
            }
            
            update(deltaTime) {
                if (this.moveCooldown > 0) {
                    this.moveCooldown -= deltaTime;
                    if (this.moveCooldown < 0) this.moveCooldown = 0;
                }
                
                // Atualizar status effects
                this.updateStatusEffects();
            }
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                        this.recalculateStats(); // Recalcular stats após remover efeito
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
                this.recalculateStats(); // Recalcular stats após adicionar efeito
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            updateUI() {
                healthBar.style.width = `${(this.health / this.maxHealth) * 100}%`;
                healthText.textContent = `${this.health}/${this.maxHealth}`;
                manaBar.style.width = `${(this.mana / this.maxMana) * 100}%`;
                manaText.textContent = `${this.mana}/${this.maxMana}`;
                staminaBar.style.width = `${(this.stamina / this.maxStamina) * 100}%`;
                staminaText.textContent = `${this.stamina}/${this.maxStamina}`;
                expBar.style.width = `${(this.exp / this.expToNextLevel) * 100}%`;
                expText.textContent = `${this.exp}/${this.expToNextLevel}`;
                moneyText.textContent = this.money;
                
                // Atualizar inventário
                inventoryLevel.textContent = this.level;
                inventoryExp.textContent = `${this.exp}/${this.expToNextLevel}`;
                inventoryMoney.textContent = this.money;
                upgradePoints.textContent = this.upgradePoints;
                
                statHp.textContent = this.baseHp;
                statStr.textContent = this.baseStr;
                statAgi.textContent = this.baseAgi;
                statDef.textContent = this.baseDef;
                statMag.textContent = this.baseMag;
                
                // Atualizar status das habilidades
                if (this.baseStr >= 13) {
                    chargeStatus.textContent = "Desbloqueada";
                    chargeBtn.disabled = false;
                    chargeBtn.textContent = "INVESTIDA";
                }
                if (this.baseStr >= 20) {
                    heavyArmorStatus.textContent = "Desbloqueada";
                    heavyArmorBtn.disabled = false;
                    heavyArmorBtn.textContent = "ARMADURA PESADA";
                }
                if (this.baseMag >= 12) {
                    fireballStatus.textContent = "Desbloqueada";
                    fireballBtn.disabled = false;
                    fireballBtn.textContent = "BOLA DE FOGO";
                }
                if (this.baseMag >= 15) {
                    freezeStatus.textContent = "Desbloqueada";
                    freezeBtn.disabled = false;
                    freezeBtn.textContent = "BRISA CONGELANTE";
                }
                if (this.baseMag >= 20) {
                    possessionStatus.textContent = "Desbloqueada";
                    possessionBtn.disabled = false;
                    possessionBtn.textContent = "POSSEÇÃO";
                }
                
                // Atualizar contagem de itens
                inventoryMaceCount.textContent = this.items.mace;
                inventoryHamCount.textContent = this.items.ham;
                inventoryStrengthPotionCount.textContent = this.items.strengthPotion;
                inventoryDragonScalesCount.textContent = this.items.dragonScales;
                
                // Atualizar tela de batalha
                battlePlayerLevel.textContent = this.level;
                battlePlayerHealth.textContent = this.health;
                battlePlayerMaxHealth.textContent = this.maxHealth;
                battlePlayerMana.textContent = this.mana;
                battlePlayerMaxMana.textContent = this.maxMana;
                battlePlayerStamina.textContent = this.stamina;
                battlePlayerMaxStamina.textContent = this.maxStamina;
                
                // Atualizar status effects na UI de batalha
                this.updateBattleStatusEffects();
                
                // Atualizar crafting
                this.updateCraftingUI();
                
                // Atualizar equipamentos
                this.updateEquipmentUI();
                
                // Atualizar itens de batalha
                this.updateBattleItems();
                
                // Atualizar coleção de equipamentos
                this.updateEquipmentCollection();
            }
            
            updateBattleStatusEffects() {
                playerStatusEffects.innerHTML = '';
                this.statusEffects.forEach(effect => {
                    const effectElement = document.createElement('div');
                    effectElement.className = `status-effect ${effect.type}`;
                    effectElement.textContent = effect.type.toUpperCase() + ` (${effect.duration})`;
                    playerStatusEffects.appendChild(effectElement);
                });
            }
            
            takeDamage(damage) {
                // Calcular dano com defesa
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                return actualDamage;
            }
            
            addExp(amount) {
                this.exp += amount;
                if (this.exp >= this.expToNextLevel) {
                    this.levelUp();
                }
            }
            
            levelUp() {
                this.level++;
                this.exp -= this.expToNextLevel;
                this.expToNextLevel = Math.floor(this.expToNextLevel * 1.5);
                this.upgradePoints += 1;
                
                // Aumentar stats base ao subir de nível
                this.baseHp += 1;
                this.baseStr += 1;
                this.baseAgi += 1;
                this.baseDef += 1;
                this.baseMag += 1;
                
                this.recalculateStats();
            }
            
            upgradeStat(stat) {
                if (this.upgradePoints > 0) {
                    this.upgradePoints--;
                    
                    switch(stat) {
                        case 'hp':
                            this.baseHp += 1;
                            break;
                        case 'str':
                            this.baseStr += 1;
                            break;
                        case 'agi':
                            this.baseAgi += 1;
                            this.maxStamina = 30 + (this.baseAgi - 10) * 2;
                            break;
                        case 'def':
                            this.baseDef += 1;
                            break;
                        case 'mag':
                            this.baseMag += 1;
                            break;
                    }
                    
                    this.recalculateStats();
                }
            }
            
            recalculateStats() {
                // Recalcular stats com multiplicadores
                this.maxHealth = Math.floor(this.baseHp * 10);
                this.maxMana = Math.floor(50 * Math.pow(1.05, this.baseMag - 10));
                this.maxStamina = 30 + (this.baseAgi - 10) * 2;
                this.strength = this.baseStr;
                this.agility = this.baseAgi - this.armor.agilityPenalty;
                this.defense = this.baseDef;
                this.magic = this.baseMag;
                
                // Aplicar multiplicador da Dragon Slayer
                if (this.hasDragonSlayer) {
                    this.strength = Math.floor(this.strength * 11);
                }
                
                // Aplicar multiplicador da espada
                this.strength = Math.floor(this.strength * this.weapon.damageMultiplier);
                
                // Aplicar multiplicador da armadura
                this.defense = Math.floor(this.defense * this.armor.defenseMultiplier);
                
                // Recalcular chance de esquiva baseada na agilidade
                this.dodgeChance = 0.04 + (this.agility - 10) * 0.03;
                
                // Aplicar efeitos de status
                if (this.hasStatusEffect('slow')) {
                    this.dodgeChance += 0.4; // 40% adicional de esquiva
                }
                
                // Garantir que stamina não exceda o máximo
                if (this.stamina > this.maxStamina) {
                    this.stamina = this.maxStamina;
                }
            }
            
            swordAttack() {
                const baseDamage = 5 + Math.floor(this.strength * 0.5);
                const isCritical = Math.random() < 0.05; // 5% de chance de crítico
                
                if (isCritical) {
                    return Math.floor(baseDamage * 2);
                }
                
                return baseDamage;
            }
            
            chargeAttack() {
                if (this.stamina < 30) {
                    return { success: false, message: "Stamina insuficiente para usar Investida!" };
                }
                
                this.stamina -= 30;
                const baseDamage = 11 + Math.floor(this.strength * 0.3);
                const isCritical = Math.random() < 0.15; // 15% de chance de crítico (3x mais)
                
                if (isCritical) {
                    return { success: true, damage: Math.floor(baseDamage * 4), isCritical: true }; // 4x de dano crítico
                }
                
                return { success: true, damage: baseDamage, isCritical: false };
            }
            
            activateHeavyArmor() {
                if (this.stamina < 50) {
                    return { success: false, message: "Stamina insuficiente para usar Armadura Pesada!" };
                }
                
                this.stamina -= 50;
                this.addStatusEffect({ type: 'heavy-armor', duration: 5, defenseMultiplier: 1.8 });
                return { success: true, message: "Armadura Pesada ativada! Defesa aumentada por 5 turnos!" };
            }
            
            useMana(amount) {
                if (this.mana >= amount) {
                    this.mana -= amount;
                    return true;
                }
                return false;
            }
            
            useStamina(amount) {
                if (this.stamina >= amount) {
                    this.stamina -= amount;
                    return true;
                }
                return false;
            }
            
            recoverStamina(amount) {
                this.stamina = Math.min(this.maxStamina, this.stamina + amount);
            }
            
            meditate() {
                this.mana = Math.min(this.maxMana, this.mana + 20);
                return "O cavaleiro medita e recupera 20 de mana!";
            }
            
            addItem(item, quantity = 1) {
                this.items[item] += quantity;
                this.updateUI();
            }
            
            useItem(item) {
                if (this.items[item] <= 0) return { success: false, message: "Você não tem este item!" };
                
                this.items[item]--;
                
                switch(item) {
                    case 'mace':
                        this.health = Math.min(this.maxHealth, this.health + 10);
                        return { success: true, message: "Usou a maçã e recuperou 10 de HP!" };
                    case 'ham':
                        this.health = Math.min(this.maxHealth, this.health + 25);
                        return { success: true, message: "Usou o pernil e recuperou 25 de HP!" };
                    case 'strengthPotion':
                        this.addStatusEffect({ type: 'strength-potion', duration: 4, damageMultiplier: 1.5 });
                        return { success: true, message: "Usou a poção de força! Seu ataque aumentou por 4 turnos!" };
                }
                
                this.updateUI();
                return { success: false, message: "Item não pode ser usado agora." };
            }
            
            updateCraftingUI() {
                // Atualizar slots de crafting
                for (let i = 0; i < 9; i++) {
                    craftingSlots[i].textContent = this.craftingSlots[i] ? 
                        (this.craftingSlots[i] === 'ham' ? '🍗' : '🐉') : '';
                }
                
                // Verificar se a receita está correta
                const recipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'dragonScales', null,
                    null, 'ham', null
                ];
                
                let recipeCorrect = true;
                for (let i = 0; i < 9; i++) {
                    if (this.craftingSlots[i] !== recipe[i]) {
                        recipeCorrect = false;
                        break;
                    }
                }
                
                // Atualizar resultado do crafting
                if (recipeCorrect && !this.hasDragonSlayer) {
                    craftingResult.classList.add('crafting-pulse');
                    craftingResult.title = "Clique para criar a Dragon Slayer!";
                } else {
                    craftingResult.classList.remove('crafting-pulse');
                    craftingResult.title = this.hasDragonSlayer ? "Você já possui a Dragon Slayer!" : "Receita incompleta";
                }
            }
            
            craftDragonSlayer() {
                const recipe = [
                    'dragonScales', 'dragonScales', 'dragonScales',
                    'dragonScales', 'dragonScales', null,
                    null, 'ham', null
                ];
                
                // Verificar se a receita está correta
                let recipeCorrect = true;
                for (let i = 0; i < 9; i++) {
                    if (this.craftingSlots[i] !== recipe[i]) {
                        recipeCorrect = false;
                        break;
                    }
                }
                
                if (recipeCorrect && !this.hasDragonSlayer) {
                    // Verificar se o jogador tem os itens necessários
                    if (this.items.ham >= 1 && this.items.dragonScales >= 5) {
                        this.items.ham -= 1;
                        this.items.dragonScales -= 5;
                        this.hasDragonSlayer = true;
                        
                        // Adicionar Dragon Slayer à coleção
                        this.addToEquipmentCollection({
                            name: "Dragon Slayer",
                            damageMultiplier: 11.0,
                            description: "A lendária espada forjada com escamas de dragão",
                            icon: "🐉⚔️",
                            type: "weapon",
                            equipped: false
                        });
                        
                        this.recalculateStats();
                        
                        // Limpar slots de crafting
                        this.craftingSlots = Array(9).fill(null);
                        
                        this.updateUI();
                        return "Você criou a Dragon Slayer! Seu dano aumentou 11x!";
                    } else {
                        return "Você não tem itens suficientes para criar a Dragon Slayer!";
                    }
                }
                
                return "Receita incorreta ou você já possui a Dragon Slayer!";
            }
            
            addToCraftingSlot(slotIndex, item) {
                if (this.craftingSlots[slotIndex] === null) {
                    // Verificar se o jogador tem o item
                    if ((item === 'ham' && this.items.ham > 0) || 
                        (item === 'dragonScales' && this.items.dragonScales > 0)) {
                        
                        this.craftingSlots[slotIndex] = item;
                        
                        // Consumir o item
                        if (item === 'ham') {
                            this.items.ham--;
                        } else if (item === 'dragonScales') {
                            this.items.dragonScales--;
                        }
                        
                        this.updateUI();
                        return true;
                    }
                }
                return false;
            }
            
            clearCraftingSlot(slotIndex) {
                // Devolver o item ao inventário
                if (this.craftingSlots[slotIndex] === 'ham') {
                    this.items.ham++;
                } else if (this.craftingSlots[slotIndex] === 'dragonScales') {
                    this.items.dragonScales++;
                }
                
                this.craftingSlots[slotIndex] = null;
                this.updateUI();
            }
            
            clearAllCraftingSlots() {
                for (let i = 0; i < 9; i++) {
                    this.clearCraftingSlot(i);
                }
            }
            
            updateEquipmentUI() {
                weaponName.textContent = this.weapon.name;
                weaponStats.textContent = `Dano: ${this.weapon.damageMultiplier}x`;
                weaponDescription.textContent = this.weapon.description;
                
                armorName.textContent = this.armor.name;
                armorStats.textContent = `Defesa: ${this.armor.defenseMultiplier}x`;
                if (this.armor.agilityPenalty > 0) {
                    armorDescription.textContent = `${this.armor.description} (-${this.armor.agilityPenalty} agilidade)`;
                } else {
                    armorDescription.textContent = this.armor.description;
                }
            }
            
            updateEquipmentCollection() {
                collectionItems.innerHTML = '';
                
                this.equipmentCollection.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = `collection-item ${item.equipped ? 'equipped' : ''}`;
                    itemElement.innerHTML = `
                        <div class="collection-item-icon">${item.icon}</div>
                        <div class="equipment-name">${item.name}</div>
                        <div class="equipment-stats">
                            ${item.type === 'weapon' ? `Dano: ${item.damageMultiplier}x` : `Defesa: ${item.defenseMultiplier}x`}
                        </div>
                        <div class="equipment-stats">${item.description}</div>
                    `;
                    
                    itemElement.addEventListener('click', () => {
                        this.equipItem(index);
                    });
                    
                    collectionItems.appendChild(itemElement);
                });
            }
            
            addToEquipmentCollection(item) {
                // Verificar se o item já existe na coleção
                const existingItemIndex = this.equipmentCollection.findIndex(i => i.name === item.name);
                
                if (existingItemIndex === -1) {
                    this.equipmentCollection.push(item);
                } else {
                    // Atualizar o item existente
                    this.equipmentCollection[existingItemIndex] = item;
                }
                
                this.updateEquipmentCollection();
            }
            
            equipItem(index) {
                const item = this.equipmentCollection[index];
                
                // Remover o status de equipado de todos os itens do mesmo tipo
                this.equipmentCollection.forEach(i => {
                    if (i.type === item.type) {
                        i.equipped = false;
                    }
                });
                
                // Equipar o novo item
                item.equipped = true;
                
                // Atualizar o equipamento atual
                if (item.type === 'weapon') {
                    this.weapon = item;
                } else if (item.type === 'armor') {
                    this.armor = item;
                }
                
                this.recalculateStats();
                this.updateUI();
                this.updateEquipmentCollection();
            }
            
            updateBattleItems() {
                battleItemsGrid.innerHTML = '';
                
                // Adicionar apenas itens que o jogador possui
                if (this.items.mace > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🍎</div>
                        <div>Maçã (x${this.items.mace})</div>
                        <button class="battle-btn use-item-btn" data-item="mace">Usar</button>
                    `;
                    battleItemsGrid.appendChild(itemSlot);
                }
                
                if (this.items.ham > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🍗</div>
                        <div>Pernil (x${this.items.ham})</div>
                        <button class="battle-btn use-item-btn" data-item="ham">Usar</button>
                    `;
                    battleItemsGrid.appendChild(itemSlot);
                }
                
                if (this.items.strengthPotion > 0) {
                    const itemSlot = document.createElement('div');
                    itemSlot.className = 'item-slot';
                    itemSlot.innerHTML = `
                        <div class="item-icon">🧪</div>
                        <div>Poção de Força (x${this.items.strengthPotion})</div>
                        <button class="battle-btn use-item-btn" data-item="strengthPotion">Usar</button>
                    `;
                    battleItemsGrid.appendChild(itemSlot);
                }
                
                // Adicionar event listeners para os novos botões
                document.querySelectorAll('.use-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const item = btn.getAttribute('data-item');
                        itemsOptions.style.display = 'none';
                        backBtn.style.display = 'none';
                        playerUseItem(item);
                    });
                });
            }
            
            buyItem(item, price) {
                if (this.money >= price) {
                    this.money -= price;
                    
                    switch(item) {
                        case 'mace':
                            this.items.mace++;
                            break;
                        case 'ham':
                            this.items.ham++;
                            break;
                        case 'strengthPotion':
                            this.items.strengthPotion++;
                            break;
                        case 'stoneSword':
                            if (!this.purchasedItems.stoneSword) {
                                this.addToEquipmentCollection({
                                    name: "Espada de Pedra",
                                    damageMultiplier: 1.2,
                                    description: "Uma espada feita de pedra afiada",
                                    icon: "⚔️",
                                    type: "weapon",
                                    equipped: false
                                });
                                this.purchasedItems.stoneSword = true;
                            }
                            break;
                        case 'goldSword':
                            if (!this.purchasedItems.goldSword) {
                                this.addToEquipmentCollection({
                                    name: "Espada de Ouro",
                                    damageMultiplier: 1.42,
                                    description: "Uma espada forjada em ouro puro",
                                    icon: "⚔️",
                                    type: "weapon",
                                    equipped: false
                                });
                                this.purchasedItems.goldSword = true;
                            }
                            break;
                        case 'chainMail':
                            if (!this.purchasedItems.chainMail) {
                                this.addToEquipmentCollection({
                                    name: "Armadura de Malha",
                                    defenseMultiplier: 1.3,
                                    agilityPenalty: 2,
                                    description: "Uma armadura de malha pesada",
                                    icon: "🛡️",
                                    type: "armor",
                                    equipped: false
                                });
                                this.purchasedItems.chainMail = true;
                            }
                            break;
                        case 'goldArmor':
                            if (!this.purchasedItems.goldArmor) {
                                this.addToEquipmentCollection({
                                    name: "Armadura de Ouro",
                                    defenseMultiplier: 1.5,
                                    agilityPenalty: 3,
                                    description: "Uma armadura de ouro ornamentada",
                                    icon: "🛡️",
                                    type: "armor",
                                    equipped: false
                                });
                                this.purchasedItems.goldArmor = true;
                            }
                            break;
                    }
                    
                    this.updateUI();
                    return true;
                }
                return false;
            }
        }

        // Classe do Monstro
        class Monster {
            constructor(type) {
                this.type = type;
                
                if (type === 'weak') {
                    this.name = "Goblin Fraco";
                    this.maxHealth = 20;
                    this.health = this.maxHealth;
                    this.attack = 4;
                    this.level = 1;
                    this.agility = 5;
                } else if (type === 'strong') {
                    this.name = "Orc Forte";
                    this.maxHealth = 35;
                    this.health = this.maxHealth;
                    this.attack = 11;
                    this.level = 3;
                    this.agility = 8;
                } else if (type === 'elite') {
                    this.name = "Dragão de Elite";
                    this.maxHealth = 100;
                    this.health = this.maxHealth;
                    this.attack = 25;
                    this.level = 5;
                    this.agility = 12;
                }
                
                // Atributos aleatórios
                this.defense = Math.floor(Math.random() * 5) + 1;
                this.agility = Math.floor(Math.random() * 5) + 1;
                this.magic = Math.floor(Math.random() * 5) + 1;
                
                // Status effects
                this.statusEffects = [];
                this.dodgeChance = 0.02 + (this.agility - 5) * 0.02; // 2% base + 0.2% por ponto de agilidade
            }
            
            drawBattle(ctx, isAttacking = false) {
                ctx.clearRect(0, 0, 200, 200);
                
                // Fundo do monstro
                ctx.fillStyle = 'rgba(26, 58, 95, 0.5)';
                ctx.fillRect(0, 0, 200, 200);
                
                // Efeito de ataque
                if (isAttacking) {
                    if (this.type === 'elite' && Math.random() < 0.3) {
                        // Efeito de queimadura do dragão
                        ctx.fillStyle = 'rgba(255, 69, 0, 0.5)';
                        ctx.beginPath();
                        ctx.arc(100, 100, 90, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillStyle = 'rgba(231, 76, 60, 0.3)';
                        ctx.fillRect(0, 0, 200, 200);
                    }
                }
                
                const centerX = 100;
                const centerY = 100;
                
                if (this.type === 'weak') {
                    // Desenhar Goblin melhorado
                    ctx.fillStyle = '#27ae60'; // Corpo verde
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 35, 45, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Cabeça
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 30, 25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Olhos
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 10, centerY - 32, 6, 0, Math.PI * 2);
                    ctx.arc(centerX + 10, centerY - 32, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Boca
                    ctx.fillStyle = '#c0392b';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 20, 8, 0, Math.PI, false);
                    ctx.fill();
                    
                    // Chifres
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 20, centerY - 50);
                    ctx.lineTo(centerX - 35, centerY - 65);
                    ctx.lineTo(centerX - 15, centerY - 55);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 20, centerY - 50);
                    ctx.lineTo(centerX + 35, centerY - 65);
                    ctx.lineTo(centerX + 15, centerY - 55);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Arma primitiva
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(centerX + 25, centerY - 20, 5, 40);
                    ctx.fillRect(centerX + 20, centerY - 25, 15, 10);
                    
                } else if (this.type === 'strong') {
                    // Desenhar Orc melhorado
                    ctx.fillStyle = '#34495e'; // Corpo cinza
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 40, 50, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Cabeça
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 35, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Olhos
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(centerX - 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.arc(centerX + 12, centerY - 38, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Presas
                    ctx.fillStyle = '#ecf0f1';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 15, centerY - 20);
                    ctx.lineTo(centerX - 20, centerY - 5);
                    ctx.lineTo(centerX - 10, centerY - 15);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 15, centerY - 20);
                    ctx.lineTo(centerX + 20, centerY - 5);
                    ctx.lineTo(centerX + 10, centerY - 15);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Machado
                    ctx.fillStyle = '#bdc3c7';
                    ctx.fillRect(centerX + 25, centerY - 35, 8, 50);
                    ctx.fillRect(centerX + 20, centerY - 30, 18, 12);
                    
                    // Detalhes do machado
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(centerX + 23, centerY - 25, 2, 30);
                    
                } else if (this.type === 'elite') {
                    // Desenhar Dragão melhorado
                    ctx.fillStyle = '#e74c3c'; // Corpo vermelho
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, 45, 35, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Cabeça
                    ctx.fillStyle = '#c0392b';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY - 40, 25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Olhos
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.arc(centerX - 10, centerY - 42, 8, 0, Math.PI * 2);
                    ctx.arc(centerX + 10, centerY - 42, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Pupilas
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(centerX - 10, centerY - 42, 4, 0, Math.PI * 2);
                    ctx.arc(centerX + 10, centerY - 42, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Chifres
                    ctx.fillStyle = '#d35400';
                    ctx.beginPath();
                    ctx.moveTo(centerX - 15, centerY - 55);
                    ctx.lineTo(centerX - 25, centerY - 70);
                    ctx.lineTo(centerX - 10, centerY - 58);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX + 15, centerY - 55);
                    ctx.lineTo(centerX + 25, centerY - 70);
                    ctx.lineTo(centerX + 10, centerY - 58);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Asas
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
                    ctx.beginPath();
                    ctx.ellipse(centerX - 40, centerY - 15, 25, 20, Math.PI/4, 0, Math.PI * 2);
                    ctx.ellipse(centerX + 40, centerY - 15, 25, 20, -Math.PI/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Fogo na boca
                    if (isAttacking) {
                        ctx.fillStyle = '#f39c12';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 35, 12, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#ff6b6b';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY - 35, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Escamas
                    ctx.fillStyle = '#c0392b';
                    for (let i = 0; i < 8; i++) {
                        ctx.beginPath();
                        ctx.arc(centerX - 20 + i * 5, centerY, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            updateStatusEffects() {
                for (let i = this.statusEffects.length - 1; i >= 0; i--) {
                    const effect = this.statusEffects[i];
                    effect.duration--;
                    
                    if (effect.duration <= 0) {
                        this.statusEffects.splice(i, 1);
                        this.recalculateStats();
                    } else if (effect.type === 'burn') {
                        // Aplicar dano de queimadura
                        this.health -= 4;
                        if (this.health < 0) this.health = 0;
                    }
                }
            }
            
            addStatusEffect(effect) {
                this.statusEffects.push(effect);
                this.recalculateStats();
            }
            
            hasStatusEffect(type) {
                return this.statusEffects.some(effect => effect.type === type);
            }
            
            recalculateStats() {
                // Recalcular chance de esquiva baseada na agilidade
                this.dodgeChance = 0.02 + (this.agility - 5) * 0.02;
                
                // Aplicar efeitos de status
                if (this.hasStatusEffect('slow')) {
                    this.dodgeChance -= 0.4; // 40% menos chance de esquiva
                    if (this.dodgeChance < 0) this.dodgeChance = 0;
                }
            }
            
            updateBattleStatusEffects() {
                enemyStatusEffects.innerHTML = '';
                this.statusEffects.forEach(effect => {
                    const effectElement = document.createElement('div');
                    effectElement.className = `status-effect ${effect.type}`;
                    effectElement.textContent = effect.type.toUpperCase() + ` (${effect.duration})`;
                    enemyStatusEffects.appendChild(effectElement);
                });
            }
            
            takeDamage(damage) {
                const actualDamage = Math.max(1, Math.floor(damage - (this.defense * 0.1)));
                this.health -= actualDamage;
                if (this.health < 0) this.health = 0;
                return actualDamage;
            }
            
            attackPlayer(player) {
                let damage = this.attack;
                
                // Dragão de Elite tem chance de causar queimadura
                if (this.type === 'elite' && Math.random() < 0.3) {
                    player.addStatusEffect({ type: 'burn', duration: 3 });
                    damage += 5; // Dano extra do ataque com queimadura
                }
                
                return damage;
            }
            
            dropItems(player) {
                let droppedItems = [];
                
                if (this.type === 'weak') {
                    // Goblin Fraco
                    if (Math.random() < 0.3) { // 20% de chance
                        player.addItem('mace');
                        droppedItems.push("maçã");
                    }
                    if (Math.random() < 0.05) { // 5% de chance
                        player.addItem('ham');
                        droppedItems.push("pernil");
                    }
                } else if (this.type === 'strong') {
                    // Orc Forte
                    if (Math.random() < 0.25) { // 10% de chance
                        player.addItem('mace');
                        droppedItems.push("maçã");
                    }
                    if (Math.random() < 0.3) { // 25% de chance
                        player.addItem('ham');
                        droppedItems.push("pernil");
                    }
                    if (Math.random() < 0.1) { // 5% de chance
                        player.addItem('strengthPotion');
                        droppedItems.push("poção de força");
                    }
                } else if (this.type === 'elite') {
                    // Dragão de Elite
                    if (Math.random() < 0.4) { // 5% de chance
                        player.addItem('mace');
                        droppedItems.push("maçã");
                    }
                    if (Math.random() < 0.2) { // 20% de chance
                        player.addItem('ham');
                        droppedItems.push("pernil");
                    }
                    if (Math.random() < 0.1) { // 10% de chance
                        player.addItem('strengthPotion');
                        droppedItems.push("poção de força");
                    }
                    if (Math.random() < 0.05) { // 1% de chance
                        player.addItem('dragonScales');
                        droppedItems.push("escamas de dragão");
                    }
                }
                
                return droppedItems;
            }
        }

        // Classe do Mercador
        class Merchant {
            constructor() {
                this.x = Math.floor(Math.random() * (WORLD_SIZE - 10)) + 5;
                this.y = Math.floor(Math.random() * (WORLD_SIZE - 10)) + 5;
            }
            
            draw() {
                const offsetX = player.x - MAP_WIDTH / 2;
                const offsetY = player.y - MAP_HEIGHT / 2;
                
                const screenX = Math.floor(this.x - offsetX);
                const screenY = Math.floor(this.y - offsetY);
                
                if (screenX >= 0 && screenX < MAP_WIDTH && screenY >= 0 && screenY < MAP_HEIGHT) {
                    // Desenhar cabana do mercador
                    const x = screenX * TILE_SIZE;
                    const y = screenY * TILE_SIZE;
                    
                    // Cabana
                    ctx.fillStyle = COLORS.SHOP;
                    ctx.fillRect(x + 10, y + 20, TILE_SIZE - 20, TILE_SIZE - 30);
                    
                    // Telhado
                    ctx.fillStyle = COLORS.SHOP_DARK;
                    ctx.beginPath();
                    ctx.moveTo(x, y + 20);
                    ctx.lineTo(x + TILE_SIZE / 2, y);
                    ctx.lineTo(x + TILE_SIZE, y + 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Porta
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + TILE_SIZE / 2 - 10, y + 30, 20, 30);
                    
                    // Janelas
                    ctx.fillStyle = '#3498db';
                    ctx.fillRect(x + 15, y + 30, 15, 15);
                    ctx.fillRect(x + TILE_SIZE - 30, y + 30, 15, 15);
                    
                    // Balcão
                    ctx.fillStyle = '#D2691E';
                    ctx.fillRect(x, y + TILE_SIZE - 10, TILE_SIZE, 10);
                    
                    // Mercador
                    ctx.fillStyle = '#f8c555';
                    ctx.fillRect(x + TILE_SIZE / 2 - 5, y + TILE_SIZE - 20, 10, 15);
                    
                    // Sinalização "Loja"
                    ctx.fillStyle = '#f8c555';
                    ctx.font = 'bold 12px MedievalSharp';
                    ctx.textAlign = 'center';
                    ctx.fillText('Loja', x + TILE_SIZE / 2, y - 5);
                }
            }
            
            isPlayerNearby(player) {
                const distance = Math.sqrt(Math.pow(player.x - this.x, 2) + Math.pow(player.y - this.y, 2));
                return distance < 2;
            }
        }

        // Gerar mapa procedural melhorado
        function generateWorldMap() {
            const map = Array(WORLD_SIZE).fill().map(() => Array(WORLD_SIZE).fill(0));
            
            // Adicionar corpos de água melhorados
            for (let i = 0; i < 10; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addWaterBody(map, x, y);
            }
            
            // Adicionar florestas com mais árvores
            for (let i = 0; i < 20; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addForest(map, x, y);
            }
            
            // Adicionar montanhas melhoradas
            for (let i = 0; i < 15; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addMountain(map, x, y);
            }
            
            // Adicionar caminhos
            for (let i = 0; i < 8; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addPath(map, x, y);
            }
            
            // Adicionar áreas de areia
            for (let i = 0; i < 5; i++) {
                const x = Math.floor(Math.random() * WORLD_SIZE);
                const y = Math.floor(Math.random() * WORLD_SIZE);
                addSandArea(map, x, y);
            }
            
            // Adicionar flores na grama
            addFlowers(map);
            
            return map;
        }
        
        function addWaterBody(map, x, y) {
            const size = 5 + Math.floor(Math.random() * 8);
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        // Criar formas mais orgânicas para a água
                        if (dist < size * (0.7 + Math.random() * 0.3)) {
                            map[newY][newX] = 1; // Água
                        }
                    }
                }
            }
        }
        
        function addForest(map, x, y) {
            const size = 6 + Math.floor(Math.random() * 10);
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        if (dist < size && Math.random() < 0.8 && map[newY][newX] === 0) {
                            map[newY][newX] = 2; // Floresta
                        }
                    }
                }
            }
        }
        
        function addMountain(map, x, y) {
            const size = 5 + Math.floor(Math.random() * 6);
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        // Criar montanhas mais realistas
                        if (dist < size * (0.8 + Math.random() * 0.2) && Math.random() < 0.8 && map[newY][newX] === 0) {
                            map[newY][newX] = 3; // Montanha
                        }
                    }
                }
            }
        }
        
        function addPath(map, x, y) {
            const length = 20 + Math.floor(Math.random() * 30);
            let dirX = Math.random() < 0.5 ? 1 : -1;
            let dirY = Math.random() < 0.5 ? 1 : -1;
            
            if (Math.random() < 0.5) dirY = 0;
            else dirX = 0;
            
            for (let i = 0; i < length; i++) {
                if (x >= 0 && x < WORLD_SIZE && y >= 0 && y < WORLD_SIZE) {
                    if (map[y][x] === 0) {
                        map[y][x] = 4; // Caminho
                    }
                    
                    // Mudar direção ocasionalmente de forma mais suave
                    if (Math.random() < 0.15) {
                        if (dirX !== 0) {
                            dirY = Math.random() < 0.5 ? 1 : -1;
                            dirX = 0;
                        } else {
                            dirX = Math.random() < 0.5 ? 1 : -1;
                            dirY = 0;
                        }
                    }
                    
                    x += dirX;
                    y += dirY;
                }
            }
        }
        
        function addSandArea(map, x, y) {
            const size = 4 + Math.floor(Math.random() * 5);
            for (let i = -size; i < size; i++) {
                for (let j = -size; j < size; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        const dist = Math.sqrt(i*i + j*j);
                        if (dist < size && Math.random() < 0.7 && map[newY][newX] === 0) {
                            map[newY][newX] = 6; // Areia
                        }
                    }
                }
            }
        }
        
        function addFlowers(map) {
            // Adicionar flores aleatórias na grama
            for (let y = 0; y < WORLD_SIZE; y++) {
                for (let x = 0; x < WORLD_SIZE; x++) {
                    if (map[y][x] === 0 && Math.random() < 0.03) { // 3% de chance em tiles de grama
                        map[y][x] = 5; // Flor
                    }
                }
            }
        }

        // Desenhar o mapa melhorado
        function drawMap(worldMap, player) {
            const offsetX = player.x - MAP_WIDTH / 2;
            const offsetY = player.y - MAP_HEIGHT / 2;
            
            for (let y = 0; y < MAP_HEIGHT; y++) {
                for (let x = 0; x < MAP_WIDTH; x++) {
                    const mapX = Math.floor(offsetX + x);
                    const mapY = Math.floor(offsetY + y);
                    
                    let tileType = 0; // Grama por padrão
                    let color = COLORS.GRASS;
                    
                    if (mapX >= 0 && mapX < WORLD_SIZE && mapY >= 0 && mapY < WORLD_SIZE) {
                        tileType = worldMap[mapY][mapX];
                    }
                    
                    // Determinar a cor baseada no tipo de tile
                    switch (tileType) {
                        case 0: // Grama
                            color = COLORS.GRASS;
                            break;
                        case 1: // Água
                            color = COLORS.WATER;
                            break;
                        case 2: // Floresta
                            color = COLORS.FOREST;
                            break;
                        case 3: // Montanha
                            color = COLORS.MOUNTAIN;
                            break;
                        case 4: // Caminho
                            color = COLORS.PATH;
                            break;
                        case 5: // Flor
                            color = COLORS.GRASS; // Base é grama
                            break;
                        case 6: // Areia
                            color = COLORS.SAND;
                            break;
                    }
                    
                    // Desenhar o tile
                    ctx.fillStyle = color;
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    
                    // Adicionar detalhes aos tiles
                    if (tileType === 0) { // Grama
                        // Mais detalhes na grama
                        ctx.fillStyle = COLORS.GRASS_DARK;
                        for (let i = 0; i < 8; i++) {
                            const detailX = x * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                            const detailY = y * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                            ctx.fillRect(detailX, detailY, 2, 2);
                        }
                    } else if (tileType === 1) { // Água
                        // Ondas mais realistas
                        ctx.fillStyle = COLORS.WATER_DARK;
                        for (let i = 0; i < 6; i++) {
                            const waveX = x * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                            const waveY = y * TILE_SIZE + 10 + Math.random() * (TILE_SIZE - 20);
                            ctx.beginPath();
                            ctx.ellipse(waveX, waveY, 12, 6, Math.random() * Math.PI, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    } else if (tileType === 2) { // Floresta
                        // Árvores mais detalhadas
                        const treeX = x * TILE_SIZE + TILE_SIZE / 2;
                        const treeY = y * TILE_SIZE + TILE_SIZE / 2;
                        
                        // Tronco
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(treeX - 4, treeY, 8, TILE_SIZE / 2);
                        
                        // Copa da árvore com múltiplas camadas
                        ctx.fillStyle = COLORS.FOREST_DARK;
                        ctx.beginPath();
                        ctx.arc(treeX, treeY - 8, TILE_SIZE / 3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#229954';
                        ctx.beginPath();
                        ctx.arc(treeX - 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                        ctx.arc(treeX + 5, treeY - 10, TILE_SIZE / 4, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (tileType === 3) { // Montanha
                        // Montanhas mais realistas
                        ctx.fillStyle = COLORS.MOUNTAIN_DARK;
                        for (let i = 0; i < 8; i++) {
                            const rockX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                            const rockY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                            ctx.beginPath();
                            ctx.ellipse(rockX, rockY, 10, 6, Math.random() * Math.PI, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        
                        // Neve no topo (para montanhas altas)
                        if (Math.random() < 0.4) {
                            ctx.fillStyle = '#ecf0f1';
                            ctx.beginPath();
                            ctx.moveTo(x * TILE_SIZE + 10, y * TILE_SIZE + 15);
                            ctx.lineTo(x * TILE_SIZE + TILE_SIZE - 10, y * TILE_SIZE + 15);
                            ctx.lineTo(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + 5);
                            ctx.closePath();
                            ctx.fill();
                        }
                    } else if (tileType === 4) { // Caminho
                        // Detalhes do caminho
                        ctx.fillStyle = COLORS.PATH_DARK;
                        for (let i = 0; i < 6; i++) {
                            const stoneX = x * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                            const stoneY = y * TILE_SIZE + 5 + Math.random() * (TILE_SIZE - 10);
                            ctx.beginPath();
                            ctx.ellipse(stoneX, stoneY, 8, 5, 0, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    } else if (tileType === 5) { // Flor
                        // Desenhar flor
                        const flowerX = x * TILE_SIZE + TILE_SIZE / 2;
                        const flowerY = y * TILE_SIZE + TILE_SIZE / 2;
                        
                        // Caule
                        ctx.fillStyle = '#27ae60';
                        ctx.fillRect(flowerX - 1, flowerY, 2, TILE_SIZE / 3);
                        
                        // Pétalas
                        const flowerColor = [COLORS.FLOWER1, COLORS.FLOWER2, COLORS.FLOWER3][Math.floor(Math.random() * 3)];
                        ctx.fillStyle = flowerColor;
                        ctx.beginPath();
                        ctx.arc(flowerX, flowerY - 5, 6, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Centro da flor
                        ctx.fillStyle = '#f1c40f';
                        ctx.beginPath();
                        ctx.arc(flowerX, flowerY - 5, 3, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (tileType === 6) { // Areia
                        // Detalhes de areia
                        ctx.fillStyle = COLORS.SAND_DARK;
                        for (let i = 0; i < 10; i++) {
                            const sandX = x * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                            const sandY = y * TILE_SIZE + 3 + Math.random() * (TILE_SIZE - 6);
                            ctx.beginPath();
                            ctx.arc(sandX, sandY, 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }
            
            // Desenhar o mercador
            merchant.draw();
            
            // Desenhar indicador de interação com o mercador
            if (merchant.isPlayerNearby(player)) {
                ctx.fillStyle = '#f8c555';
                ctx.font = 'bold 14px MedievalSharp';
                ctx.textAlign = 'center';
                ctx.fillText('Pressione E para interagir', canvas.width / 2, canvas.height - 20);
            }
        }

        // Sistema de Batalha
        let currentMonster = null;
        let isPlayerTurn = true;
        let battleAnimation = null;
        let currentRound = 1;
        let battleEffects = [];
        
        function startBattle() {
            // Determinar tipo de monstro baseado nas probabilidades
            const rand = Math.random();
            let monsterType = 'weak';
            
            if (rand < 0.6) {
                monsterType = 'weak'; // 60% de chance
            } else if (rand < 0.9) {
                monsterType = 'strong'; // 30% de chance
            } else {
                monsterType = 'elite'; // 10% de chance
            }
            
            currentMonster = new Monster(monsterType);
            isPlayerTurn = true;
            battleAnimation = null;
            currentRound = 1;
            battleEffects = [];
            
            // Atualizar UI da batalha
            battleEnemyLevel.textContent = currentMonster.level;
            battleEnemyHealth.textContent = currentMonster.health;
            battleEnemyMaxHealth.textContent = currentMonster.maxHealth;
            battleEnemyAgility.textContent = currentMonster.agility;
            enemyName.textContent = currentMonster.name;
            
            roundIndicator.textContent = `Round ${currentRound}`;
            
            battleLog.innerHTML = '<div class="log-entry">Uma batalha começou!</div>';
            battleActions.style.display = 'flex';
            attackOptions.style.display = 'none';
            magicOptions.style.display = 'none';
            itemsOptions.style.display = 'none';
            actOptions.style.display = 'none';
            backBtn.style.display = 'none';
            
            // Mostrar tela de batalha
            battleScreen.style.display = 'flex';
            
            // Desenhar sprites iniciais
            const playerCanvas = document.getElementById('playerBattleCanvas');
            const playerCtx = playerCanvas.getContext('2d');
            player.drawBattle(playerCtx);
            
            const enemyCanvas = document.getElementById('enemyBattleCanvas');
            const enemyCtx = enemyCanvas.getContext('2d');
            currentMonster.drawBattle(enemyCtx);
        }
        
        function playerAttack(attackType) {
            if (!isPlayerTurn || battleAnimation) return;
            
            let damage = 0;
            let isCritical = false;
            let message = "";
            let attackResult = null;
            
            if (attackType === 'sword') {
                damage = player.swordAttack();
                isCritical = damage > (5 + Math.floor(player.strength * 0.5));
                
                message = "O cavaleiro usa sua espada para atacar seu oponente!";
                
                // Animação de ataque
                battleAnimation = {
                    type: 'playerAttack',
                    step: 0,
                    maxSteps: 20,
                    attackType: 'sword'
                };
                
                animateBattle();
            } else if (attackType === 'charge') {
                attackResult = player.chargeAttack();
                
                if (!attackResult.success) {
                    addBattleLog(attackResult.message);
                    showMainActions();
                    return;
                }
                
                damage = attackResult.damage;
                isCritical = attackResult.isCritical;
                
                message = "O cavaleiro avança rapidamente e investe contra o inimigo!";
                
                // Animação de investida
                battleAnimation = {
                    type: 'playerAttack',
                    step: 0,
                    maxSteps: 25,
                    attackType: 'charge'
                };
                
                animateBattle();
            }
            
            addBattleLog(message);
            
            // Esperar animação para aplicar dano
            setTimeout(() => {
                // Verificar se o monstro desviou
                if (Math.random() < currentMonster.dodgeChance) {
                    addBattleLog("Mas o inimigo desviou do ataque!");
                    createBattleEffect('miss', enemyCanvas, 100, 50);
                } else {
                    const actualDamage = currentMonster.takeDamage(damage);
                    
                    // Criar efeito visual de dano
                    createBattleEffect('damage', enemyCanvas, 100, 50, actualDamage);
                    
                    if (isCritical) {
                        addBattleLog(` CRÍTICO! Causou ${actualDamage} de dano ao inimigo!`);
                        createBattleEffect('critical', enemyCanvas, 100, 30);
                    } else {
                        addBattleLog(` Causou ${actualDamage} de dano ao inimigo!`);
                    }
                    
                    battleEnemyHealth.textContent = currentMonster.health;
                    
                    // Verificar se o monstro morreu
                    if (currentMonster.health <= 0) {
                        endBattle(true);
                        return;
                    }
                }
                
                // Atualizar status effects do monstro
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                player.updateUI();
                
                // Passar a vez para o monstro
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }, attackType === 'charge' ? 1000 : 800);
        }
        
        function playerHeavyArmor() {
            if (!isPlayerTurn || battleAnimation) return;
            
            const result = player.activateHeavyArmor();
            
            if (!result.success) {
                addBattleLog(result.message);
                showMainActions();
                return;
            }
            
            addBattleLog(result.message);
            
            // Criar efeito visual
            createBattleEffect('heavy-armor', playerCanvas, 100, 50);
            
            // Animação de ativação da armadura pesada
            battleAnimation = {
                type: 'playerEffect',
                step: 0,
                maxSteps: 15
            };
            
            animateBattle();
            
            // Esperar animação
            setTimeout(() => {
                player.updateUI();
                
                // Passar a vez para o monstro
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }, 700);
        }
        
        function playerMagic(spellType) {
            if (!isPlayerTurn || battleAnimation) return;
            
            let damage = 0;
            let message = "";
            let manaCost = 0;
            let statusEffect = null;
            let burnChance = 0;
            
            switch(spellType) {
                case 'fireball':
                    if (player.baseMag < 12) {
                        addBattleLog("Você precisa de pelo menos 12 pontos em Magia para usar Bola de Fogo!");
                        showMainActions();
                        return;
                    }
                    
                    manaCost = 30;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Bola de Fogo!");
                        showMainActions();
                        return;
                    }
                    
                    damage = 20 + Math.floor(player.magic * 0.8);
                    message = "O cavaleiro conjura uma Bola de Fogo!";
                    burnChance = 0.5; // 50% de chance de causar queimadura
                    break;
                    
                case 'freeze':
                    if (player.baseMag < 15) {
                        addBattleLog("Você precisa de pelo menos 15 pontos em Magia para usar Brisa Congelante!");
                        showMainActions();
                        return;
                    }
                    
                    manaCost = 40;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Brisa Congelante!");
                        showMainActions();
                        return;
                    }
                    
                    damage = 10 + Math.floor(player.magic * 0.5);
                    message = "O cavaleiro invoca uma Brisa Congelante!";
                    statusEffect = { type: 'slow', duration: 2 };
                    break;
                    
                case 'possession':
                    if (player.baseMag < 20) {
                        addBattleLog("Você precisa de pelo menos 20 pontos em Magia para usar Posseção!");
                        showMainActions();
                        return;
                    }
                    
                    manaCost = 65;
                    if (!player.useMana(manaCost)) {
                        addBattleLog("Mana insuficiente para lançar Posseção!");
                        showMainActions();
                        return;
                    }
                    
                    damage = 25 + Math.floor(player.magic * 1.2);
                    message = "O cavaleiro lança um feitiço de Posseção!";
                    statusEffect = { type: 'stun', duration: 3 };
                    break;
            }
            
            addBattleLog(message);
            
            // Animação de magia
            battleAnimation = {
                type: 'playerMagic',
                step: 0,
                maxSteps: 25,
                spell: spellType
            };
            
            animateBattle();
            
            // Esperar animação para aplicar efeitos
            setTimeout(() => {
                // Verificar se o monstro desviou
                if (Math.random() < currentMonster.dodgeChance) {
                    addBattleLog("Mas o inimigo desviou do feitiço!");
                    createBattleEffect('miss', enemyCanvas, 100, 50);
                } else {
                    const actualDamage = currentMonster.takeDamage(damage);
                    
                    // Criar efeito visual de dano
                    createBattleEffect('damage', enemyCanvas, 100, 50, actualDamage);
                    
                    addBattleLog(` O feitiço causou ${actualDamage} de dano!`);
                    
                    // Aplicar efeitos de status
                    if (spellType === 'fireball' && Math.random() < burnChance) {
                        currentMonster.addStatusEffect({ type: 'burn', duration: 3 });
                        addBattleLog(" O inimigo foi queimado!");
                        createBattleEffect('burn', enemyCanvas, 100, 30);
                    } else if (statusEffect) {
                        currentMonster.addStatusEffect(statusEffect);
                        addBattleLog(` O inimigo foi afetado por ${statusEffect.type.toUpperCase()}!`);
                        
                        // Criar efeito visual de status
                        createBattleEffect(statusEffect.type, enemyCanvas, 100, 30);
                    }
                    
                    battleEnemyHealth.textContent = currentMonster.health;
                    
                    // Verificar se o monstro morreu
                    if (currentMonster.health <= 0) {
                        endBattle(true);
                        return;
                    }
                }
                
                // Atualizar status effects do monstro
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                player.updateUI();
                
                // Passar a vez para o monstro
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }, 1000);
        }
        
        function playerUseItem(itemType) {
            if (!isPlayerTurn || battleAnimation) return;
            
            const result = player.useItem(itemType);
            
            if (result.success) {
                addBattleLog(result.message);
                
                // Criar efeito visual baseado no item
                if (itemType === 'mace' || itemType === 'ham') {
                    createBattleEffect('heal', playerCanvas, 100, 50);
                } else if (itemType === 'strengthPotion') {
                    createBattleEffect('strength-potion', playerCanvas, 100, 50);
                }
                
                player.updateUI();
                
                // Passar a vez para o monstro
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            } else {
                addBattleLog(result.message);
                showMainActions();
            }
        }
        
        function playerAct(actionType) {
            if (!isPlayerTurn || battleAnimation) return;
            
            let message = "";
            
            if (actionType === 'meditate') {
                message = player.meditate();
                addBattleLog(message);
                
                // Criar efeito visual de meditação
                createBattleEffect('meditate', playerCanvas, 100, 50);
                
                player.updateUI();
                
                // Passar a vez para o monstro
                isPlayerTurn = false;
                setTimeout(monsterTurn, 1000);
            }
        }
        
        function monsterTurn() {
            if (isPlayerTurn) return;
            
            // Recuperar stamina do jogador a cada round
            player.recoverStamina(10);
            player.updateUI();
            
            // Verificar se o monstro está atordoado
            if (currentMonster.hasStatusEffect('stun')) {
                addBattleLog(`O ${currentMonster.name} está atordoado e perdeu a vez!`);
                currentMonster.updateStatusEffects();
                currentMonster.updateBattleStatusEffects();
                
                // Passar a vez para o jogador
                isPlayerTurn = true;
                currentRound++;
                roundIndicator.textContent = `Round ${currentRound}`;
                showMainActions();
                return;
            }
            
            const damage = currentMonster.attackPlayer(player);
            addBattleLog(`O ${currentMonster.name} ataca o cavaleiro!`);
            
            // Animação de ataque do monstro
            battleAnimation = {
                type: 'monsterAttack',
                step: 0,
                maxSteps: 20
            };
            
            animateBattle();
            
            // Esperar animação para aplicar dano
            setTimeout(() => {
                // Verificar se o jogador desviou
                if (Math.random() < player.dodgeChance) {
                    addBattleLog("Mas o cavaleiro desviou do ataque!");
                    createBattleEffect('miss', playerCanvas, 100, 50);
                } else {
                    const actualDamage = player.takeDamage(damage);
                    
                    // Criar efeito visual de dano
                    createBattleEffect('damage', playerCanvas, 100, 50, actualDamage);
                    
                    addBattleLog(` Causou ${actualDamage} de dano ao cavaleiro!`);
                    
                    // Verificar se o dragão causou queimadura
                    if (currentMonster.type === 'elite' && player.hasStatusEffect('burn')) {
                        addBattleLog(" O cavaleiro está queimando!");
                        createBattleEffect('burn', playerCanvas, 100, 30);
                    }
                    
                    player.updateUI();
                    
                    // Verificar se o jogador morreu
                    if (player.health <= 0) {
                        endBattle(false);
                        return;
                    }
                }
                
                // Atualizar status effects do jogador
                player.updateStatusEffects();
                player.updateBattleStatusEffects();
                
                // Passar a vez para o jogador
                isPlayerTurn = true;
                currentRound++;
                roundIndicator.textContent = `Round ${currentRound}`;
                showMainActions();
            }, 800);
        }
        
        function animateBattle() {
            if (!battleAnimation) return;
            
            const playerCanvas = document.getElementById('playerBattleCanvas');
            const playerCtx = playerCanvas.getContext('2d');
            const enemyCanvas = document.getElementById('enemyBattleCanvas');
            const enemyCtx = enemyCanvas.getContext('2d');
            
            if (battleAnimation.type === 'playerAttack') {
                player.drawBattle(playerCtx, battleAnimation.step < battleAnimation.maxSteps / 2, battleAnimation.attackType);
                currentMonster.drawBattle(enemyCtx, false);
            } else if (battleAnimation.type === 'monsterAttack') {
                player.drawBattle(playerCtx, false);
                currentMonster.drawBattle(enemyCtx, battleAnimation.step < battleAnimation.maxSteps / 2);
            } else if (battleAnimation.type === 'playerMagic') {
                player.drawBattle(playerCtx, true);
                currentMonster.drawBattle(enemyCtx, false);
                
                // Efeito visual da magia
                enemyCtx.fillStyle = getSpellColor(battleAnimation.spell);
                enemyCtx.globalAlpha = 0.5 - (battleAnimation.step / battleAnimation.maxSteps) * 0.5;
                enemyCtx.fillRect(0, 0, 200, 200);
                enemyCtx.globalAlpha = 1.0;
            } else if (battleAnimation.type === 'playerEffect') {
                player.drawBattle(playerCtx, true);
                currentMonster.drawBattle(enemyCtx, false);
                
                // Efeito visual de ativação de habilidade
                playerCtx.fillStyle = 'rgba(149, 165, 166, 0.5)';
                playerCtx.globalAlpha = 0.5 - (battleAnimation.step / battleAnimation.maxSteps) * 0.5;
                playerCtx.fillRect(0, 0, 200, 200);
                playerCtx.globalAlpha = 1.0;
            }
            
            // Atualizar efeitos de batalha
            updateBattleEffects();
            
            battleAnimation.step++;
            
            if (battleAnimation.step < battleAnimation.maxSteps) {
                requestAnimationFrame(animateBattle);
            } else {
                battleAnimation = null;
                
                // Redesenhar personagens sem efeitos de ataque
                player.drawBattle(playerCtx, false);
                currentMonster.drawBattle(enemyCtx, false);
            }
        }
        
        function getSpellColor(spellType) {
            switch(spellType) {
                case 'fireball': return '#ff6b6b';
                case 'freeze': return '#74b9ff';
                case 'possession': return '#a29bfe';
                default: return '#ffffff';
            }
        }
        
        function createBattleEffect(type, canvas, x, y, value = null) {
            const effect = {
                type: type,
                x: x,
                y: y,
                value: value,
                step: 0,
                maxSteps: 60,
                canvas: canvas
            };
            
            battleEffects.push(effect);
        }
        
        function updateBattleEffects() {
            const playerCtx = playerCanvas.getContext('2d');
            const enemyCtx = enemyCanvas.getContext('2d');
            
            for (let i = battleEffects.length - 1; i >= 0; i--) {
                const effect = battleEffects[i];
                const ctx = effect.canvas === playerCanvas ? playerCtx : enemyCtx;
                
                effect.step++;
                
                if (effect.step >= effect.maxSteps) {
                    battleEffects.splice(i, 1);
                    continue;
                }
                
                const progress = effect.step / effect.maxSteps;
                const alpha = 1 - progress;
                const offsetY = progress * 30;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 16px MedievalSharp';
                ctx.textAlign = 'center';
                
                switch(effect.type) {
                    case 'damage':
                        ctx.fillStyle = '#e74c3c';
                        ctx.fillText(`-${effect.value}`, effect.x, effect.y - offsetY);
                        break;
                    case 'critical':
                        ctx.fillStyle = '#f39c12';
                        ctx.fillText('CRÍTICO!', effect.x, effect.y - offsetY);
                        break;
                    case 'miss':
                        ctx.fillStyle = '#95a5a6';
                        ctx.fillText('ESQUIVOU!', effect.x, effect.y - offsetY);
                        break;
                    case 'heal':
                        ctx.fillStyle = '#2ecc71';
                        ctx.fillText('+CURA', effect.x, effect.y - offsetY);
                        break;
                    case 'burn':
                        ctx.fillStyle = '#ff6b6b';
                        ctx.fillText('QUEIMANDO!', effect.x, effect.y - offsetY);
                        break;
                    case 'slow':
                        ctx.fillStyle = '#74b9ff';
                        ctx.fillText('LENTIDÃO!', effect.x, effect.y - offsetY);
                        break;
                    case 'stun':
                        ctx.fillStyle = '#a29bfe';
                        ctx.fillText('ATORDOADO!', effect.x, effect.y - offsetY);
                        break;
                    case 'strength-potion':
                        ctx.fillStyle = '#f39c12';
                        ctx.fillText('FORÇA+', effect.x, effect.y - offsetY);
                        break;
                    case 'heavy-armor':
                        ctx.fillStyle = '#bdc3c7';
                        ctx.fillText('DEFESA+', effect.x, effect.y - offsetY);
                        break;
                    case 'meditate':
                        ctx.fillStyle = '#3498db';
                        ctx.fillText('MEDITANDO', effect.x, effect.y - offsetY);
                        break;
                }
                
                ctx.restore();
            }
        }
        
        function addBattleLog(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            battleLog.appendChild(logEntry);
            battleLog.scrollTop = battleLog.scrollHeight;
        }
        
        function endBattle(playerWon) {
            if (playerWon) {
                const expGained = currentMonster.level * 10;
                const moneyGained = currentMonster.level * 5;
                
                player.addExp(expGained);
                player.money += moneyGained;
                
                // Dropar itens
                const droppedItems = currentMonster.dropItems(player);
                
                let dropMessage = "";
                if (droppedItems.length > 0) {
                    dropMessage = ` e encontrou: ${droppedItems.join(', ')}`;
                }
                
                addBattleLog(`Você venceu! Ganhou ${expGained} de EXP, ${moneyGained} de dinheiro${dropMessage}.`);
                
                setTimeout(() => {
                    battleScreen.style.display = 'none';
                    player.updateUI();
                }, 3000);
            } else {
                addBattleLog("Você foi derrotado!");
                
                setTimeout(() => {
                    battleScreen.style.display = 'none';
                    // Resetar saúde do jogador
                    player.health = player.maxHealth;
                    player.mana = player.maxMana;
                    player.stamina = player.maxStamina;
                    player.statusEffects = [];
                    player.updateUI();
                }, 3000);
            }
        }
        
        function showMainActions() {
            battleActions.style.display = 'flex';
            attackOptions.style.display = 'none';
            magicOptions.style.display = 'none';
            itemsOptions.style.display = 'none';
            actOptions.style.display = 'none';
            backBtn.style.display = 'none';
        }
        
        function showAttackOptions() {
            battleActions.style.display = 'none';
            attackOptions.style.display = 'flex';
            backBtn.style.display = 'inline-block';
        }
        
        function showMagicOptions() {
            battleActions.style.display = 'none';
            magicOptions.style.display = 'flex';
            backBtn.style.display = 'inline-block';
        }
        
        function showItemsOptions() {
            battleActions.style.display = 'none';
            itemsOptions.style.display = 'flex';
            backBtn.style.display = 'inline-block';
        }
        
        function showActOptions() {
            battleActions.style.display = 'none';
            actOptions.style.display = 'flex';
            backBtn.style.display = 'inline-block';
        }

        // Sistema de Loja
        function openShop() {
            shopScreen.style.display = 'flex';
            loadShopItems('food');
        }
        
        function loadShopItems(category) {
            shopItems.innerHTML = '';
            
            if (category === 'food') {
                // Comidas
                const maceItem = document.createElement('div');
                maceItem.className = 'shop-item';
                maceItem.innerHTML = `
                    <div class="shop-item-icon">🍎</div>
                    <div class="shop-item-name">Maçã</div>
                    <div class="shop-item-price">15 💰</div>
                    <button class="shop-buy-btn" data-item="mace" data-price="15">Comprar</button>
                `;
                shopItems.appendChild(maceItem);
                
                const hamItem = document.createElement('div');
                hamItem.className = 'shop-item';
                hamItem.innerHTML = `
                    <div class="shop-item-icon">🍗</div>
                    <div class="shop-item-name">Pernil</div>
                    <div class="shop-item-price">35 💰</div>
                    <button class="shop-buy-btn" data-item="ham" data-price="35">Comprar</button>
                `;
                shopItems.appendChild(hamItem);
            } else if (category === 'weapons') {
                // Armamentos
                let stoneSwordItem, goldSwordItem;
                
                if (!player.purchasedItems.stoneSword) {
                    stoneSwordItem = document.createElement('div');
                    stoneSwordItem.className = 'shop-item';
                    stoneSwordItem.innerHTML = `
                        <div class="shop-item-icon">⚔️</div>
                        <div class="shop-item-name">Espada de Pedra</div>
                        <div class="shop-item-price">130 💰</div>
                        <button class="shop-buy-btn" data-item="stoneSword" data-price="130">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(stoneSwordItem);
                } else {
                    goldSwordItem = document.createElement('div');
                    goldSwordItem.className = 'shop-item';
                    goldSwordItem.innerHTML = `
                        <div class="shop-item-icon">⚔️</div>
                        <div class="shop-item-name">Espada de Ouro</div>
                        <div class="shop-item-price">250 💰</div>
                        <button class="shop-buy-btn" data-item="goldSword" data-price="250" ${player.purchasedItems.goldSword ? 'disabled' : ''}>
                            ${player.purchasedItems.goldSword ? 'Esgotado' : 'Comprar'}
                        </button>
                    `;
                    shopItems.appendChild(goldSwordItem);
                }
                
                let chainMailItem, goldArmorItem;
                
                if (!player.purchasedItems.chainMail) {
                    chainMailItem = document.createElement('div');
                    chainMailItem.className = 'shop-item';
                    chainMailItem.innerHTML = `
                        <div class="shop-item-icon">🛡️</div>
                        <div class="shop-item-name">Armadura de Malha</div>
                        <div class="shop-item-price">200 💰</div>
                        <button class="shop-buy-btn" data-item="chainMail" data-price="200">
                            Comprar
                        </button>
                    `;
                    shopItems.appendChild(chainMailItem);
                } else {
                    goldArmorItem = document.createElement('div');
                    goldArmorItem.className = 'shop-item';
                    goldArmorItem.innerHTML = `
                        <div class="shop-item-icon">🛡️</div>
                        <div class="shop-item-name">Armadura de Ouro</div>
                        <div class="shop-item-price">350 💰</div>
                        <button class="shop-buy-btn" data-item="goldArmor" data-price="350" ${player.purchasedItems.goldArmor ? 'disabled' : ''}>
                            ${player.purchasedItems.goldArmor ? 'Esgotado' : 'Comprar'}
                        </button>
                    `;
                    shopItems.appendChild(goldArmorItem);
                }
            } else if (category === 'potions') {
                // Poções
                const strengthPotionItem = document.createElement('div');
                strengthPotionItem.className = 'shop-item';
                strengthPotionItem.innerHTML = `
                    <div class="shop-item-icon">🧪</div>
                    <div class="shop-item-name">Poção de Força</div>
                    <div class="shop-item-price">55 💰</div>
                    <button class="shop-buy-btn" data-item="strengthPotion" data-price="55">Comprar</button>
                `;
                shopItems.appendChild(strengthPotionItem);
            }
            
            // Adicionar event listeners aos botões de compra
            document.querySelectorAll('.shop-buy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const item = btn.getAttribute('data-item');
                    const price = parseInt(btn.getAttribute('data-price'));
                    
                    if (player.buyItem(item, price)) {
                        alert('Compra realizada com sucesso!');
                        loadShopItems(category); // Recarregar itens para atualizar o estado
                    } else {
                        alert('Dinheiro insuficiente!');
                    }
                });
            });
        }

        // Inicialização do jogo
        const player = new Player();
        const merchant = new Merchant();
        const worldMap = generateWorldMap();
        let lastTime = 0;
        
        // Atualizar UI inicial
        player.updateUI();
        
        // Controles
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            if (battleScreen.style.display === 'flex') return;
            if (inventoryScreen.style.display === 'flex') return;
            if (equipmentScreen.style.display === 'flex') return;
            if (shopScreen.style.display === 'flex') return;
            
            keys[e.key.toLowerCase()] = true;
            
            // Interação com o mercador
            if (e.key.toLowerCase() === 'e' && merchant.isPlayerNearby(player)) {
                openShop();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        // Event listeners para batalha
        attackBtn.addEventListener('click', showAttackOptions);
        
        swordAttackBtn.addEventListener('click', () => {
            attackOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerAttack('sword');
        });
        
        chargeBtn.addEventListener('click', () => {
            attackOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerAttack('charge');
        });
        
        heavyArmorBtn.addEventListener('click', () => {
            attackOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerHeavyArmor();
        });
        
        magicBtn.addEventListener('click', showMagicOptions);
        
        fireballBtn.addEventListener('click', () => {
            magicOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerMagic('fireball');
        });
        
        freezeBtn.addEventListener('click', () => {
            magicOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerMagic('freeze');
        });
        
        possessionBtn.addEventListener('click', () => {
            magicOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerMagic('possession');
        });
        
        itemsBtn.addEventListener('click', showItemsOptions);
        
        actBtn.addEventListener('click', showActOptions);
        
        meditateBtn.addEventListener('click', () => {
            actOptions.style.display = 'none';
            backBtn.style.display = 'none';
            playerAct('meditate');
        });
        
        // Event listeners para botões de voltar
        backBtn.addEventListener('click', showMainActions);
        backFromAttackBtn.addEventListener('click', showMainActions);
        backFromMagicBtn.addEventListener('click', showMainActions);
        backFromItemsBtn.addEventListener('click', showMainActions);
        backFromActBtn.addEventListener('click', showMainActions);
        
        // Event listeners para inventário
        inventoryBtn.addEventListener('click', () => {
            inventoryScreen.style.display = 'flex';
        });
        
        closeInventoryBtn.addEventListener('click', () => {
            inventoryScreen.style.display = 'none';
        });
        
        // Event listeners para upgrades de status
        document.querySelectorAll('.upgrade-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const stat = btn.getAttribute('data-stat');
                player.upgradeStat(stat);
                player.updateUI();
            });
        });
        
        // Event listeners para crafting
        craftingResult.addEventListener('click', () => {
            const result = player.craftDragonSlayer();
            if (result.includes("criou a Dragon Slayer")) {
                // Mostrar mensagem estilosa
                const dragonSlayerMessage = document.createElement('div');
                dragonSlayerMessage.style.position = 'fixed';
                dragonSlayerMessage.style.top = '50%';
                dragonSlayerMessage.style.left = '50%';
                dragonSlayerMessage.style.transform = 'translate(-50%, -50%)';
                dragonSlayerMessage.style.background = 'rgba(0, 0, 0, 0.9)';
                dragonSlayerMessage.style.padding = '20px';
                dragonSlayerMessage.style.border = '4px solid #e74c3c';
                dragonSlayerMessage.style.borderRadius = '10px';
                dragonSlayerMessage.style.textAlign = 'center';
                dragonSlayerMessage.style.zIndex = '100';
                dragonSlayerMessage.style.color = '#f8c555';
                dragonSlayerMessage.style.fontSize = '1.5rem';
                dragonSlayerMessage.innerHTML = `
                    <h2>DRAGON SLAYER CRIADA!</h2>
                    <p>Sua espada agora emana poder dragônico!</p>
                    <p>Dano aumentado em 11x!</p>
                    <button id="closeDragonSlayerMsg" style="margin-top: 20px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">Fechar</button>
                `;
                document.body.appendChild(dragonSlayerMessage);
                
                document.getElementById('closeDragonSlayerMsg').addEventListener('click', () => {
                    document.body.removeChild(dragonSlayerMessage);
                });
            } else {
                alert(result);
            }
        });
        
        craftingSlots.forEach((slot, index) => {
            slot.addEventListener('click', () => {
                // Se o slot estiver vazio, perguntar qual item adicionar
                if (player.craftingSlots[index] === null) {
                    if (player.items.ham > 0 || player.items.dragonScales > 0) {
                        const itemChoice = prompt("Qual item deseja adicionar? (Digite 'ham' para Pernil ou 'dragonScales' para Escamas de Dragão):");
                        if (itemChoice === 'ham' && player.items.ham > 0) {
                            player.addToCraftingSlot(index, 'ham');
                        } else if (itemChoice === 'dragonScales' && player.items.dragonScales > 0) {
                            player.addToCraftingSlot(index, 'dragonScales');
                        } else {
                            alert("Item inválido ou quantidade insuficiente!");
                        }
                    } else {
                        alert("Você não tem itens para adicionar ao crafting!");
                    }
                } else {
                    // Se o slot estiver ocupado, limpar
                    player.clearCraftingSlot(index);
                }
            });
            
            slot.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                player.clearCraftingSlot(index);
            });
        });
        
        // Event listeners para equipamentos
        equipmentBtn.addEventListener('click', () => {
            equipmentScreen.style.display = 'flex';
        });
        
        closeEquipmentBtn.addEventListener('click', () => {
            equipmentScreen.style.display = 'none';
        });
        
        inventoryBtnEquipment.addEventListener('click', () => {
            equipmentCollection.style.display = equipmentCollection.style.display === 'none' ? 'block' : 'none';
        });
        
        // Event listeners para loja
        closeShopBtn.addEventListener('click', () => {
            shopScreen.style.display = 'none';
        });
        
        shopCategories.forEach(category => {
            category.addEventListener('click', () => {
                // Remover classe active de todas as categorias
                shopCategories.forEach(c => c.classList.remove('active'));
                // Adicionar classe active à categoria clicada
                category.classList.add('active');
                // Carregar itens da categoria
                loadShopItems(category.getAttribute('data-category'));
            });
        });
        
        // Loop do jogo
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // Atualizar jogador
            player.update(deltaTime);
            
            // Processar movimentos
            if (player.moveCooldown === 0) {
                let moveResult = false;
                
                if (keys['w'] || keys['arrowup']) {
                    moveResult = player.move(0, -1, worldMap);
                } else if (keys['s'] || keys['arrowdown']) {
                    moveResult = player.move(0, 1, worldMap);
                } else if (keys['a'] || keys['arrowleft']) {
                    moveResult = player.move(-1, 0, worldMap);
                } else if (keys['d'] || keys['arrowright']) {
                    moveResult = player.move(1, 0, worldMap);
                }
                
                if (moveResult === 'monster') {
                    startBattle();
                }
            }
            
            // Limpar o canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenhar o mapa
            drawMap(worldMap, player);
            
            // Desenhar o jogador
            player.draw();
            
            // Chamar o próximo frame
            requestAnimationFrame(gameLoop);
        }
        
        // Iniciar o jogo
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>